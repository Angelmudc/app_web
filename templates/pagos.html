{# templates/pagos.html #}
{% extends "base.html" %}

{% block title %}ðŸ’° Gestionar Pagos{% endblock %}

{% block content %}
<div class="page-pagos">
  <div class="container py-3">

    {# ---------- ENCABEZADO ---------- #}
    <section class="hero-section">
      <h1 class="h3 mb-1">ðŸ’° Gestionar Pagos</h1>
      <p class="text-muted mb-0">
        Busca la candidata y registra el pago correspondiente al porciento.
      </p>
    </section>

    {# ---------- FLASHES ---------- #}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mt-3">
          {% for category, msg in messages %}
            <div class="alert alert-{{ 'success' if category=='success' else 'danger' if category=='danger' else 'warning' }} alert-dismissible fade show">
              {{ msg }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {# ==================== BUSCAR ==================== #}
    <div class="card mt-3 sticky-bar">
      <div class="card-body">
        <form id="searchForm" method="GET" action="{{ url_for('pagos') }}" autocomplete="off">
          <label for="busqueda" class="form-label mb-1">Buscar candidata</label>

          <div class="input-group input-group-lg">
            <span class="input-group-text">
              <i class="fa-solid fa-magnifying-glass"></i>
            </span>

            <input
              id="busqueda"
              name="busqueda"
              class="form-control"
              placeholder="Nombre, cÃ©dula o cÃ³digo"
              value="{{ request.args.get('busqueda','') }}">

            {% if request.args.get('busqueda') %}
              <a href="{{ url_for('pagos') }}" class="btn btn-outline-secondary">
                <i class="fa-solid fa-eraser"></i>
              </a>
            {% endif %}

            <button type="submit" class="btn btn-primary">
              Buscar
            </button>
          </div>
        </form>
      </div>
    </div>

    {# ==================== RESULTADOS ==================== #}
    {% if resultados %}
      <div class="card mt-3">
        <div class="card-header d-flex justify-content-between">
          <strong>Resultados</strong>
          <span class="badge-soft">{{ resultados|length }}</span>
        </div>

        <div class="table-responsive">
          <table class="table table-hover table-nowrap mb-0" id="tabla-resultados">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>CÃ©dula</th>
                <th>TelÃ©fono</th>
                <th class="text-center">AcciÃ³n</th>
              </tr>
            </thead>
            <tbody>
              {% for r in resultados %}
              <tr>
                <td>{{ r.nombre }}</td>
                <td>{{ r.cedula }}</td>
                <td>{{ r.telefono }}</td>
                <td class="text-center">
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{{ url_for('pagos', candidata=r.fila) }}">
                    Ver detalles
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}

    {# ==================== DETALLE + PAGO ==================== #}
    {% if candidata %}
      <div class="card mt-3">
        <div class="card-header">
          Detalle de la candidata
        </div>

        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <ul class="list-group">
                <li class="list-group-item"><strong>Nombre:</strong> {{ candidata.nombre_completo }}</li>
                <li class="list-group-item"><strong>CÃ©dula:</strong> {{ candidata.cedula }}</li>
                <li class="list-group-item"><strong>TelÃ©fono:</strong> {{ candidata.numero_telefono or 'â€”' }}</li>
                <li class="list-group-item"><strong>CÃ³digo:</strong> {{ candidata.codigo or 'â€”' }}</li>
              </ul>
            </div>

            <div class="col-md-6">
              <ul class="list-group">
                <li class="list-group-item">
                  <strong>Pendiente (porciento):</strong>
                  {{ candidata.porciento }}
                </li>
                <li class="list-group-item">
                  <strong>CalificaciÃ³n:</strong>
                  {{ candidata.calificacion or 'â€”' }}
                </li>
              </ul>
            </div>
          </div>

          <hr class="my-4">

          <form method="POST" action="{{ url_for('pagos') }}" id="formPago" autocomplete="off">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="fila" value="{{ candidata.fila }}">

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Monto pagado</label>
                <div class="input-group">
                  <span class="input-group-text">RD$</span>
                  <input
                    type="text"
                    name="monto_pagado"
                    class="form-control track-change"
                    placeholder="Ej: 10,000 o 10000.50"
                    required>
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">CalificaciÃ³n</label>
                <select name="calificacion" class="form-select track-change" required>
                  <option value="">Seleccioneâ€¦</option>
                  <option value="Dio problemas para pagar el porciento">Dio problemas</option>
                  <option value="Pago incompleto">Pago incompleto</option>
                  <option value="Pago completo">Pago completo</option>
                </select>
              </div>
            </div>

            <div class="d-flex gap-2 mt-3">
              <button type="submit" class="btn btn-success" id="btnGuardarPago">
                Guardar pago
              </button>
              <a href="{{ url_for('pagos') }}" class="btn btn-outline-secondary">
                Nueva bÃºsqueda
              </a>
            </div>
          </form>
        </div>
      </div>
    {% endif %}

    <a href="{{ url_for('home') }}" class="btn btn-secondary mt-4">
      Volver al inicio
    </a>

  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', () => {

  // Ctrl / Cmd + K â†’ foco bÃºsqueda
  const input = document.getElementById('busqueda');
  document.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      input?.focus();
    }
  });

  // Bloquear doble submit
  const formPago = document.getElementById('formPago');
  const btn = document.getElementById('btnGuardarPago');
  formPago?.addEventListener('submit', () => {
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'Guardandoâ€¦';
    }
  });

});
</script>
{% endblock %}