{# templates/pagos.html #}
{% extends "base.html" %}

{% block title %}üí∞ Gestionar Pagos{% endblock %}

{% block content %}
<div class="container py-3">

  {# ---------- ENCABEZADO ---------- #}
  <section class="hero-section">
    <h1 class="h3 mb-1">üí∞ Gestionar Pagos</h1>
    <p class="text-muted mb-0">Busca la candidata y registra el pago correspondiente.</p>
  </section>

  {# ---------- FLASHES (fallback a toasts globales) ---------- #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mt-3">
        {% for category, msg in messages %}
          <div class="alert alert-{{ 'success' if category=='success' else 'danger' if category=='danger' else 'warning' }} alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {# ============================================================ #}
  {# ====================   BUSCAR (GET)   ====================== #}
  {# ============================================================ #}
  <div class="card mt-3 sticky-bar">
    <div class="card-body">
      <form id="searchForm" method="GET" action="{{ url_for('pagos') }}" autocomplete="off" class="row g-2 align-items-end">
        <div class="col-12">
          <label for="busqueda" class="form-label mb-1">T√©rmino de b√∫squeda</label>
          <div class="input-group input-group-lg">
            <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
            <input
              id="busqueda" name="busqueda"
              class="form-control"
              placeholder="Nombre, c√©dula (000-0000000-0) o c√≥digo"
              value="{{ request.args.get('busqueda','') }}"
              aria-label="Buscar candidata">
            {% if request.args.get('busqueda') %}
              <a href="{{ url_for('pagos') }}" class="btn btn-outline-secondary" title="Limpiar">
                <i class="fa-solid fa-eraser"></i>
              </a>
            {% endif %}
            <button type="submit" class="btn btn-primary" title="Buscar">
              <span class="d-none d-sm-inline">Buscar</span> <i class="fa-solid fa-arrow-right-long ms-1"></i>
            </button>
          </div>
          <div class="form-text d-flex flex-wrap gap-3 mt-2">
            <span><i class="fa-regular fa-keyboard me-1"></i><strong>Ctrl/‚åò+K</strong> enfoca la b√∫squeda</span>
            <span><i class="fa-regular fa-lightbulb me-1"></i>Pega un n√∫mero y presiona Enter</span>
          </div>
        </div>
      </form>
    </div>
  </div>

  {# ====================   RESULTADOS   ======================== #}
  {% if resultados %}
    <div class="card mt-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-semibold"><i class="fa-solid fa-list-ul me-2"></i>Resultados</span>
        <span class="badge-soft">{{ resultados|length }} coincidencia{{ resultados|length != 1 and 's' or '' }}</span>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover table-nowrap m-0 align-middle" id="tabla-resultados">
            <thead class="position-sticky top-0" style="z-index:1">
              <tr>
                <th>Nombre</th>
                <th>C√©dula</th>
                <th>Tel√©fono</th>
                <th style="width:140px" class="text-center">Acci√≥n</th>
              </tr>
            </thead>
            <tbody>
              {% for row in resultados %}
              <tr>
                <td class="fw-semibold"><i class="fa-solid fa-user me-1 text-muted"></i>{{ row.nombre }}</td>
                <td>
                  <span class="badge-soft me-2">{{ row.cedula }}</span>
                  <button class="btn btn-xxs btn-outline-secondary copy-btn"
                          type="button"
                          data-copy="{{ row.cedula }}"
                          title="Copiar c√©dula"
                          aria-label="Copiar c√©dula {{ row.cedula }}">
                    <i class="fa-regular fa-copy"></i>
                  </button>
                </td>
                <td>
                  {% if row.telefono %}
                    <a class="text-decoration-none" href="tel:{{ row.telefono }}" title="Llamar">
                      <i class="fa-solid fa-phone me-1"></i>{{ row.telefono }}
                    </a>
                    <button class="btn btn-xxs btn-outline-secondary copy-btn ms-1"
                            type="button"
                            data-copy="{{ row.telefono }}"
                            title="Copiar tel√©fono"
                            aria-label="Copiar tel√©fono {{ row.telefono }}">
                      <i class="fa-regular fa-copy"></i>
                    </button>
                  {% else %}‚Äì{% endif %}
                </td>
                <td class="text-center">
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{{ url_for('pagos', candidata=row.fila) }}"
                     title="Ver detalles de pago">
                    üìÑ Ver Detalles
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}

  {# ====================   DETALLE + PAGO  ===================== #}
  {% if candidata %}
    <div class="card mt-3">
      <div class="card-header">
        <i class="fa-solid fa-file-invoice-dollar me-2"></i>Detalles de la Candidata
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <ul class="list-group">
              <li class="list-group-item"><strong>Nombre:</strong> {{ candidata.nombre_completo }}</li>
              <li class="list-group-item"><strong>C√©dula:</strong> {{ candidata.cedula }}</li>
              <li class="list-group-item"><strong>Tel√©fono:</strong> {{ candidata.numero_telefono or 'No especificado' }}</li>
            </ul>
          </div>
          <div class="col-md-6">
            <ul class="list-group">
              <li class="list-group-item"><strong>Monto Total:</strong> {{ candidata.monto_total }}</li>
              <li class="list-group-item"><strong>Porcentaje:</strong> {{ candidata.porciento }}</li>
              <li class="list-group-item"><strong>Fecha de Pago:</strong> {{ candidata.fecha_de_pago }}</li>
              <li class="list-group-item"><strong>Calificaci√≥n:</strong> {{ candidata.calificacion }}</li>
            </ul>
          </div>
        </div>

        <hr class="my-4">

        <form method="POST" action="{{ url_for('pagos') }}" id="formPago" autocomplete="off" class="mt-2">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="fila" value="{{ candidata.fila }}">

          <div class="row g-3 mb-2">
            <div class="col-md-6">
              <label for="monto_pagado" class="form-label">Monto pagado</label>
              <div class="input-group">
                <span class="input-group-text">RD$</span>
                <input
                  type="number" step="0.01" min="0"
                  id="monto_pagado" name="monto_pagado"
                  class="form-control track-change"
                  placeholder="0.00" required>
              </div>
            </div>
            <div class="col-md-6">
              <label for="calificacion" class="form-label">Calificaci√≥n</label>
              <select id="calificacion" name="calificacion" class="form-select track-change" required>
                <option value="">Seleccione Calificaci√≥n</option>
                <option value="Dio problemas para pagar el porciento">Dio problemas para pagar el porciento</option>
                <option value="Pago incompleto">Pago incompleto</option>
                <option value="Pago completo">Pago completo</option>
              </select>
            </div>
          </div>

          <div class="d-flex gap-2 mt-2">
            <button type="submit" class="btn btn-success" id="btnGuardarPago">Guardar Pago</button>
            <a href="{{ url_for('pagos') }}" class="btn btn-outline-secondary">‚Ü∫ Nueva b√∫squeda</a>
          </div>

          <div class="text-center text-muted small mt-3">
            <i class="fa-regular fa-shield"></i> Datos sensibles protegidos. Evita pegarlos en chats externos.
          </div>
        </form>
      </div>
    </div>
  {% endif %}

  <a href="{{ url_for('home') }}" class="btn btn-secondary mt-3">üè† Volver al Inicio</a>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  // ===== Copiar al portapapeles con toast =====
  function copyToClipboard(text){
    if(!text) return;
    navigator.clipboard.writeText(text).then(()=>{
      const toast = document.createElement('div');
      toast.className = 'toast align-items-center text-bg-secondary border-0';
      toast.role = 'alert'; toast.ariaLive = 'polite'; toast.ariaAtomic = 'true';
      toast.style.position='fixed'; toast.style.bottom='18px'; toast.style.right='18px'; toast.style.zIndex=1080;
      toast.innerHTML = `<div class="d-flex"><div class="toast-body">Copiado: <strong>${text}</strong></div>
                         <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      document.body.appendChild(toast);
      new bootstrap.Toast(toast, { delay: 2200 }).show();
      setTimeout(()=>toast.remove(), 2600);
    });
  }

  document.addEventListener('DOMContentLoaded', function(){
    // Atajo Ctrl/‚åò+K
    const inputBuscar = document.getElementById('busqueda');
    document.addEventListener('keydown', (e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='k'){
        e.preventDefault();
        inputBuscar?.focus(); inputBuscar?.select();
      }
    });
    if (inputBuscar && !inputBuscar.value) { inputBuscar.focus(); }

    // Copiar acciones
    document.querySelectorAll('.copy-btn').forEach(btn=>{
      btn.addEventListener('click', function(){
        copyToClipboard(this.getAttribute('data-copy'));
      });
    });

    // DataTables (si est√° jQuery y plugin)
    const tbl = document.getElementById('tabla-resultados');
    if (tbl && window.$ && $.fn.DataTable){
      $('#tabla-resultados').DataTable({
        pageLength: 10,
        order: [],            // sin orden forzado
        autoWidth: false,
        deferRender: true,
        responsive: true,
        language: { url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json' }
      });
    }

    // Bloquear doble submit en b√∫sq. y pago + feedback
    const searchForm = document.getElementById('searchForm');
    searchForm?.addEventListener('submit', function(){
      const btn = this.querySelector('button[type="submit"]');
      btn.disabled = true; btn.innerText = 'Buscando‚Ä¶';
    });

    const formPago = document.getElementById('formPago');
    const btnGuardarPago = document.getElementById('btnGuardarPago');
    formPago?.addEventListener('submit', function(){
      if(btnGuardarPago){ btnGuardarPago.disabled = true; btnGuardarPago.textContent = 'Guardando‚Ä¶'; }

      // mini toast local (adem√°s de flashes del servidor)
      const ok = document.createElement('div');
      ok.className = 'toast align-items-center text-bg-success border-0';
      ok.role = 'status'; ok.ariaLive = 'polite'; ok.ariaAtomic = 'true';
      ok.style.position='fixed'; ok.style.bottom='18px'; ok.style.right='18px'; ok.style.zIndex=1080;
      ok.innerHTML = '<div class="d-flex"><div class="toast-body">Pago enviado üíæ</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>';
      document.body.appendChild(ok);
      new bootstrap.Toast(ok, { delay: 1600 }).show();
      setTimeout(()=>ok.remove(), 2000);
    });

    // Marcar cambios pendientes en formulario de pago
    const tracked = document.querySelectorAll('#formPago .track-change');
    tracked.forEach(el=>{
      const initial = el.value ?? '';
      el.dataset.initial = initial;
      const dirty = ()=>{
        const changed = String(el.value ?? '') !== String(el.dataset.initial);
        el.classList.toggle('is-dirty', changed);
      };
      el.addEventListener('input', dirty);
      el.addEventListener('change', dirty);
    });
  });
</script>

<style>
  /* Sticky robusto con altura de navbar de base.html */
  .sticky-bar{ position: sticky; top: calc(var(--navbar-h) + 6px); z-index: 10; }

  .table-nowrap td, .table-nowrap th { white-space: nowrap; }

  .btn-xxs{
    --bs-btn-padding-y:.15rem; --bs-btn-padding-x:.35rem; --bs-btn-font-size:.7rem;
    border-radius: 999px;
  }

  /* ‚ÄúCambios pendientes‚Äù (no error) */
  .is-dirty{
    border-color: color-mix(in srgb, var(--warning) 58%, var(--border)) !important;
    box-shadow: 0 0 0 6px color-mix(in srgb, var(--warning) 24%, transparent) !important;
  }
</style>
{% endblock %}
