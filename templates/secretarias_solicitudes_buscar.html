{% extends 'base.html' %}
{% block title %}Buscar solicitudes (Secretarias){% endblock %}
{% block content %}
<div class="container py-4" style="max-width: 1300px;">

  <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <h1 class="h5 mb-0">Buscar solicitudes</h1>
    <div class="text-muted small">Resultados: {{ total }}</div>
  </div>

  <form class="row g-2 mb-3" method="get" action="{{ url_for('secretarias_buscar_solicitudes') }}">
    <div class="col-12 col-md-3">
      <input class="form-control form-control-sm" type="text" name="q" placeholder="Código o Ciudad/Sector" value="{{ q or '' }}">
    </div>

    <div class="col-6 col-md-2">
      <select class="form-select form-select-sm" name="estado">
        <option value="">Estado (todos)</option>
        {% for e in estados_opts %}
        <option value="{{ e }}" {% if estado==e %}selected{% endif %}>{{ e|capitalize }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-6 col-md-2">
      <input class="form-control form-control-sm" type="text" name="modalidad" placeholder="Modalidad" value="{{ modalidad or '' }}">
    </div>

    <div class="col-6 col-md-2">
      <input class="form-control form-control-sm" type="date" name="desde" value="{{ desde or '' }}" placeholder="Desde">
    </div>
    <div class="col-6 col-md-2">
      <input class="form-control form-control-sm" type="date" name="hasta" value="{{ hasta or '' }}" placeholder="Hasta">
    </div>

    <div class="col-6 col-md-1">
      <select class="form-select form-select-sm" name="mascota">
        <option value="">Mascota</option>
        <option value="si" {% if mascota=='si' %}selected{% endif %}>Sí</option>
        <option value="no" {% if mascota=='no' %}selected{% endif %}>No</option>
      </select>
    </div>

    <div class="col-6 col-md-1">
      <select class="form-select form-select-sm" name="con_ninos">
        <option value="">Niños</option>
        <option value="si" {% if con_ninos=='si' %}selected{% endif %}>Sí</option>
        <option value="no" {% if con_ninos=='no' %}selected{% endif %}>No</option>
      </select>
    </div>

    <div class="col-12 col-md-12 d-flex gap-2">
      <button class="btn btn-sm btn-primary" type="submit">Buscar</button>
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('secretarias_buscar_solicitudes') }}">Limpiar</a>
    </div>
  </form>

  {% if items and items|length > 0 %}
    <div class="table-responsive">
      <table class="table table-hover align-middle table-sm" id="tabla-resultados">
        <thead class="table-light">
          <tr>
            <th style="width: 110px;">Código</th>
            <th>Ciudad / Sector</th>
            <th>Modalidad</th>
            <th>Estado</th>
            <th>Ciclo</th>
            <th>Fecha solicitud</th>
            <th style="width: 240px;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for s in items %}
          <tr id="row-{{ s.id }}">
            <td class="fw-semibold">{{ s.codigo_solicitud }}</td>
            <td>{{ s.ciudad_sector }}</td>
            <td>{{ s.modalidad }}</td>
            <td>
              {% set est = (s.estado or '').lower() %}
              {% if est == 'activa' %}
                <span class="badge bg-success">Activa</span>
              {% elif est == 'reemplazo' %}
                <span class="badge bg-info text-dark">Reemplazo</span>
              {% elif est == 'proceso' %}
                <span class="badge bg-secondary">Proceso</span>
              {% elif est == 'pagada' %}
                <span class="badge bg-primary">Pagada</span>
              {% elif est == 'cancelada' %}
                <span class="badge bg-danger">Cancelada</span>
              {% else %}
                <span class="badge bg-light text-dark">{{ s.estado }}</span>
              {% endif %}
            </td>
            <td>
              {% if s.copiada_ciclo %}
                <span class="badge bg-secondary">Copiada (ciclo)</span>
              {% else %}
                <span class="badge bg-success">Copiable</span>
              {% endif %}
            </td>
            <td>{{ s.fecha_solicitud }}</td>
            <td class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-secondary" type="button"
                      onclick="toggleTexto({{ s.id }})">
                Ver texto
              </button>
              <button class="btn btn-sm btn-outline-primary" type="button"
                      onclick="copiarTexto({{ s.id }}, this)">
                Copiar
              </button>
            </td>
          </tr>
          <tr>
            <td colspan="7">
              <pre id="t{{ s.id }}" hidden
                   class="p-3 rounded-3 border bg-light"
                   style="white-space: pre-wrap; user-select: text; font-size: .925rem;">{{ s.order_text }}</pre>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if pages > 1 %}
    <nav aria-label="Paginación">
      <ul class="pagination pagination-sm mt-3">
        <li class="page-item {% if not prev_url %}disabled{% endif %}">
          <a class="page-link" href="{{ prev_url or '#' }}">«</a>
        </li>

        {% for p in page_links %}
        <li class="page-item {% if p.active %}active{% endif %}">
          <a class="page-link" href="{{ p.url }}">{{ p.n }}</a>
        </li>
        {% endfor %}

        <li class="page-item {% if not next_url %}disabled{% endif %}">
          <a class="page-link" href="{{ next_url or '#' }}">»</a>
        </li>
      </ul>
    </nav>
    {% endif %}
  {% else %}
    <div class="alert alert-info">Sin resultados.</div>
  {% endif %}
</div>

<script>
  function toggleTexto(id) {
    const el = document.getElementById('t' + id);
    if (el) el.hidden = !el.hidden;
  }

  function fallbackCopy(text) {
    try {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.setAttribute('readonly', '');
      ta.style.position = 'absolute';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.select();
      const ok = document.execCommand('copy');
      document.body.removeChild(ta);
      return ok;
    } catch (e) {
      return false;
    }
  }

  async function copiarTexto(id, btn) {
    const pre = document.getElementById('t' + id);
    if (!pre) return;
    const texto = pre.innerText.trim();
    if (!texto) return;

    const original = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Copiando...';

    try {
      let copied = false;
      if (navigator.clipboard && window.isSecureContext) {
        try {
          await navigator.clipboard.writeText(texto);
          copied = true;
        } catch (e) {
          copied = false;
        }
      }
      if (!copied) {
        copied = fallbackCopy(texto);
      }
      if (!copied) throw new Error('copy_failed');

      btn.textContent = 'Copiado ✓';
    } catch (e) {
      console.error(e);
      btn.textContent = 'Error';
      alert('No se pudo copiar. Reintenta.');
      setTimeout(() => { btn.textContent = original; btn.disabled = false; }, 1200);
      return;
    }

    setTimeout(() => { btn.textContent = original; btn.disabled = false; }, 900);
  }
</script>
{% endblock %}
