{# templates/buscar.html #}
{% extends "base.html" %}

{% block title %}üîç Buscar y ‚úèÔ∏è Editar Candidata{% endblock %}

{% block content %}
<div class="container py-3">

  {# ---------- ENCABEZADO ---------- #}
  {% if not candidata %}
    <section class="hero-section">
      <h1 class="h3 mb-1">üîç Buscar Candidata</h1>
      <p class="text-muted mb-0">Escribe nombre, c√©dula o tel√©fono y abre el perfil con ‚úèÔ∏è.</p>
    </section>
  {% else %}
    <section class="hero-section">
      <h1 class="h3 mb-1">‚úèÔ∏è Editar Candidata</h1>
      <p class="text-muted mb-0">Guarda con <strong>üíæ</strong> o vuelve con <strong>‚Ü∫</strong>. Los cambios no guardados se resaltan.</p>
    </section>
  {% endif %}

  {# ---------- FLASHES (fallback; ya hay toasts globales) ---------- #}
  {% with msgs = get_flashed_messages(with_categories=true) %}
    {% if msgs %}
      <div class="mt-3">
        {% for cat, m in msgs %}
          <div class="alert alert-{{ cat }} alert-dismissible fade show" role="alert">
            {{ m }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {# ============================================================ #}
  {# ====================   BUSCAR  (GET)   ===================== #}
  {# ============================================================ #}
  {% if not candidata %}

  {# Barra de b√∫squeda sticky (sin CSRF en GET) #}
  <div class="card mt-3 sticky-bar">
    <div class="card-body">
      <form method="GET" class="row g-2 align-items-end" id="formBuscar" autocomplete="off">
        <div class="col-12">
          <label for="busqueda" class="form-label mb-1">T√©rmino de b√∫squeda</label>
          <div class="input-group input-group-lg">
            <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
            <input id="busqueda" name="busqueda" class="form-control"
                   placeholder="Nombre, c√©dula (000-0000000-0) o tel√©fono"
                   value="{{ busqueda or '' }}" aria-label="Buscar candidata">
            {% if busqueda %}
              <a href="{{ url_for('buscar_candidata') }}" class="btn btn-outline-secondary" title="Limpiar">
                <i class="fa-solid fa-eraser"></i>
              </a>
            {% endif %}
            <button class="btn btn-primary" type="submit" title="Buscar">
              <span class="d-none d-sm-inline">Buscar</span> <i class="fa-solid fa-arrow-right-long ms-1"></i>
            </button>
          </div>
          <div class="form-text d-flex flex-wrap gap-3 mt-2">
            <span><i class="fa-regular fa-keyboard me-1"></i><strong>Ctrl/‚åò+K</strong> enfoca la b√∫squeda</span>
            <span><i class="fa-regular fa-lightbulb me-1"></i>Pega un n√∫mero y presiona Enter</span>
          </div>
        </div>
      </form>
    </div>
  </div>

  {% if mensaje %}
    <div class="alert alert-warning mt-3" role="status">
      {{ mensaje }}
    </div>
  {% endif %}

  {% if resultados %}
    <div class="card mt-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-semibold">
          <i class="fa-solid fa-list-ul me-2"></i>Resultados
        </span>
        <span class="badge-soft">{{ resultados|length }} coincidencia{{ resultados|length != 1 and 's' or '' }}</span>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover table-nowrap m-0 align-middle" id="tabla-busqueda">
            <thead class="position-sticky top-0" style="z-index:1">
              <tr>
                <th style="width:90px">ID</th>
                {# ‚úÖ NUEVA COLUMNA C√ìDIGO #}
                <th style="width:120px">C√≥digo</th>
                <th>Nombre</th>
                <th>C√©dula</th>
                <th>Tel√©fono</th>
                <th style="width:120px" class="text-center">Acci√≥n</th>
              </tr>
            </thead>
            <tbody>
              {% for c in resultados %}
              <tr class="row-click" data-edit-href="?candidata_id={{ c.fila }}" style="cursor: pointer;">
                <td class="text-muted">{{ c.fila }}</td>

                {# ‚úÖ C√ìDIGO (si tiene) #}
                <td>
                  {% if c.codigo %}
                    <span class="badge bg-dark">{{ c.codigo }}</span>
                  {% else %}
                    <span class="text-muted">Sin c√≥digo</span>
                  {% endif %}
                </td>

                <td class="fw-semibold">
                  <i class="fa-solid fa-user me-1 text-muted"></i>{{ c.nombre_completo }}
                </td>
                <td>
                  <span class="badge-soft me-2">{{ c.cedula }}</span>
                  <button class="btn btn-xxs btn-outline-secondary copy-btn" type="button"
                          data-copy="{{ c.cedula }}" title="Copiar c√©dula"
                          aria-label="Copiar c√©dula {{ c.cedula }}">
                    <i class="fa-regular fa-copy"></i>
                  </button>
                </td>
                <td>
                  {% if c.numero_telefono %}
                    <a class="text-decoration-none" href="tel:{{ c.numero_telefono }}" title="Llamar">
                      <i class="fa-solid fa-phone me-1"></i>{{ c.numero_telefono }}
                    </a>
                    <button class="btn btn-xxs btn-outline-secondary copy-btn ms-1" type="button"
                            data-copy="{{ c.numero_telefono }}" title="Copiar tel√©fono"
                            aria-label="Copiar tel√©fono {{ c.numero_telefono }}">
                      <i class="fa-regular fa-copy"></i>
                    </button>
                  {% else %}‚Äì{% endif %}
                </td>
                <td class="text-center">
                  <a href="?candidata_id={{ c.fila }}"
                     class="btn btn-sm btn-outline-secondary"
                     title="Editar candidata {{ c.nombre_completo }}"
                     onclick="event.stopPropagation()">
                    ‚úèÔ∏è Editar
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}

  {% else %}
  {# ============================================================ #}
  {# ====================   EDITAR (POST)  ====================== #}
  {# ============================================================ #}
  <form method="POST" class="mt-3" id="formEditar" autocomplete="off">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="busqueda" value="{{ busqueda or '' }}">
    <input type="hidden" name="candidata_id" value="{{ candidata.fila }}">
    <input type="hidden" name="guardar_edicion" value="1">

    {# --- TOOLBAR SUPERIOR --- #}
    <div class="d-flex align-items-center gap-2 flex-wrap mb-2">
      <a href="{{ url_for('buscar_candidata', busqueda=busqueda) }}" class="btn btn-outline-secondary">
        <i class="fa-solid fa-arrow-left-long me-1"></i> Volver
      </a>
      <button class="btn btn-success" id="btnGuardar">
        üíæ Guardar
      </button>
      <button class="btn btn-outline-secondary" type="button" id="btnScrollBottom">
        <i class="fa-solid fa-arrow-down-long me-1"></i> Ir al final
      </button>
      <span class="ms-auto small text-muted d-flex align-items-center gap-2">
        <i class="fa-regular fa-clock"></i> √öltima edici√≥n visual: <span id="lastSaved">‚Äî</span>
      </span>
    </div>

    {# --- IDENTIDAD --- #}
    <div class="card mb-3">
      <div class="card-header">
        <i class="fa-solid fa-id-card-clip me-2"></i>Identidad
      </div>
      <div class="card-body">

        {# ‚úÖ C√ìDIGO SOLO LECTURA #}
        <div class="mb-3">
          <label class="form-label" for="codigo">C√≥digo</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fa-solid fa-barcode"></i></span>
            <input id="codigo" class="form-control" value="{{ candidata.codigo or 'Sin c√≥digo' }}" readonly>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label" for="nombre">Nombre completo</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fa-solid fa-user"></i></span>
              <input id="nombre" name="nombre" class="form-control track-change" value="{{ candidata.nombre_completo }}">
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="cedula">C√©dula</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fa-regular fa-address-card"></i></span>
              <input id="cedula" name="cedula" class="form-control track-change" value="{{ candidata.cedula }}">
              <button class="btn btn-outline-secondary copy-btn" type="button"
                      data-copy="{{ candidata.cedula }}" title="Copiar c√©dula"
                      aria-label="Copiar c√©dula {{ candidata.cedula }}">
                <i class="fa-regular fa-copy"></i>
              </button>
            </div>
            <div class="form-text">Sugerido: 000-0000000-0</div>
          </div>
        </div>
      </div>
    </div>

    {# --- CONTACTO Y UBICACI√ìN --- #}
    <div class="card mb-3">
      <div class="card-header">
        <i class="fa-solid fa-phone me-2"></i>Contacto y Ubicaci√≥n
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label" for="edad">Edad</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fa-solid fa-hashtag"></i></span>
              <input id="edad" name="edad" type="number" inputmode="numeric"
                     class="form-control track-change" value="{{ candidata.edad or '' }}">
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label" for="telefono">Tel√©fono</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fa-solid fa-mobile-screen-button"></i></span>
              <input id="telefono" name="telefono" type="tel" inputmode="tel"
                     class="form-control track-change" value="{{ candidata.numero_telefono or '' }}">
              {% if candidata.numero_telefono %}
              <a class="btn btn-outline-secondary" href="tel:{{ candidata.numero_telefono }}" title="Llamar">
                <i class="fa-solid fa-phone"></i>
              </a>
              {% endif %}
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label" for="direccion">Direcci√≥n completa</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fa-solid fa-location-dot"></i></span>
              <input id="direccion" name="direccion" class="form-control track-change"
                     value="{{ candidata.direccion_completa or '' }}">
            </div>
          </div>
        </div>
      </div>
    </div>

    {# --- MODALIDAD / RUTAS / EMPLEO --- #}
    <div class="card mb-3">
      <div class="card-header">
        <i class="fa-solid fa-briefcase me-2"></i>Modalidad y Experiencia
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label" for="modalidad">Modalidad de trabajo</label>
            <input id="modalidad" name="modalidad" class="form-control track-change"
                   value="{{ candidata.modalidad_trabajo_preferida or '' }}" placeholder="Interna, Por d√≠as, Tiempo completo‚Ä¶">
          </div>
          <div class="col-md-4">
            <label class="form-label" for="rutas">Rutas cercanas</label>
            <input id="rutas" name="rutas" class="form-control track-change"
                   value="{{ candidata.rutas_cercanas or '' }}" placeholder="Ej: Ruta A, Av. Principal‚Ä¶">
          </div>
          <div class="col-md-4">
            <label class="form-label" for="empleo_anterior">Empleo anterior</label>
            <input id="empleo_anterior" name="empleo_anterior" class="form-control track-change"
                   value="{{ candidata.empleo_anterior or '' }}">
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-md-6">
            <label class="form-label" for="anos_experiencia">A√±os de experiencia</label>
            <input id="anos_experiencia" name="anos_experiencia" class="form-control track-change"
                   value="{{ candidata.anos_experiencia or '' }}" placeholder="Ej: 2 a√±os, 3+ a√±os">
          </div>
          <div class="col-md-6">
            <label class="form-label" for="areas_experiencia">√Åreas de experiencia</label>
            <input id="areas_experiencia" name="areas_experiencia" class="form-control track-change"
                   value="{{ candidata.areas_experiencia or '' }}" placeholder="Limpieza, Ni√±era, Cocina‚Ä¶">
          </div>
        </div>
      </div>
    </div>

    {# --- OPCIONES / CHECKS --- #}
    <div class="card mb-3">
      <div class="card-header">
        <i class="fa-solid fa-list-check me-2"></i>Preferencias
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="form-check">
              <input id="sabe_planchar" class="form-check-input track-change" type="checkbox" name="sabe_planchar" value="si"
                     {% if candidata.sabe_planchar %}checked{% endif %}>
              <label class="form-check-label" for="sabe_planchar">Sabe planchar</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check">
              <input id="acepta_porcentaje" class="form-check-input track-change" type="checkbox" name="acepta_porcentaje"
                     {% if candidata.acepta_porcentaje_sueldo == 1 %}checked{% endif %}>
              <label class="form-check-label" for="acepta_porcentaje">Acepta porcentaje</label>
            </div>
          </div>
        </div>
      </div>
    </div>

    {# --- REFERENCIAS --- #}
    <div class="card mb-3">
      <div class="card-header">
        <i class="fa-solid fa-people-group me-2"></i>Referencias
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label" for="contactos_referencias_laborales">2 contactos de referencias laborales</label>
          <textarea id="contactos_referencias_laborales" name="contactos_referencias_laborales"
                    class="form-control track-change" rows="2"
                    placeholder="Nombre - Tel√©fono - Relaci√≥n / Empresa">{{ candidata.contactos_referencias_laborales or '' }}</textarea>
          <div class="form-text">Ideal: nombre, tel√©fono y relaci√≥n laboral.</div>
        </div>
        <div class="mb-1">
          <label class="form-label" for="referencias_familiares_detalle">2 contactos de referencias familiares</label>
          <textarea id="referencias_familiares_detalle" name="referencias_familiares_detalle"
                    class="form-control track-change" rows="2"
                    placeholder="Nombre - Tel√©fono - Parentesco">{{ candidata.referencias_familiares_detalle or '' }}</textarea>
        </div>
      </div>
    </div>

    {# --- ACCIONES --- #}
    <div class="d-flex gap-2">
      <button class="btn btn-success" id="btnGuardar">
        üíæ Guardar
      </button>
      <a href="{{ url_for('buscar_candidata') }}" class="btn btn-outline-secondary">
        ‚Ü∫ Cancelar
      </a>
    </div>

    <div class="text-center text-muted small mt-3">
      <i class="fa-regular fa-shield"></i> Datos sensibles protegidos. Evita pegarlos en chats externos.
    </div>
  </form>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  // ===== util: copiar al portapapeles con toast accesible =====
  function copyToClipboard(text){
    if(!text) return;
    navigator.clipboard.writeText(text).then(()=>{
      const toast = document.createElement('div');
      toast.className = 'toast align-items-center text-bg-secondary border-0';
      toast.role = 'alert'; toast.ariaLive = 'polite'; toast.ariaAtomic = 'true';
      toast.style.position='fixed'; toast.style.bottom='18px'; toast.style.right='18px'; toast.style.zIndex=1080;
      toast.innerHTML = `<div class="d-flex"><div class="toast-body">Copiado: <strong>${text}</strong></div>
                         <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      document.body.appendChild(toast);
      new bootstrap.Toast(toast, { delay: 2200 }).show();
      setTimeout(()=>toast.remove(), 2600);
    });
  }

  document.addEventListener('DOMContentLoaded', function(){
    // DataTables si existe
    const tbl = document.getElementById('tabla-busqueda');
    if (tbl && window.$ && $.fn.DataTable){
      $('#tabla-busqueda').DataTable({
        pageLength: 10,
        order: [[0,'asc']],
        autoWidth: false,
        deferRender: true,
        responsive: true,
        language: { url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json' }
      });
    }

    // Fila clicable -> editar
    document.querySelectorAll('.row-click').forEach(tr=>{
      tr.addEventListener('click', function(){
        const href = this.getAttribute('data-edit-href');
        if(href) window.location = href;
      });
    });

    // Copiar cedula/tel√©fono
    document.querySelectorAll('.copy-btn').forEach(btn=>{
      btn.addEventListener('click', function(e){
        e.stopPropagation();
        copyToClipboard(this.getAttribute('data-copy'));
      });
    });

    // Atajo Ctrl/‚åò+K para enfocar b√∫squeda
    const inputBuscar = document.getElementById('busqueda');
    document.addEventListener('keydown', (e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='k'){
        e.preventDefault();
        if(inputBuscar){ inputBuscar.focus(); inputBuscar.select(); }
      }
    });
    if (inputBuscar) { inputBuscar.focus(); inputBuscar.select(); }

    // Scroll a pie de formulario
    const btnScrollBottom = document.getElementById('btnScrollBottom');
    if (btnScrollBottom){
      btnScrollBottom.addEventListener('click', ()=> window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }));
    }

    // Marcar cambios no guardados (borde/halo)
    const tracked = document.querySelectorAll('.track-change');
    let hasChanges = false;
    const lastSaved = document.getElementById('lastSaved');
    const stamp = () => {
      if(lastSaved){
        const d = new Date();
        lastSaved.textContent = `${d.toLocaleDateString()} ${d.toLocaleTimeString()}`;
      }
    };
    stamp();

    tracked.forEach(el=>{
      const initial = (el.type === 'checkbox') ? el.checked : (el.value ?? '');
      el.dataset.initial = initial;
      const dirty = () => {
        const now = (el.type === 'checkbox') ? el.checked : (el.value ?? '');
        const changed = String(now) !== String(el.dataset.initial);
        el.classList.toggle('is-dirty', changed); // estilo de "pendiente", NO error
        if(changed) hasChanges = true;
      };
      el.addEventListener('input', dirty);
      el.addEventListener('change', dirty);
    });

    // Aviso si hay cambios sin guardar al salir
    window.addEventListener('beforeunload', function(e){
      if(hasChanges){
        e.preventDefault();
        e.returnValue = '';
      }
    });

    // Al guardar, resetea estado visual + mini toast
    const formEditar = document.getElementById('formEditar');
    if (formEditar){
      formEditar.addEventListener('submit', ()=>{
        tracked.forEach(el=>{
          const now = (el.type === 'checkbox') ? el.checked : (el.value ?? '');
          el.dataset.initial = now;
          el.classList.remove('is-dirty');
        });
        hasChanges = false;
        stamp();

        const ok = document.createElement('div');
        ok.className = 'toast align-items-center text-bg-success border-0';
        ok.role = 'status'; ok.ariaLive = 'polite'; ok.ariaAtomic = 'true';
        ok.style.position='fixed'; ok.style.bottom='18px'; ok.style.right='18px'; ok.style.zIndex=1080;
        ok.innerHTML = '<div class="d-flex"><div class="toast-body">Cambios enviados üíæ</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>';
        document.body.appendChild(ok);
        new bootstrap.Toast(ok, { delay: 1800 }).show();
        setTimeout(()=>ok.remove(), 2200);
      });
    }

    // M√°scara ligera de c√©dula al perder foco (opcional)
    const ced = document.getElementById('cedula');
    ced?.addEventListener('blur', ()=>{
      let v = (ced.value||'').replace(/\D/g,'').slice(0,11);
      if(v.length===11) ced.value = `${v.slice(0,3)}-${v.slice(3,10)}-${v.slice(10)}`;
    });
  });
</script>

<style>
  /* Sticky robusto: respeta altura de navbar definida en base.html */
  .sticky-bar{ position: sticky; top: calc(var(--navbar-h) + 6px); z-index: 10; }

  /* Tabla: evita wraps feos, pero deja responsive por DataTables */
  .table-nowrap td, .table-nowrap th { white-space: nowrap; }

  /* Micro-bot√≥n consistente para acciones dentro de tablas */
  .btn-xxs{
    --bs-btn-padding-y:.15rem; --bs-btn-padding-x:.35rem; --bs-btn-font-size:.7rem;
    border-radius: 999px;
  }

  /* Estilo para ‚Äúcambios pendientes‚Äù (no error) */
  .is-dirty{
    border-color: color-mix(in srgb, var(--warning) 58%, var(--border)) !important;
    box-shadow: 0 0 0 6px color-mix(in srgb, var(--warning) 24%, transparent) !important;
  }

  /* Animaci√≥n suave en tarjetas si usas animate.css (opcional) */
  .animate__animated{animation-duration:.5s}

  .card-header{ font-weight: 700; }
</style>
{% endblock %}
