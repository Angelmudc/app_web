{# templates/referencias.html #}
{% extends 'base.html' %}
{% block title %}Referencias de Candidata{% endblock %}

{% block content %}
<div class="container py-4">

  {# ---------- ENCABEZADO ---------- #}
  <section class="hero-section">
    <h1 class="h3 mb-1">üë• Referencias de Candidata</h1>
    <p class="text-muted mb-0">
      Busca una candidata por <strong>nombre</strong> o <strong>c√©dula</strong>, luego agrega o actualiza sus referencias.
    </p>
  </section>

  {# ---------- MENSAJES (adem√°s de toasts globales) ---------- #}
  {% if mensaje %}
    <div class="alert alert-warning mt-3" role="alert">
      <i class="fa-solid fa-circle-exclamation me-1"></i>{{ mensaje }}
    </div>
  {% endif %}

  {# =================================================================== #}
  {# ============================  BUSCAR  ============================== #}
  {# =================================================================== #}
  {% if accion == 'buscar' %}
    <div class="card mt-3">
      <div class="card-body">
        <form method="POST" action="{{ url_for('referencias') }}" class="row g-2 align-items-end" novalidate>
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="col-12 col-md-9">
            <label for="busqueda" class="form-label mb-1">T√©rmino de b√∫squeda</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
              <input type="text" name="busqueda" id="busqueda" class="form-control"
                     placeholder="Escribe nombre completo o c√©dula (11 d√≠gitos)" required autocomplete="off">
              <button class="btn btn-primary" type="submit">
                <i class="fa-solid fa-search me-1"></i>Buscar
              </button>
            </div>
            <div class="form-text">Tip: pega la c√©dula sin guiones; igual la encontramos.</div>
          </div>
        </form>
      </div>
    </div>

    {% if resultados %}
      <div class="card mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-semibold"><i class="fa-solid fa-list-ul me-2"></i>Resultados</span>
          <span class="badge-soft">{{ resultados|length }} registro{{ resultados|length != 1 and 's' or '' }}</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle m-0" id="tabla-resultados">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>C√©dula</th>
                  <th>Tel√©fono</th>
                  <th class="text-center" style="width:120px">Acci√≥n</th>
                </tr>
              </thead>
              <tbody>
                {% for c in resultados %}
                <tr>
                  <td class="fw-semibold">{{ c.nombre }}</td>
                  <td><span class="badge-soft">{{ c.cedula }}</span></td>
                  <td>{{ c.telefono }}</td>
                  <td class="text-center">
                    <a href="{{ url_for('referencias', candidata=c.id) }}"
                       class="btn btn-sm btn-outline-primary"
                       title="Ver/editar referencias">
                      <i class="fa-solid fa-pen-to-square me-1"></i>Editar
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    {% endif %}
  {% endif %}

  {# =================================================================== #}
  {# ==============================  VER  =============================== #}
  {# =================================================================== #}
  {% if accion == 'ver' and candidata %}
    <!-- Ficha m√≠nima de candidata (no editable aqu√≠) -->
    <div class="card mt-3">
      <div class="card-body">
        <div class="d-flex flex-wrap align-items-center gap-3">
          <div class="rounded-circle skeleton" style="width:48px;height:48px;display:grid;place-items:center;">
            <i class="fa-solid fa-user text-muted"></i>
          </div>
          <div>
            <div class="fw-bold">{{ candidata.nombre_completo }}</div>
            <div class="small text-muted">
              <i class="fa-regular fa-id-card me-1"></i>{{ candidata.cedula }}
              <span class="mx-2">¬∑</span>
              <i class="fa-solid fa-phone me-1"></i>{{ candidata.numero_telefono or '‚Äî' }}
            </div>
          </div>
          <div class="ms-auto">
            <a href="{{ url_for('referencias') }}" class="btn btn-outline-secondary btn-sm">
              <i class="fa-solid fa-arrow-left-long me-1"></i>Nueva b√∫squeda
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Formulario de referencias -->
    <form method="POST" action="{{ url_for('referencias') }}" class="mt-3" id="formReferencias">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="candidata_id" value="{{ candidata.fila }}">

      <div class="card mb-3">
        <div class="card-header d-flex align-items-center gap-2">
          <i class="fa-solid fa-briefcase"></i>
          <strong>Referencias Laborales</strong>
        </div>
        <div class="card-body">
          <label class="form-label" for="ref_laborales">Agrega tel√©fonos y relaci√≥n (uno por p√°rrafo)</label>
          <textarea class="form-control" id="ref_laborales" name="referencias_laboral" rows="5"
                    placeholder="Ejemplo:
Nombre ‚Äî 809-000-0000 ‚Äî Ex-jefe en Limpieza
Nombre ‚Äî 829-000-0000 ‚Äî Supervisora en Cocina">{{ candidata.referencias_laboral }}</textarea>
          <div class="d-flex justify-content-between mt-1">
            <small class="text-muted">Sugerencia: verifica que los n√∫meros existan.</small>
            <small id="countLab" class="text-muted">0 caracteres</small>
          </div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header d-flex align-items-center gap-2">
          <i class="fa-solid fa-user-group"></i>
          <strong>Referencias Familiares</strong>
        </div>
        <div class="card-body">
          <label class="form-label" for="ref_familiares">Incluye parentesco (no vecinos ni amigos)</label>
          <textarea class="form-control" id="ref_familiares" name="referencias_familiares" rows="5"
                    placeholder="Ejemplo:
Nombre ‚Äî 849-000-0000 ‚Äî Hermana
Nombre ‚Äî 809-000-0000 ‚Äî T√≠a">{{ candidata.referencias_familiares }}</textarea>
          <div class="d-flex justify-content-between mt-1">
            <small class="text-muted">Ideal: nombre completo ‚Äî tel√©fono ‚Äî parentesco.</small>
            <small id="countFam" class="text-muted">0 caracteres</small>
          </div>
        </div>
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-success" id="btnGuardar" type="submit">
          <i class="fa-solid fa-floppy-disk me-1"></i>Guardar
        </button>
        <a href="{{ url_for('referencias') }}" class="btn btn-outline-secondary">
          <i class="fa-solid fa-rotate-left me-1"></i>Cancelar
        </a>
      </div>
    </form>
  {% endif %}

  <div class="text-center mt-4">
    <a href="{{ url_for('home') }}" class="btn btn-outline-primary">
      <i class="fa-solid fa-house me-1"></i>Inicio
    </a>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    // DataTables opcional para la tabla de resultados
    document.addEventListener('DOMContentLoaded', function(){
      const t = document.getElementById('tabla-resultados');
      if (t && window.$ && $.fn.DataTable){
        $('#tabla-resultados').DataTable({
          pageLength: 10,
          order: [[0,'asc']],
          autoWidth: false,
          language: { url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json' }
        });
      }
    });

    // Contadores de caracteres y anti doble submit en VER
    (function(){
      const form = document.getElementById('formReferencias');
      if(!form) return;

      const lab = document.getElementById('ref_laborales');
      const fam = document.getElementById('ref_familiares');
      const cl  = document.getElementById('countLab');
      const cf  = document.getElementById('countFam');
      const btn = document.getElementById('btnGuardar');

      const upd = () => {
        if(cl && lab) cl.textContent = (lab.value || '').length + ' caracteres';
        if(cf && fam) cf.textContent = (fam.value || '').length + ' caracteres';
      };
      lab && lab.addEventListener('input', upd);
      fam && fam.addEventListener('input', upd);
      upd();

      form.addEventListener('submit', function(){
        if(btn){
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Guardando‚Ä¶';
        }
      });
    })();
  </script>
{% endblock %}
