{% extends "base.html" %}
{% block title %}Buscar candidata para finalizar proceso{% endblock %}

{% block content %}
<div class="container my-4">

  <!-- Encabezado -->
  <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <div>
      <h1 class="h5 mb-1">Buscar candidata para finalizar proceso</h1>
      <div class="small text-muted">
        Escribe <strong>nombre</strong>, <strong>c√©dula</strong> o <strong>c√≥digo</strong>. M√°ximo 300 resultados.
      </div>
    </div>
    <div class="d-flex gap-2">
      <!-- Enlace de ayuda opcional -->
      <a href="{{ url_for('finalizar_proceso_buscar') }}" class="btn btn-outline-secondary btn-sm">
        Reiniciar b√∫squeda
      </a>
    </div>
  </div>

  <!-- Formulario de b√∫squeda -->
  <form class="row g-2 mb-3" method="get" action="{{ url_for('finalizar_proceso_buscar') }}" id="frm-buscar">
    <div class="col-sm-8 col-md-6">
      <input
        type="text"
        class="form-control"
        name="q"
        placeholder="Ej.: Mar√≠a / 00112345678 / A-102"
        value="{{ q or '' }}"
        autocomplete="off"
        autofocus
      >
    </div>
    <div class="col-sm-4 col-md-3">
      <button class="btn btn-primary w-100" type="submit">Buscar</button>
    </div>
    {% if q %}
    <div class="col-md-3">
      <a class="btn btn-outline-secondary w-100" href="{{ url_for('finalizar_proceso_buscar') }}">Limpiar</a>
    </div>
    {% endif %}
  </form>

  <!-- Resultados -->
  {% if q is defined and q|length > 0 %}
    <div class="card shadow-sm">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <div>
          Resultados para: <strong>{{ q }}</strong>
          <span class="badge bg-secondary ms-2">{{ resultados|length }}</span>
        </div>
        <div class="small text-muted">
          Usa <kbd>CTRL</kbd>/<kbd>CMD</kbd> + <kbd>C</kbd> en los botones copiar.
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width: 84px;">Fila</th>
              <th>Nombre</th>
              <th style="width: 150px;">C√©dula</th>
              <th style="width: 120px;">C√≥digo</th>
              <th style="width: 160px;">Estado</th>
              <th style="width: 260px;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% if resultados and resultados|length %}
              {% for c in resultados %}
              <tr>
                <td class="text-muted">
                  #{{ c.fila }}
                  <button
                    type="button"
                    class="btn btn-link btn-sm p-0 ms-1"
                    data-copy="{{ c.fila }}"
                    title="Copiar fila"
                    aria-label="Copiar fila"
                  >üìã</button>
                </td>
                <td class="fw-semibold">
                  {{ c.nombre_completo }}
                </td>
                <td>
                  <span>{{ c.cedula or '‚Äî' }}</span>
                  {% if c.cedula %}
                  <button
                    type="button"
                    class="btn btn-link btn-sm p-0 ms-1"
                    data-copy="{{ c.cedula }}"
                    title="Copiar c√©dula"
                    aria-label="Copiar c√©dula"
                  >üìã</button>
                  {% endif %}
                </td>
                <td>
                  <span>{{ c.codigo or '‚Äî' }}</span>
                  {% if c.codigo %}
                  <button
                    type="button"
                    class="btn btn-link btn-sm p-0 ms-1"
                    data-copy="{{ c.codigo }}"
                    title="Copiar c√≥digo"
                    aria-label="Copiar c√≥digo"
                  >üìã</button>
                  {% endif %}
                </td>
                <td>
                  {% if c.estado %}
                    <span class="badge bg-primary-subtle text-primary border">
                      {{ c.estado|replace('_',' ') }}
                    </span>
                  {% else %}
                    <span class="text-muted">‚Äî</span>
                  {% endif %}
                </td>
                <td class="d-flex flex-wrap gap-2">
                  <!-- Ver perfil (no cambia estado, s√≥lo vista) -->
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{{ url_for('candidata_ver_perfil', fila=c.fila) }}">Ver perfil</a>

                  <!-- Ir al formulario de finalizar (subir documentos / asignar grupos / mover estado) -->
                  <a class="btn btn-sm btn-success"
                     href="{{ url_for('finalizar_proceso', fila=c.fila) }}">Finalizar proceso</a>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="6" class="text-center text-muted py-4">
                  Sin resultados para ‚Äú{{ q }}‚Äù.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="card-footer small text-muted">
        Muestra hasta 300 filas como l√≠mite de seguridad.
      </div>
    </div>
  {% else %}
    <div class="alert alert-info">
      Escribe un t√©rmino y presiona <strong>Buscar</strong>.
    </div>
  {% endif %}
</div>

<!-- JS: copiar al portapapeles y micro-feedback -->
<script>
(function () {
  function copy(text) {
    if (!text) return;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(String(text)).catch(()=>{});
    } else {
      // Fallback
      const tmp = document.createElement('textarea');
      tmp.value = String(text);
      document.body.appendChild(tmp);
      tmp.select();
      try { document.execCommand('copy'); } catch(e) {}
      document.body.removeChild(tmp);
    }
  }

  document.addEventListener('click', function(e) {
    const btn = e.target.closest('[data-copy]');
    if (!btn) return;
    const val = btn.getAttribute('data-copy');
    copy(val);
    // Feedback r√°pido
    const old = btn.textContent;
    btn.textContent = '‚úî';
    setTimeout(() => { btn.textContent = old; }, 900);
  });

  // Enter env√≠a el formulario (mejor UX)
  const frm = document.getElementById('frm-buscar');
  if (frm) {
    frm.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        // permite Enter desde el input de texto
      }
    });
  }
})();
</script>
{% endblock %}
