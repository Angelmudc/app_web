{% extends "base.html" %}
{% block title %}Buscar candidata para finalizar proceso{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- ENCABEZADO -->
  <div class="d-flex align-items-center justify-content-between mb-4 flex-wrap gap-2">
    <div>
      <h1 class="h4 mb-1 d-flex align-items-center gap-2">
        <i class="fa-solid fa-user-check"></i> Buscar candidata para finalizar proceso
      </h1>
      <small class="text-muted">
        Escribe <strong>nombre</strong>, <strong>c√©dula</strong> o <strong>c√≥digo</strong>. M√°ximo 300 resultados.
      </small>
    </div>
    <a href="{{ url_for('finalizar_proceso_buscar') }}" class="btn btn-outline-secondary btn-sm">
      <i class="fa-solid fa-rotate-left me-1"></i> Reiniciar b√∫squeda
    </a>
  </div>

  <!-- FORMULARIO -->
  <form class="row g-2 mb-3" method="get" action="{{ url_for('finalizar_proceso_buscar') }}" id="frm-buscar">
    <div class="col-sm-8 col-md-6">
      <div class="input-group input-group-lg">
        <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
        <input type="text"
               class="form-control"
               name="q"
               placeholder="Ej.: Mar√≠a / 00112345678 / A-102"
               value="{{ q or '' }}"
               autocomplete="off"
               autofocus
               required>
      </div>
    </div>
    <div class="col-sm-4 col-md-3">
      <button class="btn btn-primary w-100" type="submit">
        <i class="fa-solid fa-search me-1"></i> Buscar
      </button>
    </div>
    {% if q %}
    <div class="col-md-3">
      <a class="btn btn-outline-secondary w-100" href="{{ url_for('finalizar_proceso_buscar') }}">
        <i class="fa-solid fa-eraser me-1"></i> Limpiar
      </a>
    </div>
    {% endif %}
  </form>

  <!-- RESULTADOS -->
  {% if q is defined and q|length > 0 %}
    <div class="card shadow-sm">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <div>
          Resultados para: <strong>{{ q }}</strong>
          <span class="badge bg-primary-subtle text-primary border ms-2">{{ resultados|length }}</span>
        </div>
        <small class="text-muted">Usa <kbd>CTRL</kbd> + <kbd>C</kbd> en los botones copiar.</small>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width: 84px;">Fila</th>
              <th>Nombre</th>
              <th style="width: 150px;">C√©dula</th>
              <th style="width: 120px;">C√≥digo</th>
              <th style="width: 160px;">Estado</th>
              <th style="width: 240px;" class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% if resultados and resultados|length %}
              {% for c in resultados %}
              <tr>
                <td class="text-muted">
                  #{{ c.fila }}
                  <button type="button" class="btn btn-link btn-sm p-0 ms-1 text-primary" data-copy="{{ c.fila }}" title="Copiar fila">üìã</button>
                </td>
                <td class="fw-semibold">{{ c.nombre_completo }}</td>
                <td>
                  {{ c.cedula or '‚Äî' }}
                  {% if c.cedula %}
                  <button type="button" class="btn btn-link btn-sm p-0 ms-1 text-primary" data-copy="{{ c.cedula }}" title="Copiar c√©dula">üìã</button>
                  {% endif %}
                </td>
                <td>
                  {{ c.codigo or '‚Äî' }}
                  {% if c.codigo %}
                  <button type="button" class="btn btn-link btn-sm p-0 ms-1 text-primary" data-copy="{{ c.codigo }}" title="Copiar c√≥digo">üìã</button>
                  {% endif %}
                </td>
                <td>
                  {% if c.estado %}
                    <span class="badge bg-primary-subtle text-primary border">{{ c.estado|replace('_',' ') }}</span>
                  {% else %}
                    <span class="text-muted">‚Äî</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  <div class="d-flex flex-wrap justify-content-center gap-2">
                    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('candidata_ver_perfil', fila=c.fila) }}">
                      <i class="fa-regular fa-eye me-1"></i> Ver perfil
                    </a>
                    <a class="btn btn-sm btn-success" href="{{ url_for('finalizar_proceso', fila=c.fila) }}">
                      <i class="fa-solid fa-check me-1"></i> Finalizar proceso
                    </a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="6" class="text-center text-muted py-4">
                  Sin resultados para ‚Äú{{ q }}‚Äù.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="card-footer small text-muted">
        Mostrando un m√°ximo de 300 resultados para proteger el rendimiento.
      </div>
    </div>
  {% else %}
    <div class="alert alert-info d-flex align-items-center gap-2">
      <i class="fa-solid fa-circle-info"></i>
      Escribe un t√©rmino y presiona <strong>Buscar</strong>.
    </div>
  {% endif %}
</div>

<!-- JS: copiar al portapapeles y micro-feedback -->
<script>
(function () {
  function copy(text) {
    if (!text) return;
    if (navigator.clipboard) {
      navigator.clipboard.writeText(String(text)).catch(()=>{});
    } else {
      const tmp = document.createElement('textarea');
      tmp.value = String(text);
      document.body.appendChild(tmp);
      tmp.select();
      try { document.execCommand('copy'); } catch(e) {}
      document.body.removeChild(tmp);
    }
  }

  document.addEventListener('click', function(e) {
    const btn = e.target.closest('[data-copy]');
    if (!btn) return;
    const val = btn.getAttribute('data-copy');
    copy(val);
    btn.textContent = '‚úî';
    setTimeout(() => { btn.textContent = 'üìã'; }, 1000);
  });
})();
</script>
{% endblock %}
