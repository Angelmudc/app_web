{% extends "base.html" %}

{% block title %}Iniciar sesi√≥n{% endblock %}

{% block head %}
<style>
  /* ======= Fondo ======= */
  .login-stage{
    position: relative;
    min-height: 62vh;
    display:grid;
    place-items:center;
    padding: 18px 0;
  }

  .blob{
    position:absolute;
    border-radius:50%;
    filter: blur(44px);
    opacity:.34;
    pointer-events:none;
    z-index:0;
  }
  .b1{width:420px;height:420px;left:-120px;top:-80px;background: var(--brand-2);}
  .b2{width:460px;height:460px;right:-140px;top:-60px;background: var(--brand);}
  .b3{width:520px;height:520px;left:50%;bottom:-220px;transform:translateX(-50%);background:#22d3ee;opacity:.16}

  /* ======= Card GLASS ======= */
  .glass{
    position: relative; /* ‚úÖ importante para ::before */
    width: min(980px, 100%);
    border-radius: 22px;
    border: 1px solid color-mix(in srgb, var(--border) 55%, transparent);
    background: color-mix(in srgb, var(--card) 55%, transparent);
    backdrop-filter: saturate(160%) blur(14px);
    box-shadow: 0 22px 60px rgba(15,23,42,.14);
    overflow: hidden;
    animation: glassIn .45s ease both;
    z-index:1;
  }
  @keyframes glassIn { from{opacity:0; transform: translateY(8px)} to{opacity:1; transform:none} }

  /* Borde con brillo animado */
  .glass::before{
    content:"";
    position:absolute;
    inset:-1px;
    border-radius: inherit;
    padding:1px;
    background: conic-gradient(from 0deg, #7aa2ff, #22d3ee, #34d399, #7aa2ff);
    -webkit-mask:
      linear-gradient(#000 0 0) content-box,
      linear-gradient(#000 0 0);
    -webkit-mask-composite: xor;
            mask-composite: exclude;
    animation: spinHue 6s linear infinite;
    opacity:.33;
    pointer-events:none;
  }
  @keyframes spinHue { to{ transform: rotate(360deg) } }

  .glass-row{display:grid; grid-template-columns: 1.1fr .9fr; gap: 0; }
  @media (max-width: 992px){ .glass-row{ grid-template-columns: 1fr; } }

  /* ======= Columna marca ======= */
  .brand-col{
    padding: 42px 26px;
    background: linear-gradient(180deg, color-mix(in srgb, var(--brand-2) 12%, transparent), transparent);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    text-align:center;
    border-right:1px solid var(--border);
  }
  @media (max-width: 992px){
    .brand-col{
      border-right:none;
      border-bottom:1px solid var(--border);
      padding: 34px 22px;
    }
  }

  .brand-logo{
    width: min(260px, 72%);
    height:auto;
    display:block;
    filter: drop-shadow(0 10px 24px rgba(15,23,42,.15));
    animation: floatY 5s ease-in-out infinite;
  }
  @keyframes floatY{
    0%,100%{ transform: translateY(0)}
    50%{ transform: translateY(-6px)}
  }

  .brand-title{
    font-family:'Rubik', system-ui;
    font-weight:900;
    letter-spacing:.2px;
    margin-top:18px;
    margin-bottom:0;
  }
  .brand-sub{color: var(--muted); margin-top:6px}

  /* ======= Columna formulario ======= */
  .form-col{ padding: 24px; }
  @media (max-width: 992px){
    .form-col{ padding: 22px; }
  }

  .form-head{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:6px;
  }
  .form-head .emoji{ font-size:1.35rem }
  .form-sub{ color: var(--muted); margin:0 0 6px 0 }

  .progress-thin{
    height:3px;
    width:100%;
    background: linear-gradient(90deg, var(--brand-2), var(--brand));
    opacity:0;
    transform: translateX(-100%);
  }
  .progress-thin.active{
    opacity:1;
    animation: indeterminate 1.1s infinite linear;
  }
  @keyframes indeterminate{
    0%{transform: translateX(-100%);}
    50%{transform: translateX(-20%);}
    100%{transform: translateX(100%);}
  }

  /* Mensaje (error/info) */
  .msg{
    margin-top: 10px;
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px solid rgba(239,68,68,.22);
    background: rgba(239,68,68,.10);
    color:#b91c1c;
    display:flex;
    gap:10px;
    align-items:flex-start;
  }
  html[data-theme="dark"] .msg{
    background: rgba(239,68,68,.12);
    border-color: rgba(239,68,68,.24);
    color:#fecaca;
  }
  .msg svg{ width:18px; height:18px; margin-top:2px; flex: 0 0 auto; }

  /* Inputs */
  .input-icon{
    position:absolute;
    left:12px;
    top:50%;
    transform: translateY(-50%);
    width:20px;
    height:20px;
    color:#7a8aa6;
    opacity:.95;
    pointer-events:none;
  }

  .form-control.auth{
    padding-left: 44px;
    border-radius: 14px;
    border:1.9px solid #e2e8f6;
    background: color-mix(in srgb, #ffffff 78%, transparent);
    transition: box-shadow .15s ease, border-color .15s ease, transform .12s ease;
  }
  html[data-theme="dark"] .form-control.auth{
    background: color-mix(in srgb, #0f1624 92%, transparent);
    border-color:#1e2636;
    color: var(--text);
  }
  .form-control.auth:focus{
    border-color:#9db7ff;
    box-shadow: 0 0 0 6px rgba(157,183,255,.25);
  }
  .is-invalid{
    border-color:#ef9aa0 !important;
    box-shadow: 0 0 0 6px rgba(217,83,79,.18) !important;
  }

  .toggle-btn{
    position:absolute;
    right:10px;
    top:50%;
    transform:translateY(-50%);
    border:1px solid #e2e8f6;
    background: color-mix(in srgb, var(--card) 70%, transparent);
    color: var(--muted);
    border-radius: 10px;
    padding:6px 9px;
    transition: transform .12s ease, filter .2s ease;
  }
  .toggle-btn:hover{ transform: translateY(-50%) scale(1.03); filter: brightness(1.05); }

  .caps-hint{
    color:#b45309;
    font-size:.9rem;
    display:none;
    margin-top:6px
  }

  /* Bot√≥n */
  .btn-auth{
    width:100%;
    border-radius:999px;
    font-weight:900;
    padding:.9rem 1rem;
    letter-spacing:.2px;
    border:none;
    color: #fff;
    background:
      radial-gradient(120% 120% at 10% -10%, rgba(255,255,255,.25), transparent 35%),
      linear-gradient(135deg, #3b82f6, var(--brand));
    box-shadow: 0 14px 30px rgba(59,130,246,.22);
    position:relative;
    overflow:hidden;
    transition: transform .12s ease, filter .2s ease, box-shadow .2s ease;
  }
  .btn-auth:hover{ transform: translateY(-1px); filter: brightness(1.02); }
  .btn-auth:focus{ box-shadow: 0 0 0 6px var(--ring) !important; }
  .btn-auth[disabled]{ opacity:.85; cursor:not-allowed; }

  .spin{
    width:16px;
    height:16px;
    border-radius:50%;
    border:2px solid rgba(255,255,255,.6);
    border-top-color:#fff;
    display:none;
    margin-right:8px;
    animation: spin .8s linear infinite;
    vertical-align: -2px;
  }
  @keyframes spin{ to{ transform: rotate(360deg); } }

  .btn-auth.success{
    background: linear-gradient(135deg, #16a34a, #22c55e);
    box-shadow: 0 14px 30px rgba(34,197,94,.28);
  }

  .shake{ animation: shake .42s cubic-bezier(.36,.07,.19,.97) both; }
  @keyframes shake{
    10%, 90% { transform: translateX(-1px); }
    20%, 80% { transform: translateX(2px); }
    30%, 50%, 70% { transform: translateX(-4px); }
    40%, 60% { transform: translateX(4px); }
  }
</style>
{% endblock %}

{% block content %}
<div class="login-stage container">
  <div class="blob b1"></div><div class="blob b2"></div><div class="blob b3"></div>

  <section class="glass" aria-label="Inicio de sesi√≥n">
    <div class="glass-row">
      <!-- Columna marca -->
      <aside class="brand-col">
        <img class="brand-logo" src="{{ url_for('static', filename='logo_nuevo.png') }}" alt="Dom√©stica del Cibao A&amp;D">
        <h3 class="brand-title h4">Dom√©stica del Cibao A&amp;D</h3>
        <p class="brand-sub">Plataforma de gesti√≥n y selecci√≥n</p>
      </aside>

      <!-- Columna formulario -->
      <div class="form-col">
        <div class="progress-thin" id="topProgress" aria-hidden="true"></div>

        <div class="form-head">
          <div class="emoji" aria-hidden="true">üîë</div>
          <div>
            <h1 class="h4 m-0 fw-bold">Iniciar sesi√≥n</h1>
            <p class="form-sub">Accede con tus credenciales</p>
          </div>
        </div>

        {% if mensaje %}
          <div class="msg" role="alert" aria-live="polite">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />
            </svg>
            <div>{{ mensaje }}</div>
          </div>
        {% endif %}

        <form method="POST" action="{{ url_for('login') }}" id="loginForm" autocomplete="on" novalidate>
          <!-- ‚úÖ CSRF -->
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <!-- Honeypot (anti bots) -->
          <input type="text" name="website" tabindex="-1" autocomplete="off" aria-hidden="true"
                 style="position:absolute; left:-9999px; width:1px; height:1px; opacity:0;">

          <!-- Usuario -->
          <div class="mb-3 position-relative">
            <label for="usuario" class="form-label fw-bold">Usuario</label>
            <svg class="input-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5Z"/>
            </svg>
            <input id="usuario" name="usuario" type="text"
                   class="form-control auth"
                   placeholder="tu.usuario"
                   required maxlength="64"
                   autocomplete="username"
                   autofocus>
          </div>

          <!-- Contrase√±a -->
          <div class="mb-2 position-relative">
            <label for="clave" class="form-label fw-bold">Contrase√±a</label>
            <svg class="input-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M17 10h-1V8a4 4 0 1 0-8 0v2H7a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-8a1 1 0 0 0-1-1Zm-7-2a2 2 0 1 1 4 0v2h-4Zm2 9a1.75 1.75 0 1 1 1.75-1.75A1.75 1.75 0 0 1 12 17Z"/>
            </svg>
            <input id="clave" name="clave" type="password"
                   class="form-control auth"
                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                   required maxlength="128"
                   autocomplete="current-password">
            <button class="toggle-btn btn btn-sm" type="button" id="togglePwd" aria-label="Mostrar u ocultar contrase√±a">
              <i class="fa-solid fa-eye-slash"></i>
            </button>
            <div class="caps-hint" id="capsHint">Bloq May√∫s activo.</div>
          </div>

          <button type="submit" class="btn btn-auth mt-3" id="submitBtn">
            <span class="spin" id="spinner"></span>
            <span id="btnText">Entrar</span>
          </button>
        </form>
      </div>
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const form = document.getElementById('loginForm');
  const card = document.querySelector('.glass');
  const bar  = document.getElementById('topProgress');
  const user = document.getElementById('usuario');
  const pass = document.getElementById('clave');
  const btn  = document.getElementById('submitBtn');
  const spin = document.getElementById('spinner');
  const btxt = document.getElementById('btnText');
  const tgl  = document.getElementById('togglePwd');
  const caps = document.getElementById('capsHint');

  // Focus inteligente
  window.addEventListener('load', () => {
    try { (user.value.trim() ? pass : user).focus(); } catch(e) {}
  });

  // Mostrar/ocultar pass
  if (tgl && pass) {
    tgl.addEventListener('click', () => {
      const isPwd = pass.type === 'password';
      pass.type = isPwd ? 'text' : 'password';
      tgl.innerHTML = isPwd ? '<i class="fa-solid fa-eye"></i>' : '<i class="fa-solid fa-eye-slash"></i>';
    });
  }

  // CapsLock hint
  const capsHandler = (e) => {
    if (!caps || !e.getModifierState) return;
    const on = e.getModifierState('CapsLock');
    caps.style.display = on ? 'block' : 'none';
  };
  if (pass) {
    pass.addEventListener('keydown', capsHandler);
    pass.addEventListener('keyup', capsHandler);
  }

  // Submit UI
  if (form) {
    form.addEventListener('submit', (e) => {
      if (user) user.value = (user.value || '').trim();

      const userOk = user && user.value.length >= 3;
      const passOk = pass && pass.value && pass.value.length > 0;

      if (!userOk || !passOk) {
        e.preventDefault();
        if (card) {
          card.classList.remove('shake');
          void card.offsetWidth;
          card.classList.add('shake');
        }
        if (user && !userOk) user.classList.add('is-invalid');
        if (pass && !passOk) pass.classList.add('is-invalid');
        return;
      }

      if (btn) btn.disabled = true;
      if (spin) spin.style.display = 'inline-block';
      if (btxt) btxt.textContent = 'Entrando‚Ä¶';
      if (bar) bar.classList.add('active');

      // UI feedback (no bloquea el submit real)
      setTimeout(() => {
        if (btn) btn.classList.add('success');
        if (spin) spin.style.display = 'none';
        if (btxt) btxt.textContent = '¬°Listo! ‚úÖ';
      }, 700);
    });
  }
})();
</script>
{% endblock %}