{# templates/subir_fotos.html #}
{% extends "base.html" %}

{% block title %}Subir Fotos - Doméstica del Cibao A&amp;D{% endblock %}

{% block hero %}
<div class="hero-section">
  <h1 class="h3 mb-1 d-flex align-items-center justify-content-center gap-2">
    <i class="fa-solid fa-cloud-arrow-up"></i> Subir Fotos de Candidatas
  </h1>
  <p class="text-muted mb-0">Busca la candidata y carga sus imágenes con vista previa y validaciones.</p>
</div>
{% endblock %}

{% block content %}
<div class="container pb-4">

  {# ========================= BUSCAR ========================= #}
  {% if accion == "buscar" %}
    <div class="card mt-3">
      <div class="card-body">
        <form method="post"
              action="{{ url_for('subir_fotos.subir_fotos') }}?accion=buscar"
              id="searchForm"
              class="row g-2 align-items-end"
              novalidate>
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <div class="col-12 col-lg-9">
            <label for="buscar" class="form-label mb-1">Buscar por nombre, cédula o teléfono</label>
            <div class="input-group input-group-lg">
              <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
              <input type="text"
                     class="form-control"
                     id="buscar"
                     name="busqueda"
                     placeholder="Ej: María / 00100200345 / 809-000-0000"
                     required
                     autocomplete="off">
              <button class="btn btn-primary" type="submit" id="searchButton">
                <i class="fa-solid fa-search me-1"></i>Buscar
              </button>
            </div>
            <div class="form-text">Tip: pega la cédula sin guiones; igual la encontramos.</div>
          </div>
        </form>
      </div>
    </div>

    {% if resultados %}
      <div class="card mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-semibold"><i class="fa-solid fa-list-ul me-2"></i>Resultados</span>
          <span class="badge-soft">{{ resultados|length }} candidata{{ resultados|length != 1 and 's' or '' }}</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle m-0" id="tabla-subir-fotos">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Cédula</th>
                  <th>Teléfono</th>
                  <th style="width: 160px;" class="text-center">Acción</th>
                </tr>
              </thead>
              <tbody>
                {% for cand in resultados %}
                <tr>
                  <td class="fw-semibold">{{ cand.nombre }}</td>
                  <td><span class="badge-soft">{{ cand.cedula }}</span></td>
                  <td>{{ cand.telefono or '—' }}</td>
                  <td class="text-center">
                    <a href="{{ url_for('subir_fotos.subir_fotos') }}?accion=subir&fila={{ cand.fila }}"
                       class="btn btn-sm btn-outline-primary">
                      <i class="fa-solid fa-cloud-arrow-up me-1"></i>Seleccionar
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    {% endif %}
  {% endif %}

  {# ========================== SUBIR ========================= #}
  {% if accion == "subir" %}
    <div class="d-flex align-items-center justify-content-between mt-2">
      <h2 class="h5 m-0 d-flex align-items-center gap-2">
        <i class="fa-solid fa-image"></i>
        Subir Imágenes para la Fila <span class="badge-soft">{{ fila }}</span>
      </h2>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('subir_fotos.subir_fotos') }}?accion=buscar">
        <i class="fa-solid fa-rotate-left me-1"></i>Volver a buscar
      </a>
    </div>

    <form method="post"
          action="{{ url_for('subir_fotos.subir_fotos') }}?accion=subir&fila={{ fila }}"
          enctype="multipart/form-data"
          id="uploadForm"
          class="mt-3">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <div class="alert alert-info py-2 px-3 mb-3 small">
        <i class="fa-solid fa-circle-info me-1"></i>
        Puedes subir <strong>una, varias o todas</strong> las imágenes. Si luego quieres actualizar solo una (ej. cédula), puedes hacerlo sin tocar las demás.
      </div>

      <div class="row g-3">
        {# ---- Depuración ---- #}
        <div class="col-12 col-lg-6">
          <div class="card h-100">
            <div class="card-header d-flex align-items-center gap-2">
              <i class="fa-solid fa-shield-halved"></i>
              <span>Imagen de Depuración</span>
              <span class="badge bg-light text-muted ms-auto small">Recomendada</span>
            </div>
            <div class="card-body">

              {% if tiene is defined and tiene['depuracion'] %}
                <div class="mb-3">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="text-muted small">Imagen guardada actualmente:</div>
                    <span class="badge bg-success-subtle text-success small">Guardada</span>
                  </div>
                  <div class="ratio ratio-4x3 rounded overflow-hidden bg-light">
                    <img src="{{ url_for('subir_fotos.ver_imagen', fila=fila, campo='depuracion') }}"
                         alt="Depuración guardada"
                         class="w-100 h-100 object-fit-cover">
                  </div>
                </div>
              {% endif %}

              <div class="upload-zone border rounded-2 p-3 text-center"
                   data-target="depuracion"
                   tabindex="0"
                   role="button"
                   aria-label="Subir imagen de depuración (arrastrar o hacer clic)">
                <div class="mb-2">
                  <i class="fa-solid fa-cloud-arrow-up fa-2x"></i>
                </div>
                <p class="mb-2">Arrastra y suelta aquí, o haz clic para seleccionar.</p>
                <p class="text-muted small">Formatos: JPG/PNG • Máx: 5 MB</p>
                <input class="form-control d-none"
                       type="file"
                       id="depuracion"
                       name="depuracion"
                       accept="image/*">
                <div class="ratio ratio-4x3 mt-3 rounded overflow-hidden bg-light skeleton d-none" id="preview-wrap-depuracion">
                  <img id="preview-depuracion" alt="Vista previa depuración" class="w-100 h-100 object-fit-cover">
                </div>
                <div class="d-flex justify-content-center gap-2 mt-2 d-none" id="controls-depuracion">
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-clear="depuracion">
                    <i class="fa-regular fa-trash-can me-1"></i>Quitar
                  </button>
                  <span class="badge bg-info-subtle text-info align-self-center d-none" id="keep-depuracion">
                    La guardada se mantiene
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        {# ---- Perfil ---- #}
        <div class="col-12 col-lg-6">
          <div class="card h-100">
            <div class="card-header d-flex align-items-center gap-2">
              <i class="fa-solid fa-id-card-clip"></i>
              <span>Imagen de Perfil</span>
              <span class="badge bg-light text-muted ms-auto small">Recomendada</span>
            </div>
            <div class="card-body">

              {% if tiene is defined and tiene['perfil'] %}
                <div class="mb-3">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="text-muted small">Imagen guardada actualmente:</div>
                    <span class="badge bg-success-subtle text-success small">Guardada</span>
                  </div>
                  <div class="ratio ratio-4x3 rounded overflow-hidden bg-light">
                    <img src="{{ url_for('subir_fotos.ver_imagen', fila=fila, campo='perfil') }}"
                         alt="Perfil guardado"
                         class="w-100 h-100 object-fit-cover">
                  </div>
                </div>
              {% endif %}

              <div class="upload-zone border rounded-2 p-3 text-center"
                   data-target="perfil"
                   tabindex="0"
                   role="button"
                   aria-label="Subir imagen de perfil (arrastrar o hacer clic)">
                <div class="mb-2">
                  <i class="fa-solid fa-cloud-arrow-up fa-2x"></i>
                </div>
                <p class="mb-2">Arrastra y suelta aquí, o haz clic para seleccionar.</p>
                <p class="text-muted small">Formatos: JPG/PNG • Máx: 5 MB</p>
                <input class="form-control d-none"
                       type="file"
                       id="perfil"
                       name="perfil"
                       accept="image/*">
                <div class="ratio ratio-4x3 mt-3 rounded overflow-hidden bg-light skeleton d-none" id="preview-wrap-perfil">
                  <img id="preview-perfil" alt="Vista previa perfil" class="w-100 h-100 object-fit-cover">
                </div>
                <div class="d-flex justify-content-center gap-2 mt-2 d-none" id="controls-perfil">
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-clear="perfil">
                    <i class="fa-regular fa-trash-can me-1"></i>Quitar
                  </button>
                  <span class="badge bg-info-subtle text-info align-self-center d-none" id="keep-perfil">
                    La guardada se mantiene
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        {# ---- Cédula frente ---- #}
        <div class="col-12 col-lg-6">
          <div class="card h-100">
            <div class="card-header d-flex align-items-center gap-2">
              <i class="fa-solid fa-id-card"></i>
              <span>Foto de cédula (frente)</span>
              <span class="badge bg-light text-muted ms-auto small">Opcional</span>
            </div>
            <div class="card-body">

              {% if tiene is defined and tiene['cedula1'] %}
                <div class="mb-3">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="text-muted small">Imagen guardada actualmente:</div>
                    <span class="badge bg-success-subtle text-success small">Guardada</span>
                  </div>
                  <div class="ratio ratio-4x3 rounded overflow-hidden bg-light">
                    <img src="{{ url_for('subir_fotos.ver_imagen', fila=fila, campo='cedula1') }}"
                         alt="Cédula frente guardada"
                         class="w-100 h-100 object-fit-cover">
                  </div>
                </div>
              {% endif %}

              <div class="upload-zone border rounded-2 p-3 text-center"
                   data-target="cedula1"
                   tabindex="0"
                   role="button"
                   aria-label="Subir foto de cédula frente (arrastrar o hacer clic)">
                <div class="mb-2">
                  <i class="fa-solid fa-cloud-arrow-up fa-2x"></i>
                </div>
                <p class="mb-2">Arrastra y suelta aquí, o haz clic para seleccionar.</p>
                <p class="text-muted small">Opcional • Formatos: JPG/PNG • Máx: 5 MB</p>
                <input class="form-control d-none"
                       type="file"
                       id="cedula1"
                       name="cedula1"
                       accept="image/*">
                <div class="ratio ratio-4x3 mt-3 rounded overflow-hidden bg-light skeleton d-none" id="preview-wrap-cedula1">
                  <img id="preview-cedula1" alt="Vista previa cédula frente" class="w-100 h-100 object-fit-cover">
                </div>
                <div class="d-flex justify-content-center gap-2 mt-2 d-none" id="controls-cedula1">
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-clear="cedula1">
                    <i class="fa-regular fa-trash-can me-1"></i>Quitar
                  </button>
                  <span class="badge bg-info-subtle text-info align-self-center d-none" id="keep-cedula1">
                    La guardada se mantiene
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        {# ---- Cédula reverso ---- #}
        <div class="col-12 col-lg-6">
          <div class="card h-100">
            <div class="card-header d-flex align-items-center gap-2">
              <i class="fa-solid fa-id-card"></i>
              <span>Foto de cédula (reverso)</span>
              <span class="badge bg-light text-muted ms-auto small">Opcional</span>
            </div>
            <div class="card-body">

              {% if tiene is defined and tiene['cedula2'] %}
                <div class="mb-3">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="text-muted small">Imagen guardada actualmente:</div>
                    <span class="badge bg-success-subtle text-success small">Guardada</span>
                  </div>
                  <div class="ratio ratio-4x3 rounded overflow-hidden bg-light">
                    <img src="{{ url_for('subir_fotos.ver_imagen', fila=fila, campo='cedula2') }}"
                         alt="Cédula reverso guardada"
                         class="w-100 h-100 object-fit-cover">
                  </div>
                </div>
              {% endif %}

              <div class="upload-zone border rounded-2 p-3 text-center"
                   data-target="cedula2"
                   tabindex="0"
                   role="button"
                   aria-label="Subir foto de cédula reverso (arrastrar o hacer clic)">
                <div class="mb-2">
                  <i class="fa-solid fa-cloud-arrow-up fa-2x"></i>
                </div>
                <p class="mb-2">Arrastra y suelta aquí, o haz clic para seleccionar.</p>
                <p class="text-muted small">Opcional • Formatos: JPG/PNG • Máx: 5 MB</p>
                <input class="form-control d-none"
                       type="file"
                       id="cedula2"
                       name="cedula2"
                       accept="image/*">
                <div class="ratio ratio-4x3 mt-3 rounded overflow-hidden bg-light skeleton d-none" id="preview-wrap-cedula2">
                  <img id="preview-cedula2" alt="Vista previa cédula reverso" class="w-100 h-100 object-fit-cover">
                </div>
                <div class="d-flex justify-content-center gap-2 mt-2 d-none" id="controls-cedula2">
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-clear="cedula2">
                    <i class="fa-regular fa-trash-can me-1"></i>Quitar
                  </button>
                  <span class="badge bg-info-subtle text-info align-self-center d-none" id="keep-cedula2">
                    La guardada se mantiene
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="d-flex justify-content-end gap-2 mt-3">
        <a class="btn btn-outline-secondary" href="{{ url_for('subir_fotos.subir_fotos') }}?accion=buscar">
          Cancelar
        </a>
        <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn">
          <i class="fa-solid fa-cloud-arrow-up me-1"></i> Subir Imágenes
        </button>
      </div>
    </form>
  {% endif %}

  <div class="text-center mt-4">
    <a href="{{ url_for('home') }}" class="btn btn-outline-primary">
      <i class="fa-solid fa-house me-1"></i>Inicio
    </a>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  // ===== Disable search button on submit =====
  (function(){
    const form = document.getElementById("searchForm");
    if (!form) return;
    form.addEventListener("submit", function(){
      const btn = document.getElementById("searchButton");
      if (!btn) return;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Buscando…';
    });
  })();

  // ===== DataTables for results =====
  document.addEventListener('DOMContentLoaded', function(){
    const t = document.getElementById('tabla-subir-fotos');
    if (t && window.$ && $.fn.DataTable){
      $('#tabla-subir-fotos').DataTable({
        pageLength: 10,
        order: [[0,'asc']],
        autoWidth: false,
        language: { url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json' }
      });
    }
  });

  // ===== Upload UX: click-to-open, drag&drop, preview, size/type checks =====
  (function(){
    const MAX_MB = 5;
    const MAX_BYTES = MAX_MB * 1024 * 1024;

    function $(id){ return document.getElementById(id); }

    function showPreview(kind, file){
      const wrap = $('preview-wrap-' + kind);
      const img  = $('preview-' + kind);
      const ctr  = $('controls-' + kind);
      const keep = $('keep-' + kind);
      if (!wrap || !img || !ctr) return;

      const url = URL.createObjectURL(file);
      img.onload = () => URL.revokeObjectURL(url);
      img.src = url;
      wrap.classList.remove('d-none');
      ctr.classList.remove('d-none');
      if (keep) keep.classList.add('d-none'); // si hay preview nuevo, no mostramos "se mantiene"
    }

    function clearField(kind){
      const input = $(kind);
      if (!input) return;
      input.value = "";
      const wrap = $('preview-wrap-' + kind);
      const ctr  = $('controls-' + kind);
      const keep = $('keep-' + kind);

      if (wrap) wrap.classList.add('d-none');
      if (ctr)  ctr.classList.remove('d-none'); // se queda visible con el badge
      if (keep) keep.classList.remove('d-none'); // si quitó el nuevo, la guardada sigue
    }

    function validImage(file){
      if (!file.type || !file.type.startsWith('image/')) return "El archivo debe ser una imagen.";
      if (file.size > MAX_BYTES) return `La imagen supera ${MAX_MB} MB. Por favor, selecciona otra.`;
      return null;
    }

    function setInputFiles(input, file){
      // Intento moderno: DataTransfer (funciona en la mayoría)
      try {
        const dt = new DataTransfer();
        dt.items.add(file);
        input.files = dt.files;
        return true;
      } catch (e) {
        return false;
      }
    }

    // Botones de limpiar
    document.querySelectorAll('[data-clear]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const kind = btn.getAttribute('data-clear');
        clearField(kind);
      });
    });

    // Zonas de carga
    document.querySelectorAll('.upload-zone').forEach(zone=>{
      const kind  = zone.getAttribute('data-target');
      const input = $(kind);
      if (!kind || !input) return;

      // Click para abrir selector
      zone.addEventListener('click', e=>{
        if (e.target.tagName !== 'BUTTON') input.click();
      });
      zone.addEventListener('keypress', e=>{
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          input.click();
        }
      });

      // Cambio por selector normal
      input.addEventListener('change', ()=>{
        const file = input.files && input.files[0];
        if (!file) return;

        const err = validImage(file);
        if (err){
          alert(err);
          input.value = "";
          return;
        }
        showPreview(kind, file);
      });

      // Drag & drop
      ['dragenter','dragover'].forEach(ev=>{
        zone.addEventListener(ev, e=>{
          e.preventDefault(); e.stopPropagation();
          zone.classList.add('border-primary');
        }, false);
      });
      ['dragleave','drop'].forEach(ev=>{
        zone.addEventListener(ev, e=>{
          e.preventDefault(); e.stopPropagation();
          zone.classList.remove('border-primary');
        }, false);
      });

      zone.addEventListener('drop', e=>{
        const dt = e.dataTransfer;
        if (!dt || !dt.files || !dt.files.length) return;

        const file = dt.files[0];
        const err = validImage(file);
        if (err){
          alert(err);
          return;
        }

        const ok = setInputFiles(input, file);
        if (!ok){
          // si el navegador no deja, no falles en silencio
          alert("Tu navegador bloqueó el drag & drop directo. Se abrirá el selector para que elijas la imagen.");
          input.click();
          return;
        }

        showPreview(kind, file);
      });
    });

    // Estado de cargando al enviar el formulario de subida
    const uploadForm = document.getElementById('uploadForm');
    if (uploadForm){
      uploadForm.addEventListener('submit', (e)=>{
        const dep   = $('depuracion');
        const perf  = $('perfil');
        const c1    = $('cedula1');
        const c2    = $('cedula2');

        const hasDep   = dep && dep.files && dep.files.length > 0;
        const hasPerf  = perf && perf.files && perf.files.length > 0;
        const hasC1    = c1 && c1.files && c1.files.length > 0;
        const hasC2    = c2 && c2.files && c2.files.length > 0;

        if (!hasDep && !hasPerf && !hasC1 && !hasC2){
          e.preventDefault();
          alert('Debes seleccionar al menos una imagen para subir.');
          return;
        }

        const btn = document.getElementById('uploadBtn');
        if (btn){
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Subiendo…';
        }
      });
    }
  })();
</script>
{% endblock %}