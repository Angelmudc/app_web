{# templates/subir_fotos.html #}
{% extends "base.html" %}

{% block title %}Subir Fotos - Doméstica del Cibao A&amp;D{% endblock %}

{% block hero %}
<div class="hero-section">
  <h1 class="h3 mb-1 d-flex align-items-center justify-content-center gap-2">
    <i class="fa-solid fa-cloud-arrow-up"></i> Subir Fotos de Candidatas
  </h1>
  <p class="text-muted mb-0">Busca la candidata y carga sus imágenes con vista previa y validaciones.</p>
</div>
{% endblock %}

{% block content %}
<div class="container pb-4">

  {# ========================= BUSCAR ========================= #}
  {% if accion == "buscar" %}
    <div class="card mt-3">
      <div class="card-body">
        <form method="post"
              action="{{ url_for('subir_fotos.subir_fotos', accion='buscar') }}"
              id="searchForm"
              class="row g-2 align-items-end"
              novalidate>
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <div class="col-12 col-lg-9">
            <label for="buscar" class="form-label mb-1">Buscar por nombre, cédula o teléfono</label>
            <div class="input-group input-group-lg">
              <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
              <input type="text"
                     class="form-control"
                     id="buscar"
                     name="busqueda"
                     placeholder="Ej: María / 00100200345 / 809-000-0000"
                     required
                     autocomplete="off">
              <button class="btn btn-primary" type="submit" id="searchButton">
                <i class="fa-solid fa-search me-1"></i>Buscar
              </button>
            </div>
            <div class="form-text">Tip: pega la cédula sin guiones; igual la encontramos.</div>
          </div>
        </form>
      </div>
    </div>

    {% if resultados %}
      <div class="card mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-semibold"><i class="fa-solid fa-list-ul me-2"></i>Resultados</span>
          <span class="badge-soft">{{ resultados|length }} candidata{{ resultados|length != 1 and 's' or '' }}</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle m-0" id="tabla-subir-fotos">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Cédula</th>
                  <th>Teléfono</th>
                  <th style="width: 160px;" class="text-center">Acción</th>
                </tr>
              </thead>
              <tbody>
                {% for cand in resultados %}
                <tr>
                  <td class="fw-semibold">{{ cand.nombre }}</td>
                  <td><span class="badge-soft">{{ cand.cedula }}</span></td>
                  <td>{{ cand.telefono or '—' }}</td>
                  <td class="text-center">
                    <a href="{{ url_for('subir_fotos.subir_fotos', accion='subir', fila=cand.fila) }}"
                       class="btn btn-sm btn-outline-primary">
                      <i class="fa-solid fa-cloud-arrow-up me-1"></i>Seleccionar
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    {% endif %}
  {% endif %}

  {# ========================== SUBIR ========================= #}
  {% if accion == "subir" %}
    <div class="d-flex align-items-center justify-content-between mt-2">
      <h2 class="h5 m-0 d-flex align-items-center gap-2">
        <i class="fa-solid fa-image"></i>
        Subir Imágenes para la Fila <span class="badge-soft">{{ fila }}</span>
      </h2>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('subir_fotos.subir_fotos', accion='buscar') }}">
        <i class="fa-solid fa-rotate-left me-1"></i>Volver a buscar
      </a>
    </div>

    <form method="post"
          action="{{ url_for('subir_fotos.subir_fotos', accion='subir', fila=fila) }}"
          enctype="multipart/form-data"
          id="uploadForm"
          class="mt-3">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <div class="row g-3">
        {# ---- Depuración ---- #}
        <div class="col-12 col-lg-6">
          <div class="card h-100">
            <div class="card-header d-flex align-items-center gap-2">
              <i class="fa-solid fa-shield-halved"></i>
              <span>Imagen de Depuración</span>
            </div>
            <div class="card-body">
              <div class="upload-zone border rounded-2 p-3 text-center"
                   data-target="depuracion"
                   tabindex="0">
                <div class="mb-2">
                  <i class="fa-solid fa-cloud-arrow-up fa-2x"></i>
                </div>
                <p class="mb-2">Arrastra y suelta aquí, o haz clic para seleccionar.</p>
                <p class="text-muted small">Formatos: JPG/PNG • Máx: 5 MB</p>
                <input class="form-control d-none"
                       type="file"
                       id="depuracion"
                       name="depuracion"
                       accept="image/*"
                       required>
                <div class="ratio ratio-4x3 mt-3 rounded overflow-hidden bg-light skeleton d-none" id="preview-wrap-depuracion">
                  <img id="preview-depuracion" alt="Vista previa depuración" class="w-100 h-100 object-fit-cover">
                </div>
                <div class="d-flex justify-content-center gap-2 mt-2 d-none" id="controls-depuracion">
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-clear="depuracion">
                    <i class="fa-regular fa-trash-can me-1"></i>Quitar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        {# ---- Perfil ---- #}
        <div class="col-12 col-lg-6">
          <div class="card h-100">
            <div class="card-header d-flex align-items-center gap-2">
              <i class="fa-solid fa-id-card-clip"></i>
              <span>Imagen de Perfil</span>
            </div>
            <div class="card-body">
              <div class="upload-zone border rounded-2 p-3 text-center"
                   data-target="perfil"
                   tabindex="0">
                <div class="mb-2">
                  <i class="fa-solid fa-cloud-arrow-up fa-2x"></i>
                </div>
                <p class="mb-2">Arrastra y suelta aquí, o haz clic para seleccionar.</p>
                <p class="text-muted small">Formatos: JPG/PNG • Máx: 5 MB</p>
                <input class="form-control d-none"
                       type="file"
                       id="perfil"
                       name="perfil"
                       accept="image/*"
                       required>
                <div class="ratio ratio-4x3 mt-3 rounded overflow-hidden bg-light skeleton d-none" id="preview-wrap-perfil">
                  <img id="preview-perfil" alt="Vista previa perfil" class="w-100 h-100 object-fit-cover">
                </div>
                <div class="d-flex justify-content-center gap-2 mt-2 d-none" id="controls-perfil">
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-clear="perfil">
                    <i class="fa-regular fa-trash-can me-1"></i>Quitar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-end gap-2 mt-3">
        <a class="btn btn-outline-secondary" href="{{ url_for('subir_fotos.subir_fotos', accion='buscar') }}">
          Cancelar
        </a>
        <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn">
          <i class="fa-solid fa-cloud-arrow-up me-1"></i> Subir Imágenes
        </button>
      </div>
    </form>
  {% endif %}

  <div class="text-center mt-4">
    <a href="{{ url_for('home') }}" class="btn btn-outline-primary">
      <i class="fa-solid fa-house me-1"></i>Inicio
    </a>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  // ===== Disable search button on submit =====
  (function(){
    const form = document.getElementById("searchForm");
    if (!form) return;
    form.addEventListener("submit", function(){
      const btn = document.getElementById("searchButton");
      if (!btn) return;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Buscando…';
    });
  })();

  // ===== DataTables for results =====
  document.addEventListener('DOMContentLoaded', function(){
    const t = document.getElementById('tabla-subir-fotos');
    if (t && window.$ && $.fn.DataTable){
      $('#tabla-subir-fotos').DataTable({
        pageLength: 10,
        order: [[0,'asc']],
        autoWidth: false,
        language: { url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json' }
      });
    }
  });

  // ===== Upload UX: click-to-open, drag&drop, preview, size/type checks =====
  (function(){
    const MAX_MB = 5;
    const MAX_BYTES = MAX_MB * 1024 * 1024;

    function $(id){ return document.getElementById(id); }

    function showPreview(kind, file){
      const wrap = $('preview-wrap-' + kind);
      const img  = $('preview-' + kind);
      const ctr  = $('controls-' + kind);
      if (!wrap || !img || !ctr) return;

      const url = URL.createObjectURL(file);
      img.onload = () => URL.revokeObjectURL(url);
      img.src = url;
      wrap.classList.remove('d-none');
      ctr.classList.remove('d-none');
    }

    function clearField(kind){
      const input = $(kind);
      if (!input) return;
      input.value = "";
      const wrap = $('preview-wrap-' + kind);
      const ctr  = $('controls-' + kind);
      if (wrap) wrap.classList.add('d-none');
      if (ctr)  ctr.classList.add('d-none');
    }

    // Bind clear buttons
    document.querySelectorAll('[data-clear]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const kind = btn.getAttribute('data-clear');
        clearField(kind);
      });
    });

    // Zone behavior
    document.querySelectorAll('.upload-zone').forEach(zone=>{
      const kind  = zone.getAttribute('data-target');
      const input = $(kind);

      // Click to open
      zone.addEventListener('click', e=>{
        if (e.target.tagName !== 'BUTTON') input?.click();
      });
      zone.addEventListener('keypress', e=>{
        if ((e.key === 'Enter' || e.key === ' ') && input) {
          e.preventDefault();
          input.click();
        }
      });

      // Input change
      input?.addEventListener('change', ()=>{
        const file = input.files && input.files[0];
        if (!file) return;

        if (!file.type.startsWith('image/')){
          alert('El archivo debe ser una imagen.');
          clearField(kind);
          return;
        }
        if (file.size > MAX_BYTES){
          alert(`La imagen supera ${MAX_MB} MB. Por favor, selecciona otra.`);
          clearField(kind);
          return;
        }
        showPreview(kind, file);
      });

      // Drag & drop
      ;['dragenter','dragover'].forEach(ev=>{
        zone.addEventListener(ev, e=>{
          e.preventDefault(); e.stopPropagation();
          zone.classList.add('border-primary');
        }, false);
      });
      ;['dragleave','drop'].forEach(ev=>{
        zone.addEventListener(ev, e=>{
          e.preventDefault(); e.stopPropagation();
          zone.classList.remove('border-primary');
        }, false);
      });
      zone.addEventListener('drop', e=>{
        const dt = e.dataTransfer;
        const file = dt && dt.files && dt.files[0];
        if (!file || !input) return;
        if (!file.type.startsWith('image/')){
          alert('El archivo debe ser una imagen.');
          return;
        }
        if (file.size > MAX_BYTES){
          alert(`La imagen supera ${MAX_MB} MB. Por favor, selecciona otra.`);
          return;
        }
        // Set file to input programmatically is not trivial (FileList is read-only).
        // Workaround: open selector with message.
        // Better UX: just preview and ask user to confirmar usando botón "Seleccionar".
        showPreview(kind, file);
        alert('Vista previa cargada por arrastre. Por favor, haz clic en el recuadro para seleccionar el mismo archivo desde el selector (limitación del navegador).');
      });
    });

    // Submit button loading state
    const uploadForm = document.getElementById('uploadForm');
    if (uploadForm){
      uploadForm.addEventListener('submit', ()=>{
        const btn = document.getElementById('uploadBtn');
        if (btn){
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Subiendo…';
        }
      });
    }
  })();
</script>
{% endblock %}
