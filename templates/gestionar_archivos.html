{# templates/gestionar_archivos.html #}
{% extends "base.html" %}

{% block title %}Gestionar Archivos - Doméstica del Cibao A&amp;D{% endblock %}

{% block hero %}
<div class="hero-section">
  <h1 class="h3 mb-1 d-flex align-items-center justify-content-center gap-2">
    <i class="fa-solid fa-folder-open"></i> Gestión de Archivos y Entrevistas
  </h1>
  <p class="text-muted mb-0">Busca una candidata y descarga sus documentos. Simple, ordenado y rápido.</p>
</div>
{% endblock %}

{% block content %}
<div class="container pb-4">

  {# ========================= BUSCAR ========================= #}
  {% if accion == "buscar" %}
    <div class="card mt-3">
      <div class="card-body">
        <form method="post"
              action="{{ url_for('gestionar_archivos') }}?accion=buscar"
              id="searchForm"
              class="row g-2 align-items-end"
              novalidate>
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <div class="col-12 col-lg-9">
            <label for="buscar" class="form-label mb-1">Buscar por nombre, cédula o teléfono</label>
            <div class="input-group input-group-lg">
              <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
              <input type="text"
                     class="form-control"
                     id="buscar"
                     name="busqueda"
                     placeholder="Ej: María / 00100200345 / 809-000-0000"
                     required
                     autocomplete="off">
              <button class="btn btn-primary" type="submit" id="searchButton">
                <i class="fa-solid fa-search me-1"></i>Buscar
              </button>
            </div>
            <div class="form-text">Tip: pega la cédula sin guiones; igual la encontramos.</div>
          </div>
        </form>
      </div>
    </div>

    {% if resultados %}
      <div class="card mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-semibold"><i class="fa-solid fa-list-ul me-2"></i>Resultados</span>
          <span class="badge-soft">{{ resultados|length }} candidata{{ resultados|length != 1 and 's' or '' }}</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle m-0" id="tabla-gestionar-archivos">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Cédula</th>
                  <th>Teléfono</th>
                  <th style="width: 160px;" class="text-center">Acción</th>
                </tr>
              </thead>
              <tbody>
                {% for cand in resultados %}
                <tr>
                  <td class="fw-semibold">{{ cand.nombre }}</td>
                  <td><span class="badge-soft">{{ cand.cedula }}</span></td>
                  <td>{{ cand.telefono or '—' }}</td>
                  <td class="text-center">
                    <a href="{{ url_for('gestionar_archivos') }}?accion=ver&fila={{ cand.fila }}"
                       class="btn btn-sm btn-outline-primary">
                      <i class="fa-solid fa-folder-tree me-1"></i>Documentos
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    {% endif %}
  {% endif %}

  {# ========================== VER =========================== #}
  {% if accion == "ver" %}
    <div class="d-flex align-items-center justify-content-between mt-2">
      <h2 class="h5 m-0 d-flex align-items-center gap-2">
        <i class="fa-solid fa-file-shield"></i>
        Documentos de la Fila <span class="badge-soft">{{ fila }}</span>
      </h2>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('gestionar_archivos') }}?accion=buscar">
        <i class="fa-solid fa-rotate-left me-1"></i>Volver a buscar
      </a>
    </div>

    {# docs llega como dict desde backend #}
    {% set dep = docs['depuracion'] if docs is defined and docs else None %}
    {% set per = docs['perfil']     if docs is defined and docs else None %}
    {% set c1  = docs['cedula1']    if docs is defined and docs else None %}
    {% set c2  = docs['cedula2']    if docs is defined and docs else None %}
    {% set ent = docs['entrevista'] if docs is defined and docs else "" %}

    {% if docs %}
      <div class="row g-3 mt-2">

        {% macro file_card(label, available, icon, key, preview=false) -%}
          <div class="col-12 col-md-6 col-lg-4">
            <div class="card h-100">
              <div class="card-body d-flex flex-column">
                <div class="d-flex align-items-center gap-2">
                  <span class="fs-4"><i class="fa-solid {{ icon }}"></i></span>
                  <div class="flex-grow-1">
                    <div class="fw-semibold">{{ label }}</div>
                    {% if available %}
                      <div class="small text-success d-flex align-items-center gap-1">
                        <i class="fa-solid fa-circle-check"></i> Disponible
                      </div>
                    {% else %}
                      <div class="small text-muted d-flex align-items-center gap-1">
                        <i class="fa-regular fa-circle-xmark"></i> No disponible
                      </div>
                    {% endif %}
                  </div>
                </div>

                {% if available and preview %}
                  <div class="mt-3">
                    <div class="ratio ratio-4x3 rounded overflow-hidden bg-light">
                      <img
                        src="{{ url_for('subir_fotos.ver_imagen', fila=fila, campo=key) }}"
                        alt="{{ label }}"
                        class="w-100 h-100 object-fit-cover">
                    </div>
                  </div>
                {% endif %}

                <div class="mt-3">
                  {% if available %}
                    <div class="d-grid gap-2">
                      <a class="btn btn-primary"
                         href="{{ url_for('descargar_uno_db', id=fila, doc=key) }}">
                        <i class="fa-solid fa-download me-1"></i>Descargar
                      </a>
                      {% if preview %}
                        <a class="btn btn-outline-secondary"
                           target="_blank"
                           href="{{ url_for('subir_fotos.ver_imagen', fila=fila, campo=key) }}">
                          <i class="fa-regular fa-eye me-1"></i>Ver grande
                        </a>
                      {% endif %}
                    </div>
                  {% else %}
                    <button class="btn btn-outline-secondary w-100" disabled>
                      <i class="fa-regular fa-eye-slash me-1"></i>Sin archivo
                    </button>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {%- endmacro %}

        {{ file_card('Depuración',        dep, 'fa-shield-halved', 'depuracion', true) }}
        {{ file_card('Perfil',            per, 'fa-id-card-clip',  'perfil',     true) }}
        {{ file_card('Cédula (Frente)',   c1,  'fa-address-card',  'cedula1',    true) }}
        {{ file_card('Cédula (Reverso)',  c2,  'fa-address-book',  'cedula2',    true) }}

        {# Entrevista #}
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card h-100">
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-center gap-2">
                <span class="fs-4"><i class="fa-solid fa-comments"></i></span>
                <div class="flex-grow-1">
                  <div class="fw-semibold">Entrevista</div>
                  {% if ent and ent|trim %}
                    <div class="small text-success d-flex align-items-center gap-1">
                      <i class="fa-solid fa-circle-check"></i> Registrada
                    </div>
                  {% else %}
                    <div class="small text-muted d-flex align-items-center gap-1">
                      <i class="fa-regular fa-circle-xmark"></i> No disponible
                    </div>
                  {% endif %}
                </div>
              </div>

              <div class="mt-3">
                {% if ent and ent|trim %}
                  <div class="d-grid gap-2">
                    <a class="btn btn-primary"
                       href="{{ url_for('generar_pdf_entrevista', fila=fila) }}">
                      <i class="fa-solid fa-download me-1"></i>Descargar PDF
                    </a>
                    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#previewEntrevista">
                      <i class="fa-regular fa-eye me-1"></i>Vista rápida
                    </button>
                  </div>

                  <div class="collapse mt-2" id="previewEntrevista">
                    <div class="border rounded p-2 small bg-light" style="white-space: pre-wrap;">
                      {{ ent[:1200] }}{% if ent|length > 1200 %}…{% endif %}
                    </div>
                    <div class="text-muted small mt-1">
                      *Vista rápida muestra un resumen. El PDF sale completo.
                    </div>
                  </div>
                {% else %}
                  <button class="btn btn-outline-secondary w-100" disabled>
                    <i class="fa-regular fa-file me-1"></i>Sin entrevista
                  </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

      </div>
    {% else %}
      <div class="card mt-3">
        <div class="card-body text-center">
          <p class="mb-0 text-muted">No se encontraron documentos almacenados para esta fila.</p>
        </div>
      </div>
    {% endif %}
  {% endif %}

  <div class="text-center mt-4">
    <a href="{{ url_for('home') }}" class="btn btn-outline-primary">
      <i class="fa-solid fa-house me-1"></i>Inicio
    </a>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  // Deshabilitar botón mientras busca
  (function(){
    const form = document.getElementById("searchForm");
    if (!form) return;
    form.addEventListener("submit", function(){
      const btn = document.getElementById("searchButton");
      if (!btn) return;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Buscando…';
    });
  })();

  // DataTables si hay tabla de resultados
  document.addEventListener('DOMContentLoaded', function(){
    const t = document.getElementById('tabla-gestionar-archivos');
    if (t && window.$ && $.fn.DataTable){
      $('#tabla-gestionar-archivos').DataTable({
        pageLength: 10,
        order: [[0,'asc']],
        autoWidth: false,
        language: { url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json' }
      });
    }
  });
</script>
{% endblock %}