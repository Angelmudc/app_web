{# templates/porciento.html #}
{% extends "base.html" %}

{% block title %}üî¢ Calcular Porcentaje{% endblock %}

{% block content %}
<div class="container py-3">

  {# ---------- ENCABEZADO ---------- #}
  <section class="hero-section">
    <h1 class="h3 mb-1">üî¢ Calcular Porcentaje</h1>
    <p class="text-muted mb-0">Busca a la candidata y guarda el c√°lculo del 25 %.</p>
  </section>

  {# ---------- FLASHES (fallback; ya hay toasts globales) ---------- #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mt-3">
        {% for category, text in messages %}
          <div class="alert alert-{{ 'success' if category=='success' else 'danger' if category=='danger' else 'warning' }} alert-dismissible fade show" role="alert">
            {{ text }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {# ============================================================ #}
  {# ====================   BUSCAR (GET)   ====================== #}
  {# ============================================================ #}
  <div class="card mt-3 sticky-bar">
    <div class="card-body">
      <form id="searchForm" method="GET" action="{{ url_for('porciento') }}" autocomplete="off" class="row g-2 align-items-end">
        <div class="col-12">
          <label for="busqueda" class="form-label mb-1">T√©rmino de b√∫squeda</label>
          <div class="input-group input-group-lg">
            <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
            <input
              id="busqueda" name="busqueda"
              class="form-control"
              placeholder="Nombre o c√©dula (000-0000000-0)"
              value="{{ request.args.get('busqueda','') }}"
              aria-label="Buscar candidata" required>
            {% if request.args.get('busqueda') %}
              <a href="{{ url_for('porciento') }}" class="btn btn-outline-secondary" title="Limpiar">
                <i class="fa-solid fa-eraser"></i>
              </a>
            {% endif %}
            <button type="submit" class="btn btn-primary" title="Buscar">
              <span class="d-none d-sm-inline">Buscar</span> <i class="fa-solid fa-arrow-right-long ms-1"></i>
            </button>
          </div>
          <div class="form-text d-flex flex-wrap gap-3 mt-2">
            <span><i class="fa-regular fa-keyboard me-1"></i><strong>Ctrl/‚åò+K</strong> enfoca la b√∫squeda</span>
            <span><i class="fa-regular fa-lightbulb me-1"></i>Pega una c√©dula y presiona Enter</span>
          </div>
        </div>
      </form>
    </div>
  </div>

  {# ====================   RESULTADOS   ======================== #}
  {% if resultados %}
    <div class="card mt-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-semibold"><i class="fa-solid fa-list-ul me-2"></i>Resultados</span>
        <span class="badge-soft">{{ resultados|length }} coincidencia{{ resultados|length != 1 and 's' or '' }}</span>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover table-nowrap m-0 align-middle" id="tabla-resultados">
            <thead class="position-sticky top-0" style="z-index:1">
              <tr>
                <th>Nombre</th>
                <th>C√©dula</th>
                <th>Tel√©fono</th>
                <th style="width:140px" class="text-center">Acci√≥n</th>
              </tr>
            </thead>
            <tbody>
              {% for cand in resultados %}
              <tr>
                <td class="fw-semibold"><i class="fa-solid fa-user me-1 text-muted"></i>{{ cand.nombre_completo }}</td>
                <td>
                  <span class="badge-soft me-2">{{ cand.cedula }}</span>
                  <button class="btn btn-xxs btn-outline-secondary copy-btn"
                          type="button"
                          data-copy="{{ cand.cedula }}"
                          title="Copiar c√©dula"
                          aria-label="Copiar c√©dula {{ cand.cedula }}">
                    <i class="fa-regular fa-copy"></i>
                  </button>
                </td>
                <td>
                  {% if cand.numero_telefono %}
                    <a class="text-decoration-none" href="tel:{{ cand.numero_telefono }}" title="Llamar">
                      <i class="fa-solid fa-phone me-1"></i>{{ cand.numero_telefono }}
                    </a>
                    <button class="btn btn-xxs btn-outline-secondary copy-btn ms-1"
                            type="button"
                            data-copy="{{ cand.numero_telefono }}"
                            title="Copiar tel√©fono"
                            aria-label="Copiar tel√©fono {{ cand.numero_telefono }}">
                      <i class="fa-regular fa-copy"></i>
                    </button>
                  {% else %}‚Äì{% endif %}
                </td>
                <td class="text-center">
                  <a href="{{ url_for('porciento', candidata=cand.fila) }}"
                     class="btn btn-sm btn-outline-secondary"
                     title="Ver detalles">
                    üìÑ Ver Detalles
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}

  {# ====================   DETALLE + FORM   ==================== #}
  {% if candidata %}
    <div class="card mt-3">
      <div class="card-header">
        <i class="fa-solid fa-file-invoice-dollar me-2"></i>Detalles de la Candidata
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <ul class="list-group">
              <li class="list-group-item"><strong>üë§ Nombre:</strong> {{ candidata.nombre_completo }}</li>
              <li class="list-group-item"><strong>üìû Tel√©fono:</strong> {{ candidata.numero_telefono or 'N/A' }}</li>
              <li class="list-group-item"><strong>üÜî C√©dula:</strong> {{ candidata.cedula }}</li>
            </ul>
          </div>
          <div class="col-md-6">
            <ul class="list-group">
              {% if candidata.monto_total is not none %}
                <li class="list-group-item"><strong>üí∞ Monto Total:</strong> {{ candidata.monto_total }}</li>
                <li class="list-group-item"><strong>üìä 25 %:</strong> {{ candidata.porciento }}</li>
                <li class="list-group-item"><strong>üìÖ Pago el:</strong> {{ candidata.fecha_de_pago }}</li>
                <li class="list-group-item"><strong>üóìÔ∏è Inicia el:</strong> {{ candidata.inicio }}</li>
              {% else %}
                <li class="list-group-item text-muted">Sin c√°lculo previo.</li>
              {% endif %}
            </ul>
          </div>
        </div>

        <hr class="my-4">

        <form method="POST" action="{{ url_for('porciento') }}" id="formPorciento" autocomplete="off" class="mt-2">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="fila_id" value="{{ candidata.fila }}">

          <div class="row g-3 mb-2">
            <div class="col-md-4">
              <label for="fecha_pago" class="form-label">Fecha de Pago</label>
              <input type="date" id="fecha_pago" name="fecha_pago" class="form-control track-change" required>
            </div>
            <div class="col-md-4">
              <label for="fecha_inicio" class="form-label">Fecha de Inicio</label>
              <input type="date" id="fecha_inicio" name="fecha_inicio" class="form-control track-change" required>
            </div>
            <div class="col-md-4">
              <label for="monto_total" class="form-label">Monto Total</label>
              <div class="input-group">
                <span class="input-group-text">RD$</span>
                <input type="number" step="0.01" min="0" id="monto_total" name="monto_total"
                       class="form-control track-change" placeholder="0.00" required>
              </div>
              <div class="form-text">Vista previa 25 %: <strong id="preview25">‚Äî</strong></div>
            </div>
          </div>

          <div class="d-flex gap-2 mt-2">
            <button type="submit" class="btn btn-success" id="btnGuardar">Calcular y Guardar 25 %</button>
            <a href="{{ url_for('porciento') }}" class="btn btn-outline-secondary">‚Ü∫ Nueva b√∫squeda</a>
          </div>

          <div class="text-center text-muted small mt-3">
            <i class="fa-regular fa-shield"></i> Datos sensibles protegidos. Evita pegarlos en chats externos.
          </div>
        </form>
      </div>
    </div>
  {% endif %}

  <a href="{{ url_for('home') }}" class="btn btn-secondary mt-3">üè† Volver al Inicio</a>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  // ===== Copiar al portapapeles con toast =====
  function copyToClipboard(text){
    if(!text) return;
    navigator.clipboard.writeText(text).then(()=>{
      const toast = document.createElement('div');
      toast.className = 'toast align-items-center text-bg-secondary border-0';
      toast.role = 'alert'; toast.ariaLive = 'polite'; toast.ariaAtomic = 'true';
      toast.style.position='fixed'; toast.style.bottom='18px'; toast.style.right='18px'; toast.style.zIndex=1080;
      toast.innerHTML = `<div class="d-flex"><div class="toast-body">Copiado: <strong>${text}</strong></div>
                         <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      document.body.appendChild(toast);
      new bootstrap.Toast(toast, { delay: 2200 }).show();
      setTimeout(()=>toast.remove(), 2600);
    });
  }

  document.addEventListener('DOMContentLoaded', function(){
    // Atajo Ctrl/‚åò+K
    const inputBuscar = document.getElementById('busqueda');
    document.addEventListener('keydown', (e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='k'){
        e.preventDefault();
        inputBuscar?.focus(); inputBuscar?.select();
      }
    });
    if (inputBuscar && !inputBuscar.value) { inputBuscar.focus(); }

    // Copiar acciones
    document.querySelectorAll('.copy-btn').forEach(btn=>{
      btn.addEventListener('click', function(){
        copyToClipboard(this.getAttribute('data-copy'));
      });
    });

    // DataTables (si est√° jQuery y plugin)
    const tbl = document.getElementById('tabla-resultados');
    if (tbl && window.$ && $.fn.DataTable){
      $('#tabla-resultados').DataTable({
        pageLength: 10,
        order: [],
        autoWidth: false,
        deferRender: true,
        responsive: true,
        language: { url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json' }
      });
    }

    // Preview 25 % (solo vista)
    const monto = document.getElementById('monto_total');
    const prev  = document.getElementById('preview25');
    function fmt(n){ return isNaN(n) ? '‚Äî' : new Intl.NumberFormat('es-DO', { style:'currency', currency:'DOP' }).format(n); }
    if (monto && prev){
      const update = ()=>{ const v = parseFloat(monto.value); prev.textContent = fmt(v*0.25); };
      monto.addEventListener('input', update); update();
    }

    // Track cambios + bloquear doble submit + mini toast
    const form = document.getElementById('formPorciento');
    const btn  = document.getElementById('btnGuardar');
    if (form){
      const tracked = form.querySelectorAll('.track-change');
      tracked.forEach(el=>{
        const init = el.value ?? '';
        el.dataset.initial = init;
        const mark = ()=>{ el.classList.toggle('is-dirty', String(el.value??'') !== String(el.dataset.initial)); };
        el.addEventListener('input', mark); el.addEventListener('change', mark);
      });

      form.addEventListener('submit', ()=>{
        if(btn){ btn.disabled = true; btn.textContent = 'Guardando‚Ä¶'; }
        // toast local (adem√°s de flashes del servidor)
        const ok = document.createElement('div');
        ok.className = 'toast align-items-center text-bg-success border-0';
        ok.role = 'status'; ok.ariaLive = 'polite'; ok.ariaAtomic = 'true';
        ok.style.position='fixed'; ok.style.bottom='18px'; ok.style.right='18px'; ok.style.zIndex=1080;
        ok.innerHTML = '<div class="d-flex"><div class="toast-body">Datos enviados üíæ</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>';
        document.body.appendChild(ok);
        new bootstrap.Toast(ok, { delay: 1600 }).show();
        setTimeout(()=>ok.remove(), 2000);
      });
    }
  });
</script>

<style>
  /* Sticky robusto con altura de navbar de base.html */
  .sticky-bar{ position: sticky; top: calc(var(--navbar-h) + 6px); z-index: 10; }

  .table-nowrap td, .table-nowrap th { white-space: nowrap; }

  .btn-xxs{
    --bs-btn-padding-y:.15rem; --bs-btn-padding-x:.35rem; --bs-btn-font-size:.7rem;
    border-radius: 999px;
  }

  /* ‚ÄúCambios pendientes‚Äù (no error) */
  .is-dirty{
    border-color: color-mix(in srgb, var(--warning) 58%, var(--border)) !important;
    box-shadow: 0 0 0 6px color-mix(in srgb, var(--warning) 24%, transparent) !important;
  }
</style>
{% endblock %}
