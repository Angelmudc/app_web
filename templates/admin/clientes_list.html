{% extends 'base.html' %}
{% block title %}Clientes{% endblock %}

{% block content %}
<style>
  :root{
    --bg-color:#0f172a;
    --card-bg:rgba(255,255,255,0.06);
    --text-color:#e2e8f0;
    --accent:#38bdf8;
    --border-color:rgba(255,255,255,0.12);
    --btn-radius:.6rem;

    /* Men√∫ de interacci√≥n: S√ìLIDO (sin glass) */
    --menu-bg:#0b1220;
    --menu-text:#e2e8f0;
    --menu-border:#1f2937;
    --menu-hover:#2563eb;
  }
  body.light-mode{
    --bg-color:#f3f4f6;
    --card-bg:#ffffff;
    --text-color:#1e293b;
    --accent:#2563eb;
    --border-color:rgba(0,0,0,.1);

    --menu-bg:#ffffff;
    --menu-text:#111827;
    --menu-border:#e5e7eb;
    --menu-hover:#2563eb;
  }

  body{
    background:var(--bg-color);
    font-family:'Poppins',sans-serif;
    color:var(--text-color);
  }

  .container{max-width:98%}
  h1{font-weight:600}

  /* Card sin blur */
  .glass-card{
    background:var(--card-bg);
    border:1px solid var(--border-color);
    border-radius:1rem;
    box-shadow:0 6px 14px rgba(0,0,0,.25);
    padding:1.25rem;
  }

  /* Bot√≥n modo */
  .mode-toggle{
    width:45px;height:45px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    background:var(--card-bg);
    border:1px solid var(--border-color);
    color:var(--text-color);
    cursor:pointer;
  }

  /* Tabla */
  .table{width:100%;border-collapse:collapse;font-size:.98rem;color:var(--text-color)}
  thead th{
    background:rgba(255,255,255,.08);
    border-bottom:2px solid var(--border-color);
    text-align:center;padding:1rem;font-weight:600;
  }
  tbody tr{background:rgba(255,255,255,.03)}
  tbody tr:hover{background:rgba(56,189,248,.12)}
  td{padding:1rem;text-align:center;border-bottom:1px solid var(--border-color)}

  /* Botones */
  .btn{border-radius:var(--btn-radius);font-weight:500}
  .btn-sm{padding:.4rem .7rem}
  .btn-success{background:#10b981;border:none;color:#fff}
  .btn-success:hover{background:#059669}
  .btn-primary{background:#2563eb;border:none;color:#fff}
  .btn-primary:hover{background:#1d4ed8}
  .btn-warning{background:#facc15;border:none;color:#000}
  .btn-warning:hover{background:#eab308}
  .btn-info{background:#0ea5e9;border:none;color:#fff}
  .btn-info:hover{background:#0284c7}
  .btn-outline-secondary{border:1px solid var(--border-color);color:var(--text-color)}
  .btn-outline-secondary:hover{background:var(--accent);color:#fff;border-color:transparent}

  /* Permitir que algo pueda salirse de la tabla si hace falta */
  .table-responsive{overflow:visible !important; position:relative; z-index:1;}

  /* Men√∫ base (cuando est√° dentro del flujo) ‚Äî SIEMPRE s√≥lido */
  .dropdown-menu{
    min-width:210px;
    font-size:.95rem;
    background:var(--menu-bg) !important;
    color:var(--menu-text) !important;
    border:1px solid var(--menu-border) !important;
    border-radius:.8rem;
    display:none;
    position:absolute; top:110%; right:0;
    box-shadow:0 12px 28px rgba(0,0,0,.45);
    pointer-events:auto;
  }
  .dropdown-menu.show{display:block}
  .dropdown-item{
    color:var(--menu-text) !important;
    padding:.55rem .9rem;
    display:block;
    text-decoration:none;
    background:transparent !important;
  }
  .dropdown-item:hover{
    background:var(--menu-hover) !important;
    color:#fff !important;
  }
  .dropdown-divider{
    margin:.35rem 0;
    border-top:1px solid var(--menu-border) !important;
  }
  .dropdown-toggle::after{display:none}

  /* PORTAL: contenedor fijo sobre todo */
  #dropdown-portal{
    position:fixed;
    inset:0;
    pointer-events:none; /* deja pasar clicks fuera del men√∫ */
    z-index:2147483647;  /* m√°ximo */
  }
  #dropdown-portal .portal-menu{
    position:fixed;      /* se posiciona por coordenadas absolutas del bot√≥n */
    background:var(--menu-bg);
    color:var(--menu-text);
    border:1px solid var(--menu-border);
    border-radius:.8rem;
    box-shadow:0 12px 28px rgba(0,0,0,.55);
    min-width:210px;
    max-height:60vh;
    overflow:auto;
    pointer-events:auto; /* el men√∫ s√≠ recibe clicks */
  }
</style>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <h1 class="h3 mb-0">üë• Clientes</h1>
    <div class="d-flex align-items-center gap-3">
      <div class="btn-group" role="group">
        <a href="{{ url_for('admin.nuevo_cliente') }}" class="btn btn-success"><i class="bi bi-person-plus-fill"></i> Nuevo</a>
        <a href="{{ url_for('admin.listar_solicitudes') }}" class="btn btn-primary"><i class="bi bi-card-list"></i> Solicitudes</a>
        <a href="{{ url_for('admin.acciones_solicitudes_proceso') }}" class="btn btn-warning text-dark"><i class="bi bi-lightning-fill"></i> Pendientes ‚ö°</a>
        <a href="{{ url_for('admin.resumen_diario_clientes') }}" class="btn btn-info"><i class="bi bi-calendar-day-fill"></i> Resumen Hoy üìÖ</a>
      </div>
      <div class="mode-toggle" id="modeToggle" title="Cambiar modo">
        <i class="bi bi-sun-fill" id="modeIcon"></i>
      </div>
    </div>
  </div>

  <form class="d-flex mb-4" method="get" action="{{ url_for('admin.listar_clientes') }}">
    <input name="q" class="form-control me-2" placeholder="üîé Buscar por ID, c√≥digo, nombre, email o tel√©fono" value="{{ q }}">
    <button class="btn btn-outline-secondary"><i class="bi bi-search"></i> Buscar</button>
  </form>

  {% if clientes %}
  <div class="glass-card">
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>#</th>
            <th>üÜî C√≥digo</th>
            <th>üë§ Nombre</th>
            <th>üìß Email</th>
            <th>üìû Tel√©fono</th>
            <th>üèôÔ∏è Ciudad</th>
            <th>üìç Sector</th>
            <th>üìã Solicitudes</th>
            <th>üìÖ Registro</th>
            <th>‚öôÔ∏è Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for c in clientes %}
          <tr>
            <td data-label="#">{{ c.id }}</td>
            <td data-label="C√≥digo">{{ c.codigo }}</td>
            <td data-label="Nombre">{{ c.nombre_completo }}</td>
            <td data-label="Email">{{ c.email }}</td>
            <td data-label="Tel√©fono">{{ c.telefono }}</td>
            <td data-label="Ciudad">{{ c.ciudad or '‚Äî' }}</td>
            <td data-label="Sector">{{ c.sector or '‚Äî' }}</td>
            <td data-label="Solicitudes"><span class="badge bg-info text-dark">{{ c.total_solicitudes }}</span></td>
            <td data-label="Registro">{{ c.fecha_registro.strftime('%Y-%m-%d') }}</td>
            <td data-label="Acciones">
              <div class="btn-group">
                <button type="button"
                        class="btn btn-sm btn-primary elegir-btn"
                        data-id="{{ c.id }}"
                        aria-haspopup="true"
                        aria-expanded="false">
                  Elegir
                </button>
                <ul class="dropdown-menu dropdown-menu-end" id="menu-{{ c.id }}" role="menu" tabindex="-1" aria-label="Acciones de cliente">
                  <li><a class="dropdown-item" href="{{ url_for('admin.detalle_cliente', cliente_id=c.id) }}"><i class="bi bi-eye-fill text-info me-2"></i>Ver Detalle</a></li>
                  <li><a class="dropdown-item" href="{{ url_for('admin.editar_cliente', cliente_id=c.id) }}"><i class="bi bi-pencil-fill text-warning me-2"></i>Editar</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <a class="dropdown-item text-danger" href="#" onclick="if(confirm('¬øEliminar cliente #{{ c.id }}?')) document.getElementById('del-{{c.id}}').submit();">
                      <i class="bi bi-trash-fill me-2"></i>Eliminar
                    </a>
                    <form id="del-{{c.id}}" method="post" action="{{ url_for('admin.eliminar_cliente', cliente_id=c.id) }}" style="display:none">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    </form>
                  </li>
                </ul>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
  <div class="alert alert-info glass-card mt-4 text-center p-4">
    <i class="bi bi-info-circle-fill me-2"></i>No se encontraron clientes en la base de datos.
  </div>
  {% endif %}
</div>

<!-- Portal fijo (vac√≠o al inicio) -->
<div id="dropdown-portal" aria-hidden="true"></div>

<script>
  // MODO CLARO/OSCURO
  (function(){
    const t=document.getElementById('modeToggle');
    const i=document.getElementById('modeIcon');
    t&&t.addEventListener('click',()=>{
      document.body.classList.toggle('light-mode');
      i.classList.toggle('bi-sun-fill');
      i.classList.toggle('bi-moon-fill');
    });
  })();

  // DROPDOWNS ‚Äî usando PORTAL AL BODY para evitar que queden "detr√°s"
  (function(){
    const portal = document.getElementById('dropdown-portal');
    let openState = null; // {btn, menu, placeholder, originGroup}

    function closeAll(){
      if(!openState) return;
      const {menu, placeholder, originGroup, btn} = openState;
      // Restaurar men√∫ a su lugar original
      try{
        menu.classList.remove('show');
        menu.removeAttribute('style');
        menu.classList.remove('portal-menu');
        originGroup.replaceChild(menu, placeholder);
      }catch(e){}
      // Limpiar portal
      portal.innerHTML = '';
      portal.setAttribute('aria-hidden','true');
      // Estado
      openState = null;
      // Accesibilidad
      btn && btn.setAttribute('aria-expanded','false');
    }

    function openMenu(btn, menu){
      closeAll(); // cierra otros

      // Placeholder para volver a montar
      const placeholder = document.createComment('menu-anchor');
      const originGroup = menu.parentNode;
      originGroup.replaceChild(placeholder, menu);

      // Marcas de estado
      btn.setAttribute('aria-expanded','true');

      // Mover men√∫ al portal y posicionarlo
      menu.classList.add('portal-menu','show');
      portal.innerHTML = '';
      portal.appendChild(menu);
      portal.setAttribute('aria-hidden','false');

      // Coordenadas del bot√≥n
      const r = btn.getBoundingClientRect();
      const menuRect = {width: Math.max(210, menu.offsetWidth || 210)};
      // Posici√≥n por defecto (abajo-derecha del bot√≥n)
      let top = r.bottom + 8;
      let left = r.right - menuRect.width;

      // Evitar salir por la derecha
      const vw = window.innerWidth, vh = window.innerHeight;
      if(left + menuRect.width > vw - 8) left = vw - menuRect.width - 8;
      if(left < 8) left = 8;

      // Si no cabe abajo, abrir arriba
      const estimatedHeight = Math.min(menu.scrollHeight, vh * 0.6);
      if(top + estimatedHeight > vh - 8){
        top = r.top - 8 - estimatedHeight;
      }
      if(top < 8) top = 8;

      // Aplicar estilo fijo
      menu.style.left = left + 'px';
      menu.style.top  = top  + 'px';
      menu.style.maxHeight = '60vh';

      // Guardar estado
      openState = {btn, menu, placeholder, originGroup};

      // Accesibilidad
      menu.setAttribute('tabindex','-1');
      menu.focus();
    }

    // Delegaci√≥n: manejar todos los .btn-group
    document.querySelectorAll('.btn-group').forEach(group=>{
      const btn = group.querySelector('.elegir-btn');
      const menu = group.querySelector('.dropdown-menu');
      if(!btn || !menu) return;

      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        // Si ya est√° ese mismo abierto ‚Üí cerrar
        if(openState && openState.menu === menu){
          closeAll();
          return;
        }
        openMenu(btn, menu);
      });
    });

    // Cerrar al hacer click fuera
    document.addEventListener('click', (e)=>{
      if(openState){
        const isInside = e.target.closest('.portal-menu') || e.target.closest('.elegir-btn');
        if(!isInside) closeAll();
      }
    });

    // Cerrar con Escape
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape') closeAll();
    });

    // Recalcular/ cerrar si cambia el viewport (scroll/resize)
    window.addEventListener('scroll', closeAll, {passive:true});
    window.addEventListener('resize', closeAll);
  })();
</script>
{% endblock %}
