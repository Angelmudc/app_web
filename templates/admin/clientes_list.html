{% extends 'base.html' %}
{% block title %}Clientes{% endblock %}

{% block content %}
<style>
  :root {
    --bg-color: #0f172a;
    --card-bg: rgba(255, 255, 255, 0.07);
    --text-color: #e2e8f0;
    --accent: #38bdf8;
    --border-color: rgba(255, 255, 255, 0.1);
    --btn-radius: 0.6rem;
  }

  body.light-mode {
    --bg-color: #f3f4f6;
    --card-bg: rgba(255, 255, 255, 0.85);
    --text-color: #1e293b;
    --accent: #2563eb;
    --border-color: rgba(0, 0, 0, 0.08);
  }

  body {
    background: var(--bg-color);
    font-family: 'Poppins', sans-serif;
    color: var(--text-color);
    transition: background 0.4s, color 0.4s;
  }

  .container { max-width: 98%; }
  h1 { color: var(--text-color); font-weight: 600; }

  /* === Bot√≥n de modo === */
  .mode-toggle {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    border-radius: 50%;
    width: 45px; height: 45px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.4s ease; cursor: pointer;
  }
  .mode-toggle:hover { background: var(--accent); color: #fff; }

  /* === Glass Card === */
  .glass-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 1rem;
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
    padding: 1.5rem;
  }

  /* === Tabla === */
  .table { color: var(--text-color); width: 100%; border-collapse: collapse; font-size: 0.98rem; }
  thead th {
    background: rgba(255, 255, 255, 0.1);
    border-bottom: 2px solid var(--border-color);
    text-align: center; padding: 1rem; font-weight: 600;
  }
  tbody tr { background: rgba(255, 255, 255, 0.04); transition: all 0.3s ease; }
  tbody tr:hover { background: rgba(56, 189, 248, 0.15); transform: scale(1.002); }
  td { padding: 1rem; text-align: center; }

  /* === Botones s√≥lidos === */
  .btn { border-radius: var(--btn-radius); font-weight: 500; transition: all 0.3s ease; position: relative; z-index: 2; }
  .btn-sm { padding: 0.4rem 0.7rem; }
  .btn-success { background: #10b981; border: none; color: #fff; }
  .btn-success:hover { background: #059669; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4); }
  .btn-primary { background: #2563eb; border: none; color: #fff; }
  .btn-primary:hover { background: #1d4ed8; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(37, 99, 235, 0.4); }
  .btn-warning { background: #facc15; border: none; color: #000; }
  .btn-warning:hover { background: #eab308; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(250, 204, 21, 0.4); }
  .btn-info { background: #0ea5e9; border: none; color: #fff; }
  .btn-info:hover { background: #0284c7; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(6, 182, 212, 0.4); }
  .btn-outline-secondary { border: 1px solid var(--border-color); color: var(--text-color); }
  .btn-outline-secondary:hover { background: var(--accent); color: #fff; }

  /* === Men√∫ de acciones ‚Äî posici√≥n estable bajo el bot√≥n === */
  .btn-group { position: relative; } /* contenedor de referencia */
  .dropdown-menu {
    min-width: 210px;
    font-size: 0.95rem;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    backdrop-filter: blur(14px);
    border-radius: 0.8rem;
    display: none; opacity: 0;
    transition: opacity 0.15s ease;
    position: absolute;
    top: 110%;            /* justo debajo del bot√≥n */
    left: auto;
    right: 0;             /* alineado al borde derecho del bot√≥n */
    z-index: 20;
  }
  .dropdown-menu.show { display: block; opacity: 1; }

  .dropdown-item { color: var(--text-color); transition: all 0.2s ease; }
  .dropdown-item:hover { background: var(--accent); color: #fff; }

  .dropdown-toggle::after { display: none; }

  /* === Paginaci√≥n === */
  .page-link { background: rgba(255, 255, 255, 0.08); border: 1px solid var(--border-color); color: var(--text-color); }
  .page-item.active .page-link { background: var(--accent); color: #fff; border: none; }

  @media (max-width: 991px) {
    .table thead { display: none; }
    .table, .table tbody, .table tr, .table td { display: block; width: 100%; }
    .table tr { margin-bottom: 1rem; border-radius: 0.75rem; background: rgba(255,255,255,0.08); padding: 1rem; }
    .table td { display: flex; justify-content: space-between; text-align: left; border: none; }
    .table td::before { content: attr(data-label); font-weight: 600; color: var(--accent); }
  }
</style>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <h1 class="h3 mb-0">üë• Clientes</h1>
    <div class="d-flex align-items-center gap-3">
      <div class="btn-group" role="group">
        <a href="{{ url_for('admin.nuevo_cliente') }}" class="btn btn-success"><i class="bi bi-person-plus-fill"></i> Nuevo</a>
        <a href="{{ url_for('admin.listar_solicitudes') }}" class="btn btn-primary"><i class="bi bi-card-list"></i> Solicitudes</a>
        <a href="{{ url_for('admin.acciones_solicitudes_proceso') }}" class="btn btn-warning text-dark"><i class="bi bi-lightning-fill"></i> Pendientes ‚ö°</a>
        <a href="{{ url_for('admin.resumen_diario_clientes') }}" class="btn btn-info"><i class="bi bi-calendar-day-fill"></i> Resumen Hoy üìÖ</a>
      </div>
      <div class="mode-toggle" id="modeToggle">
        <i class="bi bi-sun-fill" id="modeIcon"></i>
      </div>
    </div>
  </div>

  <form class="d-flex mb-4" method="get" action="{{ url_for('admin.listar_clientes') }}">
    <input name="q" class="form-control me-2" placeholder="üîé Buscar por ID, c√≥digo, nombre, email o tel√©fono" value="{{ q }}">
    <button class="btn btn-outline-secondary"><i class="bi bi-search"></i> Buscar</button>
  </form>

  {% if clientes %}
  <div class="glass-card">
    <div class="table-responsive">
      <table class="table table-hover table-striped align-middle">
        <thead>
          <tr>
            <th>#</th>
            <th>üÜî C√≥digo</th>
            <th>üë§ Nombre</th>
            <th>üìß Email</th>
            <th>üìû Tel√©fono</th>
            <th>üèôÔ∏è Ciudad</th>
            <th>üìç Sector</th>
            <th>üìã Solicitudes</th>
            <th>üìÖ Registro</th>
            <th>‚öôÔ∏è Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for c in clientes %}
          <tr>
            <td>{{ c.id }}</td>
            <td>{{ c.codigo }}</td>
            <td>{{ c.nombre_completo }}</td>
            <td>{{ c.email }}</td>
            <td>{{ c.telefono }}</td>
            <td>{{ c.ciudad or '‚Äî' }}</td>
            <td>{{ c.sector or '‚Äî' }}</td>
            <td><span class="badge bg-info text-dark">{{ c.total_solicitudes }}</span></td>
            <td>{{ c.fecha_registro.strftime('%Y-%m-%d') }}</td>
            <td>
              <div class="btn-group">
                <!-- Importante: aria-expanded para accesibilidad -->
                <button type="button"
                        class="btn btn-sm btn-primary elegir-btn"
                        data-id="{{ c.id }}"
                        aria-haspopup="true"
                        aria-expanded="false">
                  Elegir
                </button>
                <ul class="dropdown-menu dropdown-menu-end" id="menu-{{ c.id }}" role="menu" aria-labelledby="elegir-{{ c.id }}">
                  <li><a class="dropdown-item" href="{{ url_for('admin.detalle_cliente', cliente_id=c.id) }}"><i class="bi bi-eye-fill text-info me-2"></i>Ver Detalle</a></li>
                  <li><a class="dropdown-item" href="{{ url_for('admin.editar_cliente', cliente_id=c.id) }}"><i class="bi bi-pencil-fill text-warning me-2"></i>Editar</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <a class="dropdown-item text-danger" href="#" onclick="if(confirm('¬øEliminar cliente #{{ c.id }}?')) document.getElementById('del-{{c.id}}').submit();">
                      <i class="bi bi-trash-fill me-2"></i>Eliminar
                    </a>
                    <form id="del-{{c.id}}" method="post" action="{{ url_for('admin.eliminar_cliente', cliente_id=c.id) }}" style="display:none">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    </form>
                  </li>
                </ul>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
  <div class="alert alert-info glass-card mt-4 text-center p-4">
    <i class="bi bi-info-circle-fill me-2"></i>No se encontraron clientes en la base de datos.
  </div>
  {% endif %}
</div>

<script>
  // === MODO CLARO/OSCURO ===
  (function () {
    const modeToggle = document.getElementById('modeToggle');
    const modeIcon = document.getElementById('modeIcon');
    const body = document.body;
    modeToggle?.addEventListener('click', () => {
      body.classList.toggle('light-mode');
      modeIcon.classList.toggle('bi-sun-fill');
      modeIcon.classList.toggle('bi-moon-fill');
    });
  })();

  // === MEN√öS CONTROLADOS POR CLIC (sin c√°lculos de posici√≥n) ===
  (function () {
    const groups = document.querySelectorAll('.btn-group');

    // Cerrar todos los men√∫s
    function closeAllMenus(except = null) {
      document.querySelectorAll('.dropdown-menu.show').forEach(m => {
        if (m !== except) m.classList.remove('show');
      });
      document.querySelectorAll('.elegir-btn[aria-expanded="true"]').forEach(b => b.setAttribute('aria-expanded', 'false'));
    }

    // Toggle individual
    groups.forEach(group => {
      const btn = group.querySelector('.elegir-btn');
      const menu = group.querySelector('.dropdown-menu');
      if (!btn || !menu) return;

      // Abrir/cerrar
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = menu.classList.contains('show');
        closeAllMenus();
        if (!isOpen) {
          menu.classList.add('show');
          btn.setAttribute('aria-expanded', 'true');
          // Enfocar el primer item para accesibilidad
          const firstItem = menu.querySelector('.dropdown-item, button, a');
          firstItem && firstItem.focus();
        } else {
          menu.classList.remove('show');
          btn.setAttribute('aria-expanded', 'false');
        }
      });

      // Cerrar al presionar Escape dentro del men√∫
      menu.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape') {
          menu.classList.remove('show');
          btn.setAttribute('aria-expanded', 'false');
          btn.focus();
        }
      });
    });

    // Cierre global al hacer clic fuera
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.btn-group')) closeAllMenus();
    });

    // Cerrar al hacer scroll para evitar men√∫s flotantes en otra zona
    window.addEventListener('scroll', () => closeAllMenus());
    window.addEventListener('resize', () => closeAllMenus());
  })();
</script>
{% endblock %}
