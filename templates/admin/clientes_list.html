{% extends 'base.html' %}
{% block title %}Clientes{% endblock %}

{% block content %}
<style>
  :root{
    --bg-color:#0f172a;
    --card-bg:rgba(255,255,255,0.06);
    --text-color:#e2e8f0;
    --accent:#38bdf8;
    --border-color:rgba(255,255,255,0.12);
    --btn-radius:.6rem;
  }
  body.light-mode{
    --bg-color:#f3f4f6;
    --card-bg:#ffffff;
    --text-color:#1e293b;
    --accent:#2563eb;
    --border-color:rgba(0,0,0,.1);
  }
  body{
    background:var(--bg-color);
    font-family:'Poppins',sans-serif;
    color:var(--text-color);
  }

  .container{max-width:98%}
  h1{font-weight:600}

  /* Simplicidad: sin blur para evitar lag */
  .glass-card{
    background:var(--card-bg);
    border:1px solid var(--border-color);
    border-radius:1rem;
    box-shadow:0 6px 14px rgba(0,0,0,.25);
    padding:1.25rem;
  }

  /* Bot√≥n modo */
  .mode-toggle{
    width:45px;height:45px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    background:var(--card-bg);
    border:1px solid var(--border-color);
    color:var(--text-color);
    cursor:pointer;
  }

  /* Tabla ligera (sin transform/scale) */
  .table{width:100%;border-collapse:collapse;font-size:.98rem;color:var(--text-color)}
  thead th{
    background:rgba(255,255,255,.08);
    border-bottom:2px solid var(--border-color);
    text-align:center;padding:1rem;font-weight:600;
  }
  tbody tr{background:rgba(255,255,255,.03)}
  tbody tr:hover{background:rgba(56,189,248,.12)}
  td{padding:1rem;text-align:center;border-bottom:1px solid var(--border-color)}

  /* Botones sin transiciones pesadas */
  .btn{border-radius:var(--btn-radius);font-weight:500}
  .btn-sm{padding:.4rem .7rem}
  .btn-success{background:#10b981;border:none;color:#fff}
  .btn-success:hover{background:#059669}
  .btn-primary{background:#2563eb;border:none;color:#fff}
  .btn-primary:hover{background:#1d4ed8}
  .btn-warning{background:#facc15;border:none;color:#000}
  .btn-warning:hover{background:#eab308}
  .btn-info{background:#0ea5e9;border:none;color:#fff}
  .btn-info:hover{background:#0284c7}
  .btn-outline-secondary{border:1px solid var(--border-color);color:var(--text-color)}
  .btn-outline-secondary:hover{background:var(--accent);color:#fff;border-color:transparent}

  /* Dropdown minimal y estable */
  .btn-group{position:relative}
  .dropdown-menu{
    min-width:210px;
    font-size:.95rem;
    background:var(--card-bg);
    border:1px solid var(--border-color);
    border-radius:.8rem;
    display:none;opacity:1; /* sin fades */
    position:absolute;top:110%;right:0;z-index:20;
    box-shadow:0 10px 20px rgba(0,0,0,.25);
  }
  .dropdown-menu.show{display:block}
  .dropdown-item{color:var(--text-color);padding:.55rem .9rem;display:block;text-decoration:none}
  .dropdown-item:hover{background:var(--accent);color:#fff}
  .dropdown-toggle::after{display:none}

  /* Paginaci√≥n */
  .page-link{background:rgba(255,255,255,.08);border:1px solid var(--border-color);color:var(--text-color)}
  .page-item.active .page-link{background:var(--accent);color:#fff;border:none}

  /* Mobile sin animaciones */
  @media (max-width:991px){
    .table thead{display:none}
    .table,.table tbody,.table tr,.table td{display:block;width:100%}
    .table tr{margin-bottom:1rem;border:1px solid var(--border-color);border-radius:.75rem;background:rgba(255,255,255,.06);padding:.5rem}
    .table td{display:flex;justify-content:space-between;text-align:left;border:none;border-bottom:1px dashed var(--border-color)}
    .table td:last-child{border-bottom:none}
    .table td::before{content:attr(data-label);font-weight:600;color:var(--accent);margin-right:1rem}
  }

  /* Respeta usuarios con reduced motion */
  @media (prefers-reduced-motion:reduce){
    *{animation:none!important;transition:none!important}
  }
</style>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <h1 class="h3 mb-0">üë• Clientes</h1>
    <div class="d-flex align-items-center gap-3">
      <div class="btn-group" role="group">
        <a href="{{ url_for('admin.nuevo_cliente') }}" class="btn btn-success"><i class="bi bi-person-plus-fill"></i> Nuevo</a>
        <a href="{{ url_for('admin.listar_solicitudes') }}" class="btn btn-primary"><i class="bi bi-card-list"></i> Solicitudes</a>
        <a href="{{ url_for('admin.acciones_solicitudes_proceso') }}" class="btn btn-warning text-dark"><i class="bi bi-lightning-fill"></i> Pendientes ‚ö°</a>
        <a href="{{ url_for('admin.resumen_diario_clientes') }}" class="btn btn-info"><i class="bi bi-calendar-day-fill"></i> Resumen Hoy üìÖ</a>
      </div>
      <div class="mode-toggle" id="modeToggle" title="Cambiar modo">
        <i class="bi bi-sun-fill" id="modeIcon"></i>
      </div>
    </div>
  </div>

  <form class="d-flex mb-4" method="get" action="{{ url_for('admin.listar_clientes') }}">
    <input name="q" class="form-control me-2" placeholder="üîé Buscar por ID, c√≥digo, nombre, email o tel√©fono" value="{{ q }}">
    <button class="btn btn-outline-secondary"><i class="bi bi-search"></i> Buscar</button>
  </form>

  {% if clientes %}
  <div class="glass-card">
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>#</th>
            <th>üÜî C√≥digo</th>
            <th>üë§ Nombre</th>
            <th>üìß Email</th>
            <th>üìû Tel√©fono</th>
            <th>üèôÔ∏è Ciudad</th>
            <th>üìç Sector</th>
            <th>üìã Solicitudes</th>
            <th>üìÖ Registro</th>
            <th>‚öôÔ∏è Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for c in clientes %}
          <tr>
            <td data-label="#"> {{ c.id }} </td>
            <td data-label="C√≥digo"> {{ c.codigo }} </td>
            <td data-label="Nombre"> {{ c.nombre_completo }} </td>
            <td data-label="Email"> {{ c.email }} </td>
            <td data-label="Tel√©fono"> {{ c.telefono }} </td>
            <td data-label="Ciudad"> {{ c.ciudad or '‚Äî' }} </td>
            <td data-label="Sector"> {{ c.sector or '‚Äî' }} </td>
            <td data-label="Solicitudes">
              <span class="badge bg-info text-dark">{{ c.total_solicitudes }}</span>
            </td>
            <td data-label="Registro"> {{ c.fecha_registro.strftime('%Y-%m-%d') }} </td>
            <td data-label="Acciones">
              <div class="btn-group">
                <button type="button"
                        class="btn btn-sm btn-primary elegir-btn"
                        data-id="{{ c.id }}"
                        aria-haspopup="true"
                        aria-expanded="false">
                  Elegir
                </button>
                <ul class="dropdown-menu dropdown-menu-end" id="menu-{{ c.id }}" role="menu">
                  <li><a class="dropdown-item" href="{{ url_for('admin.detalle_cliente', cliente_id=c.id) }}"><i class="bi bi-eye-fill text-info me-2"></i>Ver Detalle</a></li>
                  <li><a class="dropdown-item" href="{{ url_for('admin.editar_cliente', cliente_id=c.id) }}"><i class="bi bi-pencil-fill text-warning me-2"></i>Editar</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <a class="dropdown-item text-danger" href="#" onclick="if(confirm('¬øEliminar cliente #{{ c.id }}?')) document.getElementById('del-{{c.id}}').submit();">
                      <i class="bi bi-trash-fill me-2"></i>Eliminar
                    </a>
                    <form id="del-{{c.id}}" method="post" action="{{ url_for('admin.eliminar_cliente', cliente_id=c.id) }}" style="display:none">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    </form>
                  </li>
                </ul>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
  <div class="alert alert-info glass-card mt-4 text-center p-4">
    <i class="bi bi-info-circle-fill me-2"></i>No se encontraron clientes en la base de datos.
  </div>
  {% endif %}
</div>

<script>
  // MODO CLARO/OSCURO (simple, sin animaciones)
  (function(){
    const t=document.getElementById('modeToggle');
    const i=document.getElementById('modeIcon');
    t&&t.addEventListener('click',()=>{
      document.body.classList.toggle('light-mode');
      i.classList.toggle('bi-sun-fill');
      i.classList.toggle('bi-moon-fill');
    });
  })();

  // DROPDOWNS LIGEROS (sin scroll/resize listeners)
  (function(){
    function closeAll(except){
      document.querySelectorAll('.dropdown-menu.show').forEach(m=>{ if(m!==except) m.classList.remove('show'); });
      document.querySelectorAll('.elegir-btn[aria-expanded="true"]').forEach(b=>b.setAttribute('aria-expanded','false'));
    }
    document.querySelectorAll('.btn-group').forEach(g=>{
      const btn=g.querySelector('.elegir-btn'); const menu=g.querySelector('.dropdown-menu');
      if(!btn||!menu) return;
      btn.addEventListener('click',e=>{
        e.stopPropagation();
        const open=menu.classList.contains('show');
        closeAll();
        if(!open){ menu.classList.add('show'); btn.setAttribute('aria-expanded','true'); }
        else{ menu.classList.remove('show'); btn.setAttribute('aria-expanded','false'); }
      });
      menu.addEventListener('keydown',ev=>{
        if(ev.key==='Escape'){ menu.classList.remove('show'); btn.setAttribute('aria-expanded','false'); btn.focus(); }
      });
    });
    document.addEventListener('click',e=>{
      if(!e.target.closest('.btn-group')) closeAll();
    });
  })();
</script>
{% endblock %}
