{% extends 'base.html' %}
{% block title %}Clientes{% endblock %}

{% block content %}

<style>
  /* Caja central para esta pÃ¡gina */
  .clientes-shell{ max-width: 1600px; margin: 0 auto; }
</style>

{# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   PaginaciÃ³n y slice (se calcula aquÃ­ porque la ruta solo envÃ­a `clientes` y `q`)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
{% set page = (request.args.get('page','1')|int if request.args.get('page') else 1) %}
{% set per_page = (request.args.get('per_page','25')|int if request.args.get('per_page') else 25) %}
{% set items = (clientes|list if clientes is iterable else []) %}
{% set total = items|length %}
{% set start = (page-1) * per_page %}
{% set end = start + per_page %}
{% set slice = items[start:end] %}
{% set last_page = (((total-1)//per_page) + 1) if total > 0 else 1 %}

<div class="py-4 clientes-shell">
  <div class="glass-card p-3 p-md-4">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <h1 class="h3 mb-0">ğŸ‘¥ Clientes</h1>
    <div class="d-flex align-items-center gap-3">
      <div class="btn-group" role="group">
        <a href="{{ url_for('admin.nuevo_cliente') }}" class="btn btn-success">
          <i class="fa-solid fa-user-plus"></i> Nuevo
        </a>
        <a href="{{ url_for('admin.listar_solicitudes') }}" class="btn btn-primary">
          <i class="fa-solid fa-rectangle-list"></i> Solicitudes
        </a>
        <a href="{{ url_for('admin.acciones_solicitudes_proceso') }}" class="btn btn-warning text-dark">
          <i class="fa-solid fa-bolt"></i> Pendientes âš¡
        </a>
        <a href="{{ url_for('admin.solicitudes_prioridad') }}" class="btn btn-danger">
          <i class="fa-solid fa-triangle-exclamation"></i> Prioritarias ğŸ”¥
        </a>
        <a href="{{ url_for('admin.resumen_diario_clientes') }}" class="btn btn-info">
          <i class="fa-solid fa-calendar-day"></i> Resumen Hoy ğŸ“…
        </a>
      </div>
    </div>
  </div>

  <form class="row g-2 align-items-center mb-3" method="get" action="{{ url_for('admin.listar_clientes') }}">
    <div class="col-12 col-md">
      <input name="q" class="form-control" placeholder="ğŸ” Buscar por ID, cÃ³digo, nombre, email o telÃ©fono" value="{{ q }}">
    </div>
    <div class="col-6 col-md-auto">
      <select name="per_page" class="form-select">
        {% for n in [10,25,50,100] %}
          <option value="{{n}}" {% if per_page==n %}selected{% endif %}>{{n}} por pÃ¡gina</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-auto">
      <button class="btn btn-outline-secondary w-100">
        <i class="fa-solid fa-magnifying-glass"></i> Buscar
      </button>
    </div>
  </form>

  {% if clientes %}
  <div class="mt-3">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
        <thead>
          <tr>
            <th>#</th>
            <th>ğŸ†” CÃ³digo</th>
            <th>ğŸ‘¤ Nombre</th>
            <th>ğŸ“§ Email</th>
            <th>ğŸ“ TelÃ©fono</th>
            <th>ğŸ™ï¸ Ciudad</th>
            <th>ğŸ“ Sector</th>
            <th>ğŸ“‹ Solicitudes</th>
            <th>ğŸ“… Registro</th>
            <th>âš™ï¸ Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for c in slice %}
          <tr>
            <td data-label="#"> {{ c.id }} </td>
            <td data-label="CÃ³digo">{{ c.codigo }}</td>
            <td data-label="Nombre">{{ c.nombre_completo }}</td>
            <td data-label="Email">{{ c.email }}</td>
            <td data-label="TelÃ©fono">{{ c.telefono }}</td>
            <td data-label="Ciudad">{{ c.ciudad or 'â€”' }}</td>
            <td data-label="Sector">{{ c.sector or 'â€”' }}</td>
            <td data-label="Solicitudes">
              <span class="badge bg-info text-dark">{{ c.total_solicitudes }}</span>
            </td>
            <td data-label="Registro">
              {% if c.fecha_registro %}
                {{ c.fecha_registro.strftime('%Y-%m-%d') }}
              {% else %}
                â€”
              {% endif %}
            </td>
            <td data-label="Acciones">
              <div class="dropdown">
                <button class="btn btn-sm btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Acciones
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" href="{{ url_for('admin.detalle_cliente', cliente_id=c.id) }}">
                      <i class="fa-solid fa-eye text-info me-2"></i>Ver Detalle
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="{{ url_for('admin.editar_cliente', cliente_id=c.id) }}">
                      <i class="fa-solid fa-pen-to-square text-warning me-2"></i>Editar
                    </a>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <a class="dropdown-item text-danger" href="#" onclick="if(confirm('Â¿Eliminar cliente #{{ c.id }}?')) document.getElementById('del-{{c.id}}').submit(); return false;">
                      <i class="fa-solid fa-trash me-2"></i>Eliminar
                    </a>
                    <form id="del-{{c.id}}" method="post" action="{{ url_for('admin.eliminar_cliente', cliente_id=c.id) }}" style="display:none">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    </form>
                  </li>
                </ul>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>

    <!-- PaginaciÃ³n -->
    <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
      <small class="text-muted">
        Mostrando {{ start+1 if total>0 else 0 }}â€“{{ [end, total]|min }} de {{ total }}
      </small>
      <nav>
        <ul class="pagination pagination-sm mb-0">
          {% set q_current = request.args.get('q','') %}
          {% set per = per_page %}
          <li class="page-item {% if page<=1 %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('admin.listar_clientes') }}?q={{ q_current }}&per_page={{ per }}&page={{ page-1 }}">Anterior</a>
          </li>
          <li class="page-item disabled">
            <span class="page-link">PÃ¡gina {{ page }} / {{ last_page }}</span>
          </li>
          <li class="page-item {% if page>=last_page %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('admin.listar_clientes') }}?q={{ q_current }}&per_page={{ per }}&page={{ page+1 }}">Siguiente</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
  {% else %}
  <div class="alert alert-info mt-4 text-center p-4 shadow-sm">
    <i class="fa-solid fa-circle-info me-2"></i>No se encontraron clientes en la base de datos.
  </div>
  {% endif %}
  </div>
</div>

{% endblock %}
