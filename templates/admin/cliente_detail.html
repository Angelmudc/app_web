{% extends 'base.html' %}
{% block title %}Detalle Cliente{% endblock %}

{% block content %}
<div class="container py-4 py-md-5" style="max-width: 1200px;">
  <!-- ===== Encabezado ===== -->
  <div class="d-flex flex-wrap justify-content-between align-items-start align-items-md-center gap-3 mb-4">
    <div class="d-flex align-items-start gap-3">
      <div class="cliente-avatar">
        {{ (cliente.nombre_completo or 'C').strip()[0]|upper }}
      </div>
      <div>
        <h1 class="h3 mb-1">Cliente: {{ cliente.nombre_completo | default('â€”') }}</h1>
        <div class="text-muted small">
          <span class="me-2">
            CÃ³digo:
            <span class="fw-semibold text-info">{{ cliente.codigo | default('â€”') }}</span>
          </span>
          <span class="me-2">
            Registrado:
            {{ cliente.fecha_registro and cliente.fecha_registro.strftime('%Y-%m-%d') or 'â€”' }}
          </span>
          <span>
            Solicitudes:
            <span class="fw-semibold text-light">
              {{ kpi_cliente.total_solicitudes or 0 }}
            </span>
          </span>
        </div>
      </div>
    </div>

    <!-- âœ… ACCIONES HEADER (AQUÃ VA EL BOTÃ“N) -->
    <div class="d-flex flex-wrap gap-2">
      <!-- âœ… NUEVO: Link pÃºblico del cliente (para crear solicitud sin login) -->
      <a href="{{ url_for('admin.generar_link_publico_solicitud', cliente_id=cliente.id) }}"
         class="btn btn-info">
        ğŸ”— Link pÃºblico
      </a>

      <a href="{{ url_for('admin.editar_cliente', cliente_id=cliente.id) }}" class="btn btn-warning">
        âœï¸ <i class="bi bi-pencil-fill ms-1"></i> Editar Cliente
      </a>
      <a href="{{ url_for('admin.listar_clientes') }}" class="btn btn-light">
        â†©ï¸ <i class="bi bi-arrow-left-short ms-1"></i> Volver
      </a>
    </div>
  </div>

  <!-- ===== BOTONES NUEVOS â€” ACCESOS A TAREAS ===== -->
  <div class="d-flex flex-wrap gap-2 mb-4">
    <a href="{{ url_for('admin.tareas_pendientes') }}" class="btn btn-primary">
      ğŸ“‹ Tareas pendientes
    </a>

    <a href="{{ url_for('admin.tareas_hoy') }}" class="btn btn-info">
      ğŸ“… Tareas de hoy
    </a>

    <a href="{{ url_for('admin.crear_tarea_rapida', cliente_id=cliente.id) }}" class="btn btn-warning">
      ğŸ“ Crear tarea completa
    </a>

    <form method="post"
          action="{{ url_for('admin.crear_tarea_rapida', cliente_id=cliente.id) }}"
          class="d-inline">
      {% if csrf_token %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      {% endif %}
      <button type="submit" class="btn btn-success">
        âš¡ Crear tarea rÃ¡pida
      </button>
    </form>
  </div>
  <!-- ===== FIN BOTONES NUEVOS ===== -->

  <!-- ===== Tarjetas de info ===== -->
  <div class="row g-4">
    <!-- InformaciÃ³n general -->
    <div class="col-lg-6">
      <div class="glass-card h-100">
        <div class="glass-header bg-primary">
          <i class="bi bi-person-circle"></i>
          InformaciÃ³n General
        </div>
        <dl class="row card-body mb-0">
          <dt class="col-sm-4">Email</dt>
          <dd class="col-sm-8">{{ cliente.email | default('â€”') }}</dd>

          <dt class="col-sm-4">TelÃ©fono</dt>
          <dd class="col-sm-8">{{ cliente.telefono | default('â€”') }}</dd>

          <dt class="col-sm-4">Ciudad</dt>
          <dd class="col-sm-8">{{ cliente.ciudad | default('â€”') }}</dd>

          <dt class="col-sm-4">Sector</dt>
          <dd class="col-sm-8">{{ cliente.sector | default('â€”') }}</dd>
        </dl>
      </div>
    </div>

    <!-- MÃ©tricas / KPIs -->
    <div class="col-lg-6">
      <div class="glass-card h-100">
        <div class="glass-header bg-info">
          <i class="bi bi-bar-chart-fill"></i>
          MÃ©tricas
        </div>
        <div class="card-body">
          <div class="row text-center mb-3">
            <div class="col-4">
              <div class="h4 mb-0">{{ kpi_cliente.total_solicitudes or 0 }}</div>
              <small class="text-muted">Solicitudes</small>
            </div>
            <div class="col-4">
              <div class="h4 mb-0">
                {% set pagadas = kpi_cliente.estados.pagada or 0 %}
                {{ pagadas }}
              </div>
              <small class="text-muted">Pagadas</small>
            </div>
            <div class="col-4">
              <div class="h4 mb-0">
                {% set activas = kpi_cliente.estados.activa or 0 %}
                {{ activas }}
              </div>
              <small class="text-muted">Activas</small>
            </div>
          </div>

          <hr>

          <div class="row mb-2">
            <div class="col-6">
              <small class="text-muted d-block">En proceso</small>
              <span>{{ kpi_cliente.estados.proceso or 0 }}</span>
            </div>
            <div class="col-6">
              <small class="text-muted d-block">Con reemplazo</small>
              <span>{{ kpi_cliente.estados.reemplazo or 0 }}</span>
            </div>
          </div>

          <div class="row mb-2">
            <div class="col-6">
              <small class="text-muted d-block">Canceladas</small>
              <span>{{ kpi_cliente.estados.cancelada or 0 }}</span>
            </div>
            <div class="col-6">
              <small class="text-muted d-block">Otros estados</small>
              <span>{{ kpi_cliente.estados.otro or 0 }}</span>
            </div>
          </div>

          <hr>

          <div class="mb-2">
            <small class="text-muted d-block">Monto total pagado</small>
            <span class="fw-bold">
              {{ kpi_cliente.monto_total_pagado_str }}
            </span>
          </div>

          <div class="row">
            <div class="col-6">
              <small class="text-muted d-block">Primera solicitud</small>
              {% if kpi_cliente.primera_solicitud %}
                <span>{{ kpi_cliente.primera_solicitud.strftime('%d/%m/%Y') }}</span>
              {% else %}
                <span>â€”</span>
              {% endif %}
            </div>
            <div class="col-6">
              <small class="text-muted d-block">Ãšltima actividad</small>
              {% if kpi_cliente.ultima_actividad %}
                <span>{{ kpi_cliente.ultima_actividad.strftime('%d/%m/%Y %H:%M') }}</span>
              {% else %}
                <span>â€”</span>
              {% endif %}
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- ===== Notas ===== -->
  <div class="glass-card mt-4">
    <div class="glass-header bg-secondary">
      <i class="bi bi-sticky-fill"></i>
      Notas Administrativas
    </div>
    <div class="card-body">
      {% if cliente.notas_admin %}
        <p class="mb-0" style="white-space: pre-wrap;">{{ cliente.notas_admin }}</p>
      {% else %}
        <p class="text-muted mb-0">No hay notas registradas.</p>
      {% endif %}
    </div>
  </div>

  <!-- ===== Tareas de seguimiento ===== -->
  <div class="glass-card mt-4">
    <div class="glass-header bg-warning">
      <i class="bi bi-flag-fill"></i>
      Tareas de seguimiento
    </div>
    <div class="card-body">
      <form method="post"
            action="{{ url_for('admin.crear_tarea_rapida', cliente_id=cliente.id) }}"
            class="d-inline">
        {% if csrf_token %}
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% endif %}
        <button type="submit" class="btn btn-sm btn-warning">
          â• Crear tarea rÃ¡pida para hoy
        </button>
      </form>

      {% if tareas %}
        <h3 class="mt-4 h5">Tareas de seguimiento</h3>
        <ul class="list-group mb-4 mt-2">
          {% for t in tareas %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ t.titulo }}</strong>
                {% if t.fecha_vencimiento %}
                  <small class="text-muted">
                    â€” vence {{ t.fecha_vencimiento.strftime('%d/%m/%Y') }}
                  </small>
                {% endif %}
                {% if t.descripcion %}
                  <div class="small text-muted">{{ t.descripcion }}</div>
                {% endif %}
              </div>
              <span class="badge bg-{% if t.estado == 'completada' %}success{% elif t.estado == 'en_progreso' %}info{% else %}warning{% endif %}">
                {{ t.estado|capitalize }}
              </span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted mt-3 mb-0">
          No hay tareas creadas para este cliente todavÃ­a.
        </p>
      {% endif %}
    </div>
  </div>

  <!-- ===== Solicitudes ===== -->
  <div class="mt-5">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
      <h2 class="h4 mb-0">Solicitudes</h2>
      <a href="{{ url_for('admin.nueva_solicitud_admin', cliente_id=cliente.id) }}" class="btn btn-success">
        â• <i class="bi bi-plus-lg ms-1"></i> Nueva Solicitud
      </a>
    </div>

    {% if solicitudes|length == 0 %}
      <div class="empty-block text-center surface-light">
        <i class="bi bi-inbox fs-3 d-block mb-2"></i>
        AÃºn no hay solicitudes para este cliente.
      </div>
    {% else %}
      <!-- tarjeta opaca clara para contraste perfecto -->
      <div class="table-responsive glass-card surface-light mt-3">
        <div class="glass-header">
          <i class="bi bi-card-checklist"></i>
          Detalles de las Solicitudes
        </div>
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>CÃ³digo</th>
              <th>Fecha</th>
              <th>Ciudad/Sector</th>
              <th>Tipo servicio</th>
              <th>Modalidad</th>
              <th>Plan</th>
              <th>Estado</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for s in solicitudes %}
            <tr>
              <td class="fw-semibold text-primary">{{ s.codigo_solicitud | default('â€”') }}</td>
              <td>
                {% if s.fecha_solicitud %}
                  {{ s.fecha_solicitud.strftime('%Y-%m-%d') }}
                {% else %}
                  â€”
                {% endif %}
              </td>
              <td>{{ s.ciudad_sector | default('â€”') }}</td>

              <!-- ===== TIPO SERVICIO ===== -->
              <td>
                {% set ts = s.tipo_servicio or '' %}
                {% if ts == 'NINERA' %}
                  NiÃ±era
                {% elif ts == 'ENFERMERA' %}
                  Enfermera / Cuidadora
                {% elif ts == 'CHOFER' %}
                  Chofer
                {% elif ts == 'DOMESTICA_LIMPIEZA' or not ts %}
                  DomÃ©stica (limpieza)
                {% else %}
                  {{ ts }}
                {% endif %}
              </td>

              <td>{{ s.modalidad_trabajo | default('â€”') }}</td>
              <td>{{ s.tipo_plan | default('â€”') }}</td>

              <td>
                {% set est = s.estado or '' %}
                {% set badge_class =
                  'bg-secondary' if est == 'proceso' else
                  'bg-primary'   if est == 'activa'  else
                  'bg-success'   if est == 'pagada'  else
                  'bg-warning'   if est == 'cancelada' else
                  'bg-info'      if est == 'reemplazo' else
                  'bg-light'
                %}
                <span class="badge {{ badge_class }}">{{ s.estado | default('â€”') }}</span>
              </td>

              <td class="text-center">
                <div class="actions-grid">
                  <!-- Ver -->
                  <a href="{{ url_for('admin.detalle_solicitud', cliente_id=cliente.id, id=s.id) }}"
                     class="btn btn-sm btn-info" data-bs-toggle="tooltip" title="Ver detalle" aria-label="Ver detalle">
                    ğŸ‘ï¸ <i class="bi bi-eye-fill ms-1"></i><span class="sr-only">Ver</span>
                  </a>

                  <!-- âœ… NUEVO: Link pÃºblico por solicitud (abre el generador y te devuelve el link del cliente) -->
                  <a href="{{ url_for('admin.generar_link_publico_solicitud', cliente_id=cliente.id) }}"
                     class="btn btn-sm btn-primary"
                     data-bs-toggle="tooltip"
                     title="Link pÃºblico (crear solicitud sin login)"
                     aria-label="Link pÃºblico">
                    ğŸ”— <i class="bi bi-link-45deg ms-1"></i><span class="sr-only">Link pÃºblico</span>
                  </a>

                  <!-- Editar -->
                  <a href="{{ url_for('admin.editar_solicitud_admin', cliente_id=cliente.id, id=s.id) }}"
                     class="btn btn-sm btn-warning" data-bs-toggle="tooltip" title="Editar solicitud" aria-label="Editar">
                    âœï¸ <i class="bi bi-pencil-fill ms-1"></i><span class="sr-only">Editar</span>
                  </a>

                  <!-- Plan / Abono -->
                  <a href="{{ url_for('admin.gestionar_plan', cliente_id=cliente.id, id=s.id) }}"
                     class="btn btn-sm btn-primary" data-bs-toggle="tooltip" title="Plan / Abono" aria-label="Plan / Abono">
                    ğŸ’³ <i class="bi bi-credit-card-fill ms-1"></i><span class="sr-only">Plan</span>
                  </a>

                  <!-- Registrar pago -->
                  {% if s.estado in ['activa','proceso'] %}
                  <a href="{{ url_for('admin.registrar_pago', cliente_id=cliente.id, id=s.id) }}?next={{ request.full_path | urlencode }}"
                     class="btn btn-sm btn-success" data-bs-toggle="tooltip" title="Registrar pago" aria-label="Registrar pago">
                    ğŸ’µ <i class="bi bi-cash-stack ms-1"></i><span class="sr-only">Registrar pago</span>
                  </a>
                  {% endif %}

                  <!-- Reemplazo: INICIO -->
                  <a href="{{ url_for('admin.nuevo_reemplazo', s_id=s.id) }}"
                     class="btn btn-sm btn-secondary"
                     data-bs-toggle="tooltip"
                     title="Activar reemplazo (registrar candidata que fallÃ³)"
                     aria-label="Activar reemplazo">
                    ğŸ” <i class="bi bi-arrow-repeat ms-1"></i><span class="sr-only">Activar reemplazo</span>
                  </a>

                  <!-- Reemplazo: FIN -->
                  {% if s.estado == 'reemplazo' and s.reemplazos %}
                    {% set r_ultimo = s.reemplazos[-1] %}
                    <a href="{{ url_for('admin.finalizar_reemplazo', s_id=s.id, reemplazo_id=r_ultimo.id) }}"
                       class="btn btn-sm btn-dark"
                       data-bs-toggle="tooltip"
                       title="Finalizar reemplazo (nueva candidata enviada)"
                       aria-label="Finalizar reemplazo">
                      âœ… <i class="bi bi-check2-circle ms-1"></i><span class="sr-only">Finalizar reemplazo</span>
                    </a>
                  {% endif %}

                  {% if s.candidata_id %}
                    <a href="{{ url_for('admin.ver_compatibilidad', cliente_id=cliente.id, candidata_id=s.candidata_id) }}"
                       class="btn btn-sm btn-dark" data-bs-toggle="tooltip" title="Ver compatibilidad (admin)" aria-label="Compatibilidad admin">
                      ğŸ‘¥ <i class="bi bi-people-fill ms-1"></i><span class="sr-only">Compatibilidad admin</span>
                    </a>

                    <a href="{{ url_for('compat_candidata', fila=s.candidata_id) }}"
                       class="btn btn-sm btn-dark" data-bs-toggle="tooltip" title="Llenar/editar test (SecretarÃ­as)" aria-label="Test SecretarÃ­as">
                      âœ… <i class="bi bi-ui-checks-grid ms-1"></i><span class="sr-only">Test SecretarÃ­as</span>
                    </a>
                  {% else %}
                    <button class="btn btn-sm btn-secondary" disabled
                            data-bs-toggle="tooltip"
                            title="Asigna una candidata para evaluar compatibilidad"
                            aria-label="Compatibilidad deshabilitada">
                      ğŸ‘¥ <i class="bi bi-people-fill ms-1"></i><span class="sr-only">Compatibilidad</span>
                    </button>
                  {% endif %}

                  {% if s.estado in ['activa','proceso','reemplazo'] %}
                    <form method="post"
                          action="{{ url_for('admin.cancelar_solicitud_directa', id=s.id) }}?next={{ request.full_path | urlencode }}"
                          class="d-inline"
                          onsubmit="return confirm('Â¿Cancelar solicitud {{ s.codigo_solicitud }} sin motivo?');">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="btn btn-sm btn-danger" data-bs-toggle="tooltip" title="Cancelar rÃ¡pido (sin motivo)" aria-label="Cancelar rÃ¡pido">
                        â›” <i class="bi bi-x-circle-fill ms-1"></i><span class="sr-only">Cancelar rÃ¡pido</span>
                      </button>
                    </form>

                    <a class="btn btn-sm btn-danger"
                       href="{{ url_for('admin.cancelar_solicitud', cliente_id=cliente.id, id=s.id, next=request.full_path) }}"
                       data-bs-toggle="tooltip" title="Cancelar con motivo" aria-label="Cancelar con motivo">
                      ğŸ›‘ <i class="bi bi-x-octagon ms-1"></i><span class="sr-only">Cancelar con motivo</span>
                    </a>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>

  <!-- ===== Historial de actividad (Timeline) ===== -->
  <div class="glass-card mt-4">
    <div class="glass-header bg-dark">
      <i class="bi bi-clock-history"></i>
      Historial de actividad
    </div>
    <div class="card-body">
      {% if timeline %}
        <ul class="list-unstyled mb-0 timeline">
          {% for e in timeline %}
            <li class="timeline-item">
              <span class="timeline-dot"></span>
              <div class="timeline-content">
                <div class="d-flex justify-content-between align-items-baseline">
                  <strong>{{ e.tipo }}</strong>
                  {% if e.fecha %}
                    <small>{{ e.fecha.strftime('%d/%m/%Y %H:%M') }}</small>
                  {% endif %}
                </div>
                {% if e.detalle %}
                  <div>{{ e.detalle }}</div>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted mb-0">
          AÃºn no hay eventos registrados en el historial de este cliente.
        </p>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}
