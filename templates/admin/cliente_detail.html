{% extends 'base.html' %}
{% block title %}Detalle Cliente{% endblock %}

{% block content %}
<style>
  /* ===== Fondo general ===== */
  body {
    background: radial-gradient(circle at top left, #0f172a, #020617 90%);
    font-family: 'Poppins', sans-serif;
    color: #e2e8f0;
  }

  * { color-scheme: dark; }

  /* Links visibles en dark */
  a { color: #93c5fd; }
  a:hover { color: #bfdbfe; }

  /* Forzar a blanco cualquier texto oscuro heredado por Bootstrap */
  .text-dark, .link-dark { color: #ffffff !important; }
  .text-muted { color: #cbd5e1 !important; }
  .text-light { color: #ffffff !important; }
  .table, .table th, .table td { color: #e2e8f0 !important; }

  /* ===== Tarjetas glass ===== */
  .glass-card {
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 1rem;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
    overflow: hidden;
  }

  /* Variante en SUPERFICIE BLANCA con contraste oscuro */
  .surface-light {
    background: #ffffff !important;
    border: 1px solid rgba(0,0,0,0.08) !important;
  }
  .surface-light .glass-header {
    background: #f8fafc !important;
    border-bottom: 1px solid #e5e7eb !important;
    color: #111827 !important;
  }
  .surface-light .card-body,
  .surface-light .table,
  .surface-light .table th,
  .surface-light .table td,
  .surface-light .text-muted,
  .surface-light p,
  .surface-light dl,
  .surface-light dt,
  .surface-light dd {
    color: #111827 !important;
  }
  .surface-light a { color: #1d4ed8 !important; }
  .surface-light a:hover { color: #1e40af !important; }
  .surface-light .badge.bg-warning { color: #111827 !important; }
  .surface-light .badge.bg-light { background: #111827 !important; color: #ffffff !important; }

  .glass-header {
    background: rgba(255, 255, 255, 0.1);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 0.8rem 1.2rem;
    color: #fff;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }
  .glass-header i { font-size: 1.2rem; color: inherit; }

  .card-body { color: #cbd5e1; }
  .card-body dt { color: #94a3b8; }

  /* ===== Botones ===== */
  .btn { border-radius: 0.6rem; font-weight: 500; }

  .btn-outline-secondary {
    color: #e2e8f0 !important;
    border-color: rgba(255,255,255,0.35) !important;
  }
  .btn-outline-secondary:hover { color: #0f172a !important; background: #e2e8f0 !important; }

  .btn-warning {
    background: linear-gradient(135deg, #facc15, #eab308);
    border: none; color: #ffffff !important;
  }
  .btn-warning:hover { background: linear-gradient(135deg, #fde047, #fbbf24); color: #ffffff !important; }

  .btn-success {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border: none; color: #fff !important;
  }
  .btn-success:hover { background: linear-gradient(135deg, #4ade80, #15803d); color: #fff !important; }

  .btn-light {
    background: rgba(255, 255, 255, 0.15);
    color: #e2e8f0 !important;
    border: 1px solid rgba(255, 255, 255, 0.25);
  }
  .btn-light:hover { background: rgba(255, 255, 255, 0.25); color: #0f172a !important; }

  .btn-info, .btn-primary, .btn-secondary, .btn-danger, .btn-dark {
    color: #fff !important; border: none;
  }
  .btn-info    { background: #0ea5e9; }
  .btn-info:hover { background: #0284c7; }
  .btn-primary { background: #3b82f6; }
  .btn-primary:hover { background: #2563eb; }
  .btn-secondary { background: #475569; }
  .btn-secondary:hover { background: #334155; }
  .btn-dark { background: #0f172a; }
  .btn-dark:hover { background: #0b1324; }

  i.bi { color: inherit; display: inline-block; }

  /* ===== Tablas ===== */
  .table { background: rgba(255, 255, 255, 0.03); }
  .table thead { background: rgba(255, 255, 255, 0.08); color: #f8fafc; }
  .surface-light .table thead { background: #f1f5f9 !important; color: #0f172a !important; }
  .table-hover tbody tr:hover { background: rgba(255, 255, 255, 0.08); transition: 0.2s ease; }
  .surface-light .table-hover tbody tr:hover { background: #f8fafc !important; }

  /* ===== Badges ===== */
  .badge { border-radius: 0.4rem; padding: 0.4em 0.6em; text-transform: capitalize; }
  .badge.bg-light     { background: #94a3b8 !important; color: #0f172a !important; }
  .badge.bg-secondary { background: #475569 !important; color: #ffffff !important; }
  .badge.bg-primary   { background: #3b82f6 !important; color: #ffffff !important; }
  .badge.bg-success   { background: #16a34a !important; color: #ffffff !important; }
  .badge.bg-warning   { background: #facc15 !important; color: #ffffff !important; }
  .badge.bg-info      { background: #0ea5e9 !important; color: #ffffff !important; }

  /* ===== Bloques vac√≠os ===== */
  .empty-block {
    background: rgba(255, 255, 255, 0.05);
    border: 1px dashed rgba(255, 255, 255, 0.15);
    border-radius: 0.8rem;
    padding: 2.5rem;
    color: #94a3b8;
  }
  .surface-light .empty-block {
    background: #ffffff; border-color: #e5e7eb; color: #374151;
  }

  /* ===== Tooltip ===== */
  .tooltip-inner {
    background-color: rgba(30, 41, 59, 0.95);
    color: #f8fafc;
    border-radius: 0.4rem;
    font-size: 0.85rem;
    padding: 0.4rem 0.6rem;
  }

  /* ===== Encabezado Cliente ===== */
  .cliente-avatar {
    background: linear-gradient(135deg, #38bdf8, #3b82f6);
    width: 58px; height: 58px;
    border-radius: 50%;
    font-weight: 700; color: #fff;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.4rem;
  }

  h1, h2, h3 { color: #fff; }

  /* ===== Organizaci√≥n de botones de acciones ===== */
  .actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(38px, 1fr));
    gap: 6px;
    align-items: center;
    justify-content: center;
    min-width: 240px;
  }
  .actions-grid .btn { padding: 0.35rem 0.5rem; line-height: 1; }
  .actions-grid .btn i, .actions-grid .btn .emoji { pointer-events: none; }

  .sr-only {
    position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
    overflow: hidden; clip: rect(0,0,0,0); border: 0;
  }

  /* ===== Timeline ===== */
  .timeline {
    position: relative;
    margin-left: 1.2rem;
    padding-left: 1.2rem;
  }
  .timeline::before {
    content: '';
    position: absolute;
    left: 0.3rem;
    top: 0.4rem;
    bottom: 0.4rem;
    width: 2px;
    background: linear-gradient(to bottom, rgba(148, 163, 184, 0.5), rgba(148, 163, 184, 0.1));
  }
  .timeline-item {
    position: relative;
    margin-bottom: 1.1rem;
  }
  .timeline-dot {
    position: absolute;
    left: -1.15rem;
    top: 0.2rem;
    width: 10px;
    height: 10px;
    border-radius: 999px;
    background: #38bdf8;
    box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.25);
  }
  .timeline-content {
    background: rgba(15, 23, 42, 0.75);
    border-radius: 0.6rem;
    padding: 0.6rem 0.9rem;
    border: 1px solid rgba(148, 163, 184, 0.35);
    font-size: 0.9rem;
  }
  .timeline-content small {
    color: #94a3b8;
  }
</style>

<div class="container py-4 py-md-5" style="max-width: 1200px;">
  <!-- ===== Encabezado ===== -->
  <div class="d-flex flex-wrap justify-content-between align-items-start align-items-md-center gap-3 mb-4">
    <div class="d-flex align-items-start gap-3">
      <div class="cliente-avatar">
        {{ (cliente.nombre_completo or 'C').strip()[0]|upper }}
      </div>
      <div>
        <h1 class="h3 mb-1">Cliente: {{ cliente.nombre_completo | default('‚Äî') }}</h1>
        <div class="text-muted small">
          <span class="me-2">
            C√≥digo:
            <span class="fw-semibold text-info">{{ cliente.codigo | default('‚Äî') }}</span>
          </span>
          <span class="me-2">
            Registrado:
            {{ cliente.fecha_registro and cliente.fecha_registro.strftime('%Y-%m-%d') or '‚Äî' }}
          </span>
          <span>
            Solicitudes:
            <span class="fw-semibold text-light">
              {{ kpi_cliente.total_solicitudes or 0 }}
            </span>
          </span>
        </div>
      </div>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a href="{{ url_for('admin.editar_cliente', cliente_id=cliente.id) }}" class="btn btn-warning">
        ‚úèÔ∏è <i class="bi bi-pencil-fill ms-1"></i> Editar Cliente
      </a>
      <a href="{{ url_for('admin.listar_clientes') }}" class="btn btn-light">
        ‚Ü©Ô∏è <i class="bi bi-arrow-left-short ms-1"></i> Volver
      </a>
    </div>
  </div>

  <!-- ===== BOTONES NUEVOS ‚Äî ACCESOS A TAREAS ===== -->
  <div class="d-flex flex-wrap gap-2 mb-4">
    <a href="{{ url_for('admin.tareas_pendientes') }}" class="btn btn-primary">
      üìã Tareas pendientes
    </a>

    <a href="{{ url_for('admin.tareas_hoy') }}" class="btn btn-info">
      üìÖ Tareas de hoy
    </a>

    <a href="{{ url_for('admin.crear_tarea_rapida', cliente_id=cliente.id) }}" class="btn btn-warning">
      üìù Crear tarea completa
    </a>

    <form method="post"
          action="{{ url_for('admin.crear_tarea_rapida', cliente_id=cliente.id) }}"
          class="d-inline">
      {% if csrf_token %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      {% endif %}
      <button type="submit" class="btn btn-success">
        ‚ö° Crear tarea r√°pida
      </button>
    </form>
  </div>
  <!-- ===== FIN BOTONES NUEVOS ===== -->

  <!-- ===== Tarjetas de info ===== -->
  <div class="row g-4">
    <!-- Informaci√≥n general -->
    <div class="col-lg-6">
      <div class="glass-card h-100">
        <div class="glass-header bg-primary">
          <i class="bi bi-person-circle"></i>
          Informaci√≥n General
        </div>
        <dl class="row card-body mb-0">
          <dt class="col-sm-4">Email</dt>
          <dd class="col-sm-8">{{ cliente.email | default('‚Äî') }}</dd>

          <dt class="col-sm-4">Tel√©fono</dt>
          <dd class="col-sm-8">{{ cliente.telefono | default('‚Äî') }}</dd>

          <dt class="col-sm-4">Ciudad</dt>
          <dd class="col-sm-8">{{ cliente.ciudad | default('‚Äî') }}</dd>

          <dt class="col-sm-4">Sector</dt>
          <dd class="col-sm-8">{{ cliente.sector | default('‚Äî') }}</dd>
        </dl>
      </div>
    </div>

    <!-- M√©tricas / KPIs -->
    <div class="col-lg-6">
      <div class="glass-card h-100">
        <div class="glass-header bg-info">
          <i class="bi bi-bar-chart-fill"></i>
          M√©tricas
        </div>
        <div class="card-body">
          <div class="row text-center mb-3">
            <div class="col-4">
              <div class="h4 mb-0">{{ kpi_cliente.total_solicitudes or 0 }}</div>
              <small class="text-muted">Solicitudes</small>
            </div>
            <div class="col-4">
              <div class="h4 mb-0">
                {% set pagadas = kpi_cliente.estados.pagada or 0 %}
                {{ pagadas }}
              </div>
              <small class="text-muted">Pagadas</small>
            </div>
            <div class="col-4">
              <div class="h4 mb-0">
                {% set activas = kpi_cliente.estados.activa or 0 %}
                {{ activas }}
              </div>
              <small class="text-muted">Activas</small>
            </div>
          </div>

          <hr>

          <div class="row mb-2">
            <div class="col-6">
              <small class="text-muted d-block">En proceso</small>
              <span>{{ kpi_cliente.estados.proceso or 0 }}</span>
            </div>
            <div class="col-6">
              <small class="text-muted d-block">Con reemplazo</small>
              <span>{{ kpi_cliente.estados.reemplazo or 0 }}</span>
            </div>
          </div>

          <div class="row mb-2">
            <div class="col-6">
              <small class="text-muted d-block">Canceladas</small>
              <span>{{ kpi_cliente.estados.cancelada or 0 }}</span>
            </div>
            <div class="col-6">
              <small class="text-muted d-block">Otros estados</small>
              <span>{{ kpi_cliente.estados.otro or 0 }}</span>
            </div>
          </div>

          <hr>

          <div class="mb-2">
            <small class="text-muted d-block">Monto total pagado</small>
            <span class="fw-bold">
              {{ kpi_cliente.monto_total_pagado_str }}
            </span>
          </div>

          <div class="row">
            <div class="col-6">
              <small class="text-muted d-block">Primera solicitud</small>
              {% if kpi_cliente.primera_solicitud %}
                <span>{{ kpi_cliente.primera_solicitud.strftime('%d/%m/%Y') }}</span>
              {% else %}
                <span>‚Äî</span>
              {% endif %}
            </div>
            <div class="col-6">
              <small class="text-muted d-block">√öltima actividad</small>
              {% if kpi_cliente.ultima_actividad %}
                <span>{{ kpi_cliente.ultima_actividad.strftime('%d/%m/%Y %H:%M') }}</span>
              {% else %}
                <span>‚Äî</span>
              {% endif %}
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- ===== Notas ===== -->
  <div class="glass-card mt-4">
    <div class="glass-header bg-secondary">
      <i class="bi bi-sticky-fill"></i>
      Notas Administrativas
    </div>
    <div class="card-body">
      {% if cliente.notas_admin %}
        <p class="mb-0" style="white-space: pre-wrap;">{{ cliente.notas_admin }}</p>
      {% else %}
        <p class="text-muted mb-0">No hay notas registradas.</p>
      {% endif %}
    </div>
  </div>

  <!-- ===== Tareas de seguimiento ===== -->
  <div class="glass-card mt-4">
    <div class="glass-header bg-warning">
      <i class="bi bi-flag-fill"></i>
      Tareas de seguimiento
    </div>
    <div class="card-body">
      <form method="post"
            action="{{ url_for('admin.crear_tarea_rapida', cliente_id=cliente.id) }}"
            class="d-inline">
        {% if csrf_token %}
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% endif %}
        <button type="submit" class="btn btn-sm btn-warning">
          ‚ûï Crear tarea r√°pida para hoy
        </button>
      </form>

      {% if tareas %}
        <h3 class="mt-4 h5">Tareas de seguimiento</h3>
        <ul class="list-group mb-4 mt-2">
          {% for t in tareas %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ t.titulo }}</strong>
                {% if t.fecha_vencimiento %}
                  <small class="text-muted">
                    ‚Äî vence {{ t.fecha_vencimiento.strftime('%d/%m/%Y') }}
                  </small>
                {% endif %}
                {% if t.descripcion %}
                  <div class="small text-muted">{{ t.descripcion }}</div>
                {% endif %}
              </div>
              <span class="badge bg-{% if t.estado == 'completada' %}success{% elif t.estado == 'en_progreso' %}info{% else %}warning{% endif %}">
                {{ t.estado|capitalize }}
              </span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted mt-3 mb-0">
          No hay tareas creadas para este cliente todav√≠a.
        </p>
      {% endif %}
    </div>
  </div>

  <!-- ===== Solicitudes ===== -->
  <div class="mt-5">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
      <h2 class="h4 mb-0">Solicitudes</h2>
      <a href="{{ url_for('admin.nueva_solicitud_admin', cliente_id=cliente.id) }}" class="btn btn-success">
        ‚ûï <i class="bi bi-plus-lg ms-1"></i> Nueva Solicitud
      </a>
    </div>

    {% if solicitudes|length == 0 %}
      <div class="empty-block text-center surface-light">
        <i class="bi bi-inbox fs-3 d-block mb-2"></i>
        A√∫n no hay solicitudes para este cliente.
      </div>
    {% else %}
      <!-- tarjeta opaca clara para contraste perfecto -->
      <div class="table-responsive glass-card surface-light mt-3">
        <div class="glass-header">
          <i class="bi bi-card-checklist"></i>
          Detalles de las Solicitudes
        </div>
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Fecha</th>
              <th>Ciudad/Sector</th>
              <th>Tipo servicio</th>
              <th>Modalidad</th>
              <th>Plan</th>
              <th>Estado</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for s in solicitudes %}
            <tr>
              <td class="fw-semibold text-primary">{{ s.codigo_solicitud | default('‚Äî') }}</td>
              <td>
                {% if s.fecha_solicitud %}
                  {{ s.fecha_solicitud.strftime('%Y-%m-%d') }}
                {% else %}
                  ‚Äî 
                {% endif %}
              </td>
              <td>{{ s.ciudad_sector | default('‚Äî') }}</td>

              <!-- ===== NUEVA COLUMNA: TIPO SERVICIO ===== -->
              <td>
                {% set ts = s.tipo_servicio or '' %}
                {% if ts == 'NINERA' %}
                  Ni√±era
                {% elif ts == 'ENFERMERA' %}
                  Enfermera / Cuidadora
                {% elif ts == 'CHOFER' %}
                  Chofer
                {% elif ts == 'DOMESTICA_LIMPIEZA' or not ts %}
                  Dom√©stica (limpieza)
                {% else %}
                  {{ ts }}
                {% endif %}
              </td>
              <!-- ======================================== -->

              <td>{{ s.modalidad_trabajo | default('‚Äî') }}</td>
              <td>{{ s.tipo_plan | default('‚Äî') }}</td>
              <td>
                {% set est = s.estado or '' %}
                {% set badge_class =
                  'bg-secondary' if est == 'proceso' else
                  'bg-primary'   if est == 'activa'  else
                  'bg-success'   if est == 'pagada'  else
                  'bg-warning'   if est == 'cancelada' else
                  'bg-info'      if est == 'reemplazo' else
                  'bg-light'
                %}
                <span class="badge {{ badge_class }}">{{ s.estado | default('‚Äî') }}</span>
              </td>
              <td class="text-center">
                <!-- Organizaci√≥n en grilla (ic√≥nica) -->
                <div class="actions-grid">
                  <!-- Ver -->
                  <a href="{{ url_for('admin.detalle_solicitud', cliente_id=cliente.id, id=s.id) }}"
                     class="btn btn-sm btn-info" data-bs-toggle="tooltip" title="Ver detalle" aria-label="Ver detalle">
                    üëÅÔ∏è <i class="bi bi-eye-fill ms-1"></i><span class="sr-only">Ver</span>
                  </a>

                  <!-- Editar -->
                  <a href="{{ url_for('admin.editar_solicitud_admin', cliente_id=cliente.id, id=s.id) }}"
                     class="btn btn-sm btn-warning" data-bs-toggle="tooltip" title="Editar solicitud" aria-label="Editar">
                    ‚úèÔ∏è <i class="bi bi-pencil-fill ms-1"></i><span class="sr-only">Editar</span>
                  </a>

                  <!-- Plan / Abono -->
                  <a href="{{ url_for('admin.gestionar_plan', cliente_id=cliente.id, id=s.id) }}"
                     class="btn btn-sm btn-primary" data-bs-toggle="tooltip" title="Plan / Abono" aria-label="Plan / Abono">
                    üí≥ <i class="bi bi-credit-card-fill ms-1"></i><span class="sr-only">Plan</span>
                  </a>

                  <!-- Registrar pago -->
                  {% if s.estado in ['activa','proceso'] %}
                  <a href="{{ url_for('admin.registrar_pago', cliente_id=cliente.id, id=s.id) }}?next={{ request.full_path | urlencode }}"
                     class="btn btn-sm btn-success" data-bs-toggle="tooltip" title="Registrar pago" aria-label="Registrar pago">
                    üíµ <i class="bi bi-cash-stack ms-1"></i><span class="sr-only">Registrar pago</span>
                  </a>
                  {% endif %}

                  <!-- Reemplazo: INICIO -->
                  <a href="{{ url_for('admin.nuevo_reemplazo', s_id=s.id) }}"
                     class="btn btn-sm btn-secondary"
                     data-bs-toggle="tooltip"
                     title="Activar reemplazo (registrar candidata que fall√≥)"
                     aria-label="Activar reemplazo">
                    üîÅ <i class="bi bi-arrow-repeat ms-1"></i><span class="sr-only">Activar reemplazo</span>
                  </a>

                  <!-- Reemplazo: FIN (solo si est√° en estado reemplazo) -->
                  {% if s.estado == 'reemplazo' and s.reemplazos %}
                    {% set r_ultimo = s.reemplazos[-1] %}
                    <a href="{{ url_for('admin.finalizar_reemplazo', s_id=s.id, reemplazo_id=r_ultimo.id) }}"
                       class="btn btn-sm btn-dark"
                       data-bs-toggle="tooltip"
                       title="Finalizar reemplazo (nueva candidata enviada)"
                       aria-label="Finalizar reemplazo">
                      ‚úÖ <i class="bi bi-check2-circle ms-1"></i><span class="sr-only">Finalizar reemplazo</span>
                    </a>
                  {% endif %}

                  {% if s.candidata_id %}
                    <!-- Compatibilidad admin -->
                    <a href="{{ url_for('admin.ver_compatibilidad', cliente_id=cliente.id, candidata_id=s.candidata_id) }}"
                       class="btn btn-sm btn-dark" data-bs-toggle="tooltip" title="Ver compatibilidad (admin)" aria-label="Compatibilidad admin">
                      üë• <i class="bi bi-people-fill ms-1"></i><span class="sr-only">Compatibilidad admin</span>
                    </a>
                    <!-- Test Secretar√≠as -->
                    <a href="{{ url_for('compat_candidata', fila=s.candidata_id) }}"
                       class="btn btn-sm btn-dark" data-bs-toggle="tooltip" title="Llenar/editar test (Secretar√≠as)" aria-label="Test Secretar√≠as">
                      ‚úÖ <i class="bi bi-ui-checks-grid ms-1"></i><span class="sr-only">Test Secretar√≠as</span>
                    </a>
                  {% else %}
                    <button class="btn btn-sm btn-secondary" disabled
                            data-bs-toggle="tooltip"
                            title="Asigna una candidata para evaluar compatibilidad"
                            aria-label="Compatibilidad deshabilitada">
                      üë• <i class="bi bi-people-fill ms-1"></i><span class="sr-only">Compatibilidad</span>
                    </button>
                  {% endif %}

                  {% if s.estado in ['activa','proceso','reemplazo'] %}
                    <!-- Cancelar r√°pido -->
                    <form method="post"
                          action="{{ url_for('admin.cancelar_solicitud_directa', id=s.id) }}?next={{ request.full_path | urlencode }}"
                          class="d-inline"
                          onsubmit="return confirm('¬øCancelar solicitud {{ s.codigo_solicitud }} sin motivo?');">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="btn btn-sm btn-danger" data-bs-toggle="tooltip" title="Cancelar r√°pido (sin motivo)" aria-label="Cancelar r√°pido">
                        ‚õî <i class="bi bi-x-circle-fill ms-1"></i><span class="sr-only">Cancelar r√°pido</span>
                      </button>
                    </form>

                    <!-- Cancelar con motivo -->
                    <a class="btn btn-sm btn-danger"
                       href="{{ url_for('admin.cancelar_solicitud', cliente_id=cliente.id, id=s.id, next=request.full_path) }}"
                       data-bs-toggle="tooltip" title="Cancelar con motivo" aria-label="Cancelar con motivo">
                      üõë <i class="bi bi-x-octagon ms-1"></i><span class="sr-only">Cancelar con motivo</span>
                    </a>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>

  <!-- ===== Historial de actividad (Timeline) ===== -->
  <div class="glass-card mt-4">
    <div class="glass-header bg-dark">
      <i class="bi bi-clock-history"></i>
      Historial de actividad
    </div>
    <div class="card-body">
      {% if timeline %}
        <ul class="list-unstyled mb-0 timeline">
          {% for e in timeline %}
            <li class="timeline-item">
              <span class="timeline-dot"></span>
              <div class="timeline-content">
                <div class="d-flex justify-content-between align-items-baseline">
                  <strong>{{ e.tipo }}</strong>
                  {% if e.fecha %}
                    <small>{{ e.fecha.strftime('%d/%m/%Y %H:%M') }}</small>
                  {% endif %}
                </div>
                {% if e.detalle %}
                  <div>{{ e.detalle }}</div>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted mb-0">
          A√∫n no hay eventos registrados en el historial de este cliente.
        </p>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}
