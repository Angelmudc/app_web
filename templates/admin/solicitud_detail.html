{% extends 'base.html' %}
{% block title %}Detalle Solicitud {{ solicitud.codigo_solicitud }}{% endblock %}

{% block content %}

<div class="container py-5" style="max-width: 1200px;">
  <!-- Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1">
        ğŸ“„ Detalle Solicitud <span class="text-info">{{ solicitud.codigo_solicitud }}</span>
      </h1>
      <div class="text-muted small">
        Estado:
        {% set estado_class = 
          'badge-activa' if solicitud.estado == 'activa' else
          'badge-proceso' if solicitud.estado == 'proceso' else
          'badge-cancelada' if solicitud.estado == 'cancelada' else
          'badge-pagada' if solicitud.estado == 'pagada' else
          'badge-reemplazo' if solicitud.estado == 'reemplazo' else 'bg-secondary'
        %}
        <span class="badge {{ estado_class }}">{{ solicitud.estado }}</span>
      </div>
    </div>
    <a href="{{ url_for('admin.detalle_cliente', cliente_id=solicitud.cliente_id) }}" class="btn btn-secondary">
      <i class="bi bi-arrow-left-circle me-1"></i> Volver al Cliente
    </a>
  </div>

  <!-- InformaciÃ³n general -->
  <div class="glass-card mb-4">
    <div class="glass-header">
      <i class="bi bi-info-circle-fill"></i> InformaciÃ³n General
    </div>
    <dl class="row p-4 mb-0">
      <dt class="col-sm-3">ğŸ“… Fecha Solicitud</dt>
      <dd class="col-sm-9">{{ solicitud.fecha_solicitud.strftime('%Y-%m-%d') }}</dd>

      <dt class="col-sm-3">ğŸ™ï¸ Ciudad / Sector</dt>
      <dd class="col-sm-9">{{ solicitud.ciudad_sector }}</dd>

      <dt class="col-sm-3">âš™ï¸ Modalidad</dt>
      <dd class="col-sm-9">{{ solicitud.modalidad_trabajo }}</dd>

      {% if solicitud.fecha_cancelacion %}
      <dt class="col-sm-3">â›” Fecha CancelaciÃ³n</dt>
      <dd class="col-sm-9">{{ solicitud.fecha_cancelacion.strftime('%Y-%m-%d %H:%M') }}</dd>

      <dt class="col-sm-3">ğŸ’¬ Motivo CancelaciÃ³n</dt>
      <dd class="col-sm-9">{{ solicitud.motivo_cancelacion }}</dd>
      {% endif %}
    </dl>
  </div>

  <!-- ğŸ”¥ Resumen listo para enviar al cliente -->
  <div class="glass-card mb-4">
    <div class="glass-header">
      <i class="bi bi-clipboard-check"></i> Resumen para enviar al cliente
    </div>
    <div class="p-4">
      <p class="small text-muted mb-2">
        Texto organizado con emojis, listo para copiar y pegar en WhatsApp o correo.
      </p>
      <div class="mb-3">
        <textarea id="resumenCliente" class="form-control" rows="12" readonly>{{ resumen_cliente }}</textarea>
      </div>
      <button type="button" class="btn btn-secondary" onclick="copiarResumenCliente()">
        <i class="bi bi-clipboard me-1"></i> Copiar resumen
      </button>
    </div>
  </div>

  <!-- Historial de EnvÃ­os -->
  <div class="glass-card mb-4">
    <div class="glass-header bg-info">
      <i class="bi bi-send-fill"></i> Historial de EnvÃ­os
    </div>
    {% if envios %}
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead>
            <tr>
              <th>ğŸ“¦ Tipo</th>
              <th>ğŸ‘© Candidata</th>
              <th>ğŸ•’ Fecha</th>
            </tr>
          </thead>
          <tbody>
            {% for e in envios %}
            <tr>
              <td>{{ e.tipo }}</td>
              <td>{{ e.candidata.nombre_completo }}</td>
              <td>{{ e.fecha.strftime('%Y-%m-%d %H:%M') }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="empty-block">
        <i class="bi bi-inbox fs-3 d-block mb-2"></i>
        No hay envÃ­os registrados.
      </div>
    {% endif %}
  </div>

  <!-- Cancelaciones -->
  {% if solicitud.estado == 'cancelada' %}
  <div class="glass-card mb-4">
    <div class="glass-header bg-danger">
      <i class="bi bi-x-octagon-fill"></i> Cancelaciones
    </div>
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead>
          <tr>
            <th>#</th>
            <th>ğŸ“… Fecha</th>
            <th>ğŸ’¬ Motivo</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td>{{ solicitud.fecha_cancelacion.strftime('%Y-%m-%d %H:%M') }}</td>
            <td>{{ solicitud.motivo_cancelacion }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <!-- Reemplazos -->
  <div class="glass-card mb-4">
    <div class="glass-header bg-warning text-dark">
      <i class="bi bi-arrow-repeat"></i> Reemplazos
    </div>
    {% if reemplazos %}
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>ğŸ‘© Candidata Fallida</th>
              <th>ğŸ’¬ Motivo</th>
              <th>ğŸ“… Fecha Fallo</th>
              <th>ğŸ¯ Oportunidad</th>
              <th>ğŸš€ Inicio Reemplazo</th>
              <th>ğŸ Fin Reemplazo</th>
              <th>ğŸ‘©â€ğŸ’¼ Candidata Nueva</th>
              <th>ğŸ“ Nota</th>
            </tr>
          </thead>
          <tbody>
            {% for r in reemplazos %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ r.candidata_old.nombre_completo }}</td>
              <td>{{ r.motivo_fallo }}</td>
              <td>{{ r.fecha_fallo.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>{{ 'âœ… SÃ­' if r.oportunidad_nueva else 'âŒ No' }}</td>
              <td>{{ r.fecha_inicio_reemplazo and r.fecha_inicio_reemplazo.strftime('%Y-%m-%d %H:%M') or 'â€”' }}</td>
              <td>{{ r.fecha_fin_reemplazo and r.fecha_fin_reemplazo.strftime('%Y-%m-%d %H:%M') or 'â€”' }}</td>
              <td>{{ r.candidata_new and r.candidata_new.nombre_completo or 'â€”' }}</td>
              <td>{{ r.nota_adicional or 'â€”' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="empty-block">
        <i class="bi bi-emoji-frown fs-3 d-block mb-2"></i>
        No hay reemplazos registrados.
      </div>
    {% endif %}
  </div>

  <div class="text-end mt-4">
    <a href="{{ url_for('admin.detalle_cliente', cliente_id=solicitud.cliente_id) }}" class="btn btn-secondary">
      <i class="bi bi-arrow-left-circle me-1"></i> Volver al Cliente
    </a>
  </div>
</div>

<script>
  function copiarResumenCliente() {
    const textarea = document.getElementById('resumenCliente');
    if (!textarea) return;

    const text = textarea.value;

    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(
        function () { alert('Resumen copiado al portapapeles.'); },
        function () { alert('No se pudo copiar automÃ¡ticamente. Copia el texto manualmente.'); }
      );
    } else {
      textarea.select();
      textarea.setSelectionRange(0, 99999);
      try {
        const ok = document.execCommand('copy');
        if (ok) {
          alert('Resumen copiado al portapapeles.');
        } else {
          alert('No se pudo copiar automÃ¡ticamente. Copia el texto manualmente.');
        }
      } catch (e) {
        alert('No se pudo copiar automÃ¡ticamente. Copia el texto manualmente.');
      }
    }
  }
</script>
{% endblock %}
