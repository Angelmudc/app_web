{% extends 'base.html' %}
{% block title %}{{ 'Nuevo Cliente' if nuevo else 'Editar Cliente' }}{% endblock %}

{% block content %}
<style>
  body {
    background: radial-gradient(circle at top left, #0f172a, #020617 90%);
    font-family: 'Poppins', sans-serif;
    color: #e2e8f0;
  }

  .glass-card {
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 1rem;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
  }

  h1, h2, h3, label {
    color: #fff;
  }

  .form-control, .input-group-text {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.15);
    color: #f8fafc;
  }

  .form-control:focus {
    border-color: #38bdf8;
    box-shadow: 0 0 6px #38bdf8;
    background: rgba(255, 255, 255, 0.12);
  }

  .form-text {
    color: #94a3b8;
  }

  .invalid-feedback {
    color: #f87171;
  }

  .badge {
    background: rgba(59, 130, 246, 0.3);
    color: #93c5fd;
    font-weight: 600;
  }

  .btn {
    border-radius: 0.6rem;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .btn-primary {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    border: none;
  }
  .btn-primary:hover {
    background: linear-gradient(135deg, #60a5fa, #1d4ed8);
  }

  .btn-outline-secondary {
    border-color: rgba(255, 255, 255, 0.2);
    color: #e2e8f0;
  }
  .btn-outline-secondary:hover {
    background: rgba(255, 255, 255, 0.15);
  }

  .btn-light {
    background: rgba(255, 255, 255, 0.15);
    color: #e2e8f0;
    border: 1px solid rgba(255, 255, 255, 0.25);
  }
  .btn-light:hover {
    background: rgba(255, 255, 255, 0.25);
  }

  .alert-danger {
    background: rgba(239, 68, 68, 0.15);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #fecaca;
  }

  .section-icon {
    font-size: 1.2rem;
    color: #60a5fa;
  }

  .divider {
    border-color: rgba(255, 255, 255, 0.1);
  }

  .emoji-title {
    font-size: 1.6rem;
  }
</style>

<div class="container py-4 py-md-5" style="max-width: 960px;">
  <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
    <div>
      <h1 class="h3 mb-1 emoji-title">
        {{ 'üÜï Nuevo Cliente' if nuevo else '‚úèÔ∏è Editar Cliente' }}
      </h1>
      <div class="text-muted small">
        Completa los campos requeridos (<span class="text-danger">*</span>) y guarda los cambios.
      </div>
    </div>
    <a href="{{ url_for('admin.listar_clientes') }}" class="btn btn-light">
      <i class="bi bi-arrow-left-short me-1"></i> Volver
    </a>
  </div>

  <div class="glass-card p-4 p-md-5">
    <form id="cliente-form" method="POST" novalidate>
      {{ cliente_form.hidden_tag() }}

      {% if cliente_form.errors %}
        <div class="alert alert-danger border-0 mb-4" role="alert" aria-live="polite">
          <div class="d-flex">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>
              <strong>Revisa los campos marcados ‚ö†Ô∏è</strong>
              <ul class="mb-0 mt-1">
                {% for field_name, errs in cliente_form.errors.items() %}
                  {% set field = cliente_form._fields.get(field_name) %}
                  {% for e in errs %}
                    <li>
                      <strong>{{ field.label.text if field else field_name }}:</strong> {{ e }}
                    </li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      {% endif %}

      <!-- Identificaci√≥n -->
      <div class="mb-4">
        <h5 class="mb-3"><i class="bi bi-person-badge-fill section-icon"></i> Identificaci√≥n</h5>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">C√≥digo <span class="text-danger">*</span></label>
            {% set has_err = cliente_form.codigo.errors %}
            {{ cliente_form.codigo(
              class="form-control" + (" is-invalid" if has_err else ""),
              placeholder="Ej. CLI-001",
              autocomplete="off",
              readonly=not nuevo
            ) }}
            {% if has_err %}
              <div class="invalid-feedback">{{ cliente_form.codigo.errors[0] }}</div>
            {% endif %}
          </div>

          <div class="col-md-4">
            <label class="form-label">Usuario <span class="text-danger">*</span></label>
            {% set has_err = cliente_form.username.errors %}
            {{ cliente_form.username(
              class="form-control" + (" is-invalid" if has_err else ""),
              placeholder="Ej. juan_perez",
              autocomplete="username"
            ) }}
            {% if has_err %}
              <div class="invalid-feedback">{{ cliente_form.username.errors[0] }}</div>
            {% endif %}
          </div>

          <div class="col-md-4">
            <label class="form-label">Nombre completo <span class="text-danger">*</span></label>
            {% set has_err = cliente_form.nombre_completo.errors %}
            {{ cliente_form.nombre_completo(
              class="form-control" + (" is-invalid" if has_err else ""),
              placeholder="Ej. Juan P√©rez",
              autocomplete="name"
            ) }}
            {% if has_err %}
              <div class="invalid-feedback">{{ cliente_form.nombre_completo.errors[0] }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <hr class="divider my-4">

      <!-- Contacto -->
      <div class="mb-4">
        <h5 class="mb-3"><i class="bi bi-envelope-paper-heart-fill section-icon"></i> Contacto</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Email <span class="text-danger">*</span></label>
            {% set has_err = cliente_form.email.errors %}
            {{ cliente_form.email(
              class="form-control" + (" is-invalid" if has_err else ""),
              placeholder="correo@dominio.com",
              autocomplete="email"
            ) }}
            {% if has_err %}
              <div class="invalid-feedback">{{ cliente_form.email.errors[0] }}</div>
            {% endif %}
          </div>
          <div class="col-md-6">
            <label class="form-label">Tel√©fono <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-telephone"></i></span>
              {% set has_err = cliente_form.telefono.errors %}
              {{ cliente_form.telefono(
                class="form-control" + (" is-invalid" if has_err else ""),
                placeholder="809-123-4567",
                autocomplete="tel"
              ) }}
            </div>
            {% if has_err %}
              <div class="invalid-feedback d-block">{{ cliente_form.telefono.errors[0] }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <hr class="divider my-4">

      <!-- Ubicaci√≥n -->
      <div class="mb-4">
        <h5 class="mb-3"><i class="bi bi-geo-alt-fill section-icon"></i> Ubicaci√≥n</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Ciudad</label>
            {{ cliente_form.ciudad(class="form-control", placeholder="Ej. Santiago") }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Sector</label>
            {{ cliente_form.sector(class="form-control", placeholder="Ej. Los Jardines") }}
          </div>
        </div>
      </div>

      <hr class="divider my-4">

      <!-- Contrase√±a -->
      <div class="mb-4">
        <h5 class="mb-3"><i class="bi bi-shield-lock-fill section-icon"></i> Contrase√±a</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">{{ 'Contrase√±a inicial' if nuevo else 'Nueva contrase√±a' }}</label>
            <div class="input-group">
              {{ cliente_form.password_new(class="form-control", placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢") }}
              <button class="btn btn-outline-secondary" type="button" id="toggle-pass-new"><i class="bi bi-eye"></i></button>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Confirmar contrase√±a</label>
            <div class="input-group">
              {{ cliente_form.password_confirm(class="form-control", placeholder="Repite la contrase√±a") }}
              <button class="btn btn-outline-secondary" type="button" id="toggle-pass-confirm"><i class="bi bi-eye"></i></button>
            </div>
          </div>
        </div>
      </div>

      <hr class="divider my-4">

      <!-- Notas -->
      <div class="mb-4">
        <h5 class="mb-3"><i class="bi bi-journal-text section-icon"></i> Notas administrativas</h5>
        {{ cliente_form.notas_admin(class="form-control", rows=3, placeholder="Observaciones internas...") }}
        <div class="form-text mt-1">üìù M√°ximo 1000 caracteres.</div>
      </div>

      <div class="text-end mt-4">
        <a href="{{ url_for('admin.listar_clientes') }}" class="btn btn-outline-secondary me-2">
          <i class="bi bi-x-circle"></i> Cancelar
        </a>
        <button id="btn-submit" type="submit" class="btn btn-primary">
          <i class="bi bi-save"></i> {{ 'Crear Cliente' if nuevo else 'Guardar Cambios' }}
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const toggle = (btnId, input) => {
    const btn = document.getElementById(btnId);
    if(!btn || !input) return;
    btn.addEventListener('click', () => {
      const isPwd = input.getAttribute('type') === 'password';
      input.setAttribute('type', isPwd ? 'text' : 'password');
      btn.querySelector('i').className = isPwd ? 'bi bi-eye-slash' : 'bi bi-eye';
    });
  };
  toggle('toggle-pass-new', document.getElementById('{{ cliente_form.password_new.id }}'));
  toggle('toggle-pass-confirm', document.getElementById('{{ cliente_form.password_confirm.id }}'));
})();
</script>
{% endblock %}
