{% extends 'base.html' %}
{% block title %}{{ 'Nuevo Cliente' if nuevo else 'Editar Cliente' }}{% endblock %}

{% block content %}

<div class="container py-4 py-md-5" style="max-width: 960px;">
  <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
    <div>
      <h1 class="h3 mb-1 emoji-title">
        {{ '游 Nuevo Cliente' if nuevo else '九勇 Editar Cliente' }}
      </h1>
      <div class="text-muted small">
        Completa los campos requeridos (<span class="text-danger">*</span>) y guarda los cambios.
      </div>
    </div>
    <a href="{{ url_for('admin.listar_clientes') }}" class="btn btn-light">
      <i class="bi bi-arrow-left-short me-1"></i> Volver
    </a>
  </div>

  <div class="glass-card p-4 p-md-5">
    <form id="cliente-form" method="POST" novalidate>
      {{ cliente_form.hidden_tag() }}

      {% if cliente_form.errors %}
        <div class="alert alert-danger border-0 mb-4" role="alert" aria-live="polite">
          <div class="d-flex">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>
              <strong>Revisa los campos marcados 丘멆잺</strong>
              <ul class="mb-0 mt-1">
                {% for field_name, errs in cliente_form.errors.items() %}
                  {% set field = cliente_form._fields.get(field_name) %}
                  {% for e in errs %}
                    <li>
                      <strong>{{ field.label.text if field else field_name }}:</strong> {{ e }}
                    </li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      {% endif %}

      <!-- Identificaci칩n -->
      <div class="mb-4">
        <h5 class="mb-3"><i class="bi bi-person-badge-fill section-icon"></i> Identificaci칩n</h5>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">C칩digo <span class="text-danger">*</span></label>
            {% set has_err = cliente_form.codigo.errors %}
            {{ cliente_form.codigo(
              class="form-control" + (" is-invalid" if has_err else ""),
              placeholder="Ej. CLI-001",
              autocomplete="off",
              readonly=not nuevo
            ) }}
            {% if has_err %}
              <div class="invalid-feedback">{{ cliente_form.codigo.errors[0] }}</div>
            {% endif %}
          </div>

          <div class="col-md-8">
            <label class="form-label">Nombre completo <span class="text-danger">*</span></label>
            {% set has_err = cliente_form.nombre_completo.errors %}
            {{ cliente_form.nombre_completo(
              class="form-control" + (" is-invalid" if has_err else ""),
              placeholder="Ej. Juan P칠rez",
              autocomplete="name"
            ) }}
            {% if has_err %}
              <div class="invalid-feedback">{{ cliente_form.nombre_completo.errors[0] }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <hr class="divider my-4">

      <!-- Contacto -->
      <div class="mb-4">
        <h5 class="mb-3"><i class="bi bi-envelope-paper-heart-fill section-icon"></i> Contacto</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Email <span class="text-danger">*</span></label>
            {% set has_err = cliente_form.email.errors %}
            {{ cliente_form.email(
              class="form-control" + (" is-invalid" if has_err else ""),
              placeholder="correo@dominio.com",
              autocomplete="email"
            ) }}
            {% if has_err %}
              <div class="invalid-feedback">{{ cliente_form.email.errors[0] }}</div>
            {% endif %}
          </div>
          <div class="col-md-6">
            <label class="form-label">Tel칠fono <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-telephone"></i></span>
              {% set has_err = cliente_form.telefono.errors %}
              {{ cliente_form.telefono(
                class="form-control" + (" is-invalid" if has_err else ""),
                placeholder="809-123-4567",
                autocomplete="tel"
              ) }}
            </div>
            {% if has_err %}
              <div class="invalid-feedback d-block">{{ cliente_form.telefono.errors[0] }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <hr class="divider my-4">

      <!-- Credenciales (Portal de clientes) -->
      <div class="mb-4">
        <h5 class="mb-3"><i class="bi bi-shield-lock-fill section-icon"></i> Credenciales</h5>
        <div class="row g-3">

          <div class="col-md-6">
            <label class="form-label">Usuario (opcional)</label>
            {% set has_err = cliente_form.username.errors %}
            {{ cliente_form.username(
              class="form-control" + (" is-invalid" if has_err else ""),
              placeholder="Ej. juan.perez",
              autocomplete="username"
            ) }}
            {% if has_err %}
              <div class="invalid-feedback">{{ cliente_form.username.errors[0] }}</div>
            {% endif %}
            <div class="form-text mt-1">
              Si lo dejas vac칤o, se usar치 el email como usuario.
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Contrase침a (opcional)</label>
            {% set has_err_pw = cliente_form.password.errors %}
            {{ cliente_form.password(
              class="form-control" + (" is-invalid" if has_err_pw else ""),
              placeholder="Solo si deseas habilitar acceso",
              autocomplete="new-password"
            ) }}
            {% if has_err_pw %}
              <div class="invalid-feedback">{{ cliente_form.password.errors[0] }}</div>
            {% endif %}
            <div class="form-text mt-1">
              Si no escribes contrase침a, el cliente NO podr치 iniciar sesi칩n hasta que se le cree una.
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Confirmar contrase침a</label>
            {% set has_err_pw2 = cliente_form.password_confirm.errors %}
            {{ cliente_form.password_confirm(
              class="form-control" + (" is-invalid" if has_err_pw2 else ""),
              placeholder="Repite la contrase침a",
              autocomplete="new-password"
            ) }}
            {% if has_err_pw2 %}
              <div class="invalid-feedback">{{ cliente_form.password_confirm.errors[0] }}</div>
            {% endif %}
          </div>

          <div class="col-md-6 d-flex align-items-end">
            <div class="alert alert-info w-100 mb-0" style="border-radius: 12px;">
              <div class="small">
                <strong>Nota:</strong> Estas credenciales son para el <b>portal privado</b>.
                Si no las llenas, el cliente se guarda igual.
              </div>
            </div>
          </div>

        </div>
      </div>

      <hr class="divider my-4">

      <!-- Ubicaci칩n -->
      <div class="mb-4">
        <h5 class="mb-3"><i class="bi bi-geo-alt-fill section-icon"></i> Ubicaci칩n</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Ciudad</label>
            {{ cliente_form.ciudad(class="form-control", placeholder="Ej. Santiago") }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Sector</label>
            {{ cliente_form.sector(class="form-control", placeholder="Ej. Los Jardines") }}
          </div>
        </div>
      </div>

      <hr class="divider my-4">

      <!-- Notas -->
      <div class="mb-4">
        <h5 class="mb-3"><i class="bi bi-journal-text section-icon"></i> Notas administrativas</h5>
        {{ cliente_form.notas_admin(class="form-control", rows=3, placeholder="Observaciones internas...") }}
        <div class="form-text mt-1">游닇 M치ximo 1000 caracteres.</div>
      </div>

      <div class="text-end mt-4">
        <a href="{{ url_for('admin.listar_clientes') }}" class="btn btn-outline-secondary me-2">
          <i class="bi bi-x-circle"></i> Cancelar
        </a>
        <button id="btn-submit" type="submit" class="btn btn-primary">
          <i class="bi bi-save"></i> {{ 'Crear Cliente' if nuevo else 'Guardar Cambios' }}
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
{% endblock %}
