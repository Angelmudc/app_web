{% extends 'base.html' %}
{% block title %}Cancelar Solicitud {{ solicitud.codigo_solicitud }}{% endblock %}

{% block content %}

<div class="glass-card">
  <div class="d-flex flex-wrap justify-content-between align-items-start align-items-md-center gap-2 mb-4">
    <div>
      <h1 class="h4 mb-1">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
             stroke="currentColor" width="24" height="24" class="me-1 text-danger">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M12 9v3.75m0 3.75h.008M4.5 12a7.5 7.5 0 1115 0 7.5 7.5 0 01-15 0z" />
        </svg>
        Cancelar Solicitud <span class="text-info">({{ solicitud.codigo_solicitud }})</span>
      </h1>
      <div class="small text-muted">
        Esta acción registrará un motivo y cambiará el estado a <span class="fw-semibold text-danger">cancelada</span>.
      </div>
    </div>
    <a href="{{ next_url or url_for('admin.detalle_cliente', cliente_id=solicitud.cliente_id) }}" 
       class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left-short me-1"></i> Volver
    </a>
  </div>

  <div class="card shadow-none border-0 bg-transparent">
    <div class="card-header">
      <i class="bi bi-exclamation-octagon-fill me-2"></i>
      Confirmar cancelación
    </div>

    <div class="card-body px-2 px-md-4 py-4">
      <!-- Resumen -->
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="small text-muted">Código</div>
          <div class="fw-semibold">{{ solicitud.codigo_solicitud }}</div>
        </div>
        <div class="col-md-4">
          <div class="small text-muted">Ciudad / Sector</div>
          <div class="fw-semibold">{{ solicitud.ciudad_sector or '—' }}</div>
        </div>
        <div class="col-md-4">
          <div class="small text-muted">Modalidad</div>
          <div class="fw-semibold">{{ solicitud.modalidad_trabajo or '—' }}</div>
        </div>
        <div class="col-12">
          <div class="small text-muted">Estado actual</div>
          {% set badge_class =
            'bg-secondary' if solicitud.estado == 'proceso' else
            'bg-primary'   if solicitud.estado == 'activa'  else
            'bg-success'   if solicitud.estado == 'pagada'  else
            'bg-warning text-dark' if solicitud.estado == 'cancelada' else
            'bg-info'      if solicitud.estado == 'reemplazo' else
            'bg-light text-dark'
          %}
          <span class="badge {{ badge_class }}">{{ solicitud.estado }}</span>
        </div>
      </div>

      <!-- Aviso -->
      <div class="alert alert-warning d-flex align-items-start gap-2 mb-4">
        <i class="bi bi-info-circle-fill mt-1"></i>
        <div>
          <div class="fw-semibold">Importante</div>
          El motivo quedará guardado en el historial de la solicitud. Esta acción no se puede deshacer desde la interfaz.
        </div>
      </div>

      <!-- Flash messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, msg in messages %}
            <div class="alert alert-{{ 'danger' if category in ['danger','error'] else category }} alert-dismissible fade show">
              {{ msg }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Formulario -->
      <form id="cancel-form"
            method="post"
            action="{{ url_for('admin.cancelar_solicitud', cliente_id=solicitud.cliente_id, id=solicitud.id, next=next_url) }}"
            novalidate>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% if next_url %}
          <input type="hidden" name="next" value="{{ next_url }}">
        {% endif %}

        <div class="mb-4">
          <label for="motivo" class="form-label fw-semibold">Motivo de cancelación</label>
          <textarea id="motivo"
                    name="motivo"
                    class="form-control{% if form and form.motivo and form.motivo.errors %} is-invalid{% endif %}"
                    rows="5"
                    minlength="5"
                    maxlength="500"
                    required
                    placeholder="Describe claramente el motivo. Ej. Cambio de horario, necesidad cubierta por otro medio, etc.">{{ request.form.get('motivo', '') }}</textarea>
          <div class="d-flex justify-content-between mt-2">
            {% if form and form.motivo and form.motivo.errors %}
              <div class="invalid-feedback d-block">
                {{ form.motivo.errors[0] }}
              </div>
            {% else %}
              <div class="form-text">Mínimo 5 y máximo 500 caracteres.</div>
            {% endif %}
            <div class="form-text"><span id="motivo-count">0</span>/500</div>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-3">
          <button id="btn-submit" type="submit" class="btn btn-danger">
            <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
            <i class="bi bi-x-circle-fill me-1"></i> Confirmar cancelación
          </button>
          <a href="{{ next_url or url_for('admin.detalle_cliente', cliente_id=solicitud.cliente_id) }}"
             class="btn btn-outline-secondary">
            Volver sin cancelar
          </a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  // Contador de caracteres y validación adicional
  const motivo = document.getElementById('motivo');
  const out = document.getElementById('motivo-count');
  const form = document.getElementById('cancel-form');
  const btn = document.getElementById('btn-submit');

  const updateCount = () => {
    if (motivo && out) out.textContent = motivo.value.length;
  };

  const validateMotivo = () => {
    const len = motivo.value.trim().length;
    if (len < 5 || len > 500) {
      motivo.classList.add('is-invalid');
      return false;
    }
    motivo.classList.remove('is-invalid');
    return true;
  };

  if (motivo) {
    motivo.addEventListener('input', () => {
      updateCount();
      validateMotivo();
    });
    updateCount();
  }

  if (form && btn) {
    form.addEventListener('submit', (e) => {
      if (!validateMotivo()) {
        e.preventDefault();
        alert('Por favor, escribe un motivo válido (mínimo 5 caracteres).');
        return false;
      }
      const spinner = btn.querySelector('.spinner-border');
      if (spinner) spinner.classList.remove('d-none');
      btn.disabled = true;
    });
  }
})();
</script>
{% endblock %}
