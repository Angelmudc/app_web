{% extends 'base.html' %}
{% block title %}Cancelar Solicitud {{ solicitud.codigo_solicitud }}{% endblock %}

{% block content %}
<div class="container py-4 py-md-5" style="max-width: 920px;">

  <!-- Encabezado -->
  <div class="d-flex flex-wrap justify-content-between align-items-start align-items-md-center gap-2 mb-3">
    <div>
      <h1 class="h4 mb-1">Cancelar Solicitud <span class="text-muted">({{ solicitud.codigo_solicitud }})</span></h1>
      <div class="small text-muted">
        Esta acción registrará un motivo y cambiará el estado a <span class="fw-semibold">cancelada</span>.
      </div>
    </div>
    <a href="{{ next_url or url_for('admin.detalle_cliente', cliente_id=solicitud.cliente_id) }}" class="btn btn-light">
      <i class="bi bi-arrow-left-short me-1"></i> Volver
    </a>
  </div>

  <!-- Tarjeta principal -->
  <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
    <div class="card-header bg-danger text-white d-flex align-items-center gap-2">
      <i class="bi bi-exclamation-octagon-fill fs-5"></i>
      <span>Confirmar cancelación</span>
    </div>

    <div class="card-body p-3 p-md-4 p-lg-5">

      <!-- Resumen de la solicitud -->
      <div class="row g-3 mb-3">
        <div class="col-md-4">
          <div class="small text-muted">Código</div>
          <div class="fw-semibold">{{ solicitud.codigo_solicitud }}</div>
        </div>
        <div class="col-md-4">
          <div class="small text-muted">Ciudad / Sector</div>
          <div class="fw-semibold">{{ solicitud.ciudad_sector or '—' }}</div>
        </div>
        <div class="col-md-4">
          <div class="small text-muted">Modalidad</div>
          <div class="fw-semibold">{{ solicitud.modalidad_trabajo or '—' }}</div>
        </div>
        <div class="col-12">
          <div class="small text-muted">Estado actual</div>
          {% set badge_class =
            'bg-secondary' if solicitud.estado == 'proceso' else
            'bg-primary'   if solicitud.estado == 'activa'  else
            'bg-success'   if solicitud.estado == 'pagada'  else
            'bg-warning text-dark' if solicitud.estado == 'cancelada' else
            'bg-info'      if solicitud.estado == 'reemplazo' else
            'bg-light text-dark'
          %}
          <span class="badge {{ badge_class }}">{{ solicitud.estado }}</span>
        </div>
      </div>

      <!-- Aviso -->
      <div class="alert alert-warning d-flex align-items-start gap-2">
        <i class="bi bi-info-circle-fill mt-1"></i>
        <div>
          <div class="fw-semibold">Importante</div>
          El motivo quedará guardado en el historial de la solicitud. Esta acción no se puede deshacer desde la interfaz.
        </div>
      </div>

      <!-- Flash messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, msg in messages %}
            <div class="alert alert-{{ 'danger' if category in ['danger','error'] else category }} alert-dismissible fade show">
              {{ msg }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Formulario -->
      <form id="cancel-form"
            method="post"
            action="{{ url_for('admin.cancelar_solicitud', cliente_id=solicitud.cliente_id, id=solicitud.id, next=next_url) }}"
            novalidate>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% if next_url %}
          <input type="hidden" name="next" value="{{ next_url }}">
        {% endif %}

        <div class="mb-3">
          <label for="motivo" class="form-label fw-semibold">Motivo de cancelación</label>
          <textarea id="motivo"
                    name="motivo"
                    class="form-control{% if form and form.motivo and form.motivo.errors %} is-invalid{% endif %}"
                    rows="5"
                    maxlength="500"
                    required
                    placeholder="Describe claramente el motivo. Ej. Cambio de horario, necesidad cubierta por otro medio, etc.">{{ request.form.get('motivo', '') }}</textarea>
          <div class="d-flex justify-content-between mt-1">
            {% if form and form.motivo and form.motivo.errors %}
              <div class="invalid-feedback d-block">
                {{ form.motivo.errors[0] }}
              </div>
            {% else %}
              <div class="form-text">Mínimo 5 y máximo 500 caracteres.</div>
            {% endif %}
            <div class="form-text"><span id="motivo-count">0</span>/500</div>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2">
          <button id="btn-submit" type="submit" class="btn btn-danger">
            <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
            <i class="bi bi-x-circle-fill me-1"></i> Confirmar cancelación
          </button>
          <a href="{{ next_url or url_for('admin.detalle_cliente', cliente_id=solicitud.cliente_id) }}"
             class="btn btn-outline-secondary">
            Volver sin cancelar
          </a>
        </div>
      </form>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  // Contador de caracteres del motivo
  const motivo = document.getElementById('motivo');
  const out = document.getElementById('motivo-count');
  function upd() {
    if (motivo && out) out.textContent = motivo.value.length;
  }
  if (motivo) {
    motivo.addEventListener('input', upd);
    upd();
  }

  // Evitar doble envío y mostrar spinner
  const form = document.getElementById('cancel-form');
  const btn = document.getElementById('btn-submit');
  if (form && btn) {
    form.addEventListener('submit', function() {
      const spinner = btn.querySelector('.spinner-border');
      if (spinner) spinner.classList.remove('d-none');
      btn.disabled = true;
    });
  }
})();
</script>
{% endblock %}
