<!-- templates/admin/solicitudes_copiar.html -->
{% extends 'base.html' %}

{% block title %}Copiar Solicitudes{% endblock %}

{% block content %}
<div class="container py-4">
  <h1 class="mb-4">Copiar Solicitudes Disponibles</h1>

  {% if solicitudes %}
    <ul class="list-group mb-4">
      {% for s in solicitudes %}
        <li class="list-group-item position-relative">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong>{{ s.codigo_solicitud }}</strong> — {{ s.ciudad_sector }}

              {# Línea combinada: tipo de lugar, habitaciones, baños y áreas #}
              {% set tipo = s.tipo_lugar_otro if s.tipo_lugar == 'otro' and s.tipo_lugar_otro else s.tipo_lugar %}
              {% set hab = s.habitaciones %}
              {% set ban = s.banos_int %}
              {% set hab_label = 'habitación' if hab == 1 else 'habitaciones' %}
              {% set ban_label = 'baño' if ban == 1 else 'baños' %}
              {% if s.areas %}
                {% if s.areas|length > 1 %}
                  {% set area_text = s.areas[:-1] | join(', ') ~ ' y ' ~ s.areas[-1] %}
                {% else %}
                  {% set area_text = s.areas[0] %}
                {% endif %}
              {% else %}
                {% set area_text = '' %}
              {% endif %}
              <div class="mt-1">
                <small>{{ tipo }}, {{ hab }} {{ hab_label }}, {{ ban }} {{ ban_label }}{% if area_text %}, {{ area_text }}{% endif %}</small>
              </div>

              {# Funciones en línea, si existen #}
              {% if s.funcs %}
                <div><small>{{ s.funcs | join(', ') }}</small></div>
              {% endif %}
            </div>

            <button
              type="button"
              class="btn btn-sm btn-primary copy-btn"
              data-order-text="{{ s.order_text|e }}">
              Copiar
            </button>
          </div>

          {% if s.reemplazos %}
            <div class="mt-2">
              <small class="text-warning">
                Reemplazos pendientes ({{ s.reemplazos|length }}):
                {{ s.reemplazos | map(attribute='candidata_new.nombre_completo') | join(', ') }}
              </small>
            </div>
          {% endif %}

          <form method="post"
                action="{{ url_for('admin.copiar_solicitud', id=s.id) }}"
                class="d-none copy-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          </form>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="alert alert-info">No hay solicitudes pendientes de copia.</div>
  {% endif %}

  <div class="mt-3">
    <a href="{{ url_for('admin.listar_solicitudes') }}"
       class="btn btn-outline-secondary me-2">← Volver al Listado</a>
    <a href="{{ url_for('admin.resumen_solicitudes') }}"
       class="btn btn-link">Resumen de Solicitudes →</a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const text = btn.dataset.orderText;
      navigator.clipboard.writeText(text)
        .then(() => btn.closest('li').querySelector('.copy-form').submit())
        .catch(err => alert('Error al copiar: ' + err));
    });
  });
});
</script>
{% endblock %}
