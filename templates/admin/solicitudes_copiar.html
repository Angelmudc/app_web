{% extends 'base.html' %}
{% block title %}Copiar Solicitudes{% endblock %}

{% block content %}
<div class="container py-4">

  <h1 class="mb-4">Copiar Solicitudes Disponibles</h1>

  {% if solicitudes %}
  <ul class="list-group mb-4">
    {% for s in solicitudes %}
      {# Determinar reemplazos a mostrar #}
      {% if s.estado == 'reemplazo' %}
        {% set reems = s.reemplazos %}
      {% else %}
        {% set reems = s.reemplazos | selectattr('oportunidad_nueva') | list %}
      {% endif %}

      <li class="list-group-item position-relative">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ s.codigo_solicitud }}</strong> ‚Äî
            {{ s.ciudad_sector }} ‚Äî
            {{ s.modalidad_trabajo }} ‚Äî
            Edad: {{ s.edad_requerida }}
          </div>
          <button
            type="button"
            class="btn btn-sm btn-primary copy-btn"
            data-order-text="
Disponible ( {{ s.codigo_solicitud }} )
üìç {{ s.ciudad_sector }}
Ruta m√°s cercana ( {{ s.rutas_cercanas }} )

Modalidad: {{ s.modalidad_trabajo }}

Edad: {{ s.edad_requerida }}
Dominicana
Que sepa leer y escribir
Experiencia en: {{ s.experiencia }}
Horario: {{ s.horario }}

Funciones: {{ s.funciones | join(', ') }}

{{ s.tipo_lugar.title() }} {{ s.habitaciones }} habitaciones, {{ s.banos }} ba√±os{% if s.areas_comunes %}, {{ s.areas_comunes|join(', ') }}{% endif %}.

{% if s.adultos %}{{ s.adultos }} Adultos{% endif %}{% if s.ninos %} y {{ s.ninos }} {% if s.ninos == 1 %}ni√±o{% else %}ni√±as{% endif %}{% if s.edades_ninos %} de {{ s.edades_ninos }}{% endif %}.{% endif %}

Sueldo: ${{ s.sueldo }} mensual{% if s.pasaje_aporte %} pasaje incluido.{% else %} m√°s una ayuda de pasaje.{% endif %}
">
            Copiar
          </button>
        </div>

        {% if reems %}
        <div class="mt-2">
          <small class="text-warning">
            Reemplazos pendientes ({{ reems|length }}):
            {{ reems
               | map(attribute='candidata_new.nombre_completo')
               | join(', ') }}
          </small>
        </div>
        {% endif %}

        <form method="post"
              action="{{ url_for('admin.copiar_solicitud', id=s.id) }}"
              class="d-none copy-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        </form>
      </li>
    {% endfor %}
  </ul>
  {% else %}
    <div class="alert alert-info">No hay solicitudes pendientes de copia.</div>
  {% endif %}

  <div class="mt-3">
    <a href="{{ url_for('admin.listar_solicitudes') }}"
       class="btn btn-outline-secondary me-2">
      ‚Üê Volver al Listado
    </a>
    <a href="{{ url_for('admin.resumen_solicitudes') }}"
       class="btn btn-link">
      Resumen de Solicitudes ‚Üí
    </a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.copy-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const text = btn.getAttribute('data-order-text').trim();
      navigator.clipboard.writeText(text).then(function() {
        btn.closest('li').querySelector('.copy-form').submit();
      }).catch(function(err) {
        alert('Error al copiar al portapapeles: ' + err);
      });
    });
  });
});
</script>
{% endblock %}
