{% extends "base.html" %}
{% block title %}Finalizar Proceso ‚Äì {{ candidata.nombre_completo }}{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- ENCABEZADO -->
  <div class="d-flex align-items-center justify-content-between mb-4 flex-wrap gap-2">
    <div>
      <h1 class="h4 mb-1 d-flex align-items-center gap-2">
        <i class="fa-solid fa-user-check"></i> Finalizar Proceso
      </h1>
      <small class="text-muted">
        √öltima actualizaci√≥n:
        {% if candidata.fecha_cambio_estado %}
          {{ candidata.fecha_cambio_estado.strftime("%Y-%m-%d %H:%M") }}
        {% else %}‚Äî{% endif %}
      </small>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('finalizar_proceso_buscar') }}" class="btn btn-outline-secondary btn-sm">
        <i class="fa-solid fa-rotate-left me-1"></i> Volver a buscar
      </a>
      <a href="{{ url_for('candidata_ver_perfil', fila=candidata.fila) }}" class="btn btn-outline-primary btn-sm" target="_blank">
        <i class="fa-regular fa-eye me-1"></i> Ver perfil
      </a>
    </div>
  </div>

  <!-- INFO CANDIDATA -->
  <div class="card shadow-sm mb-4">
    <div class="card-body d-flex flex-wrap align-items-center gap-4">

      <!-- Foto -->
      <div class="rounded border p-1" style="width:100px;height:100px;overflow:hidden;background:#f8f9fa;">
        {% if candidata.foto_perfil or candidata.perfil %}
          <img src="{{ url_for('perfil_candidata', fila=candidata.fila) }}"
               alt="Foto de {{ candidata.nombre_completo }}"
               class="w-100 h-100" style="object-fit:cover;">
        {% else %}
          <div class="w-100 h-100 d-flex align-items-center justify-content-center text-muted small">Sin foto</div>
        {% endif %}
      </div>

      <!-- Detalles -->
      <div class="flex-grow-1">
        <div class="fw-semibold d-flex align-items-center flex-wrap gap-2">
          {{ candidata.nombre_completo }}
          <span class="text-muted">#{{ candidata.fila }}</span>
          <button type="button" class="btn btn-link btn-sm p-0" data-copy="{{ candidata.fila }}" title="Copiar fila">üìã</button>
        </div>

        <div class="small text-muted mt-1 d-flex flex-wrap gap-3">
          {% if candidata.cedula %}
            <span>C√©dula: <strong>{{ candidata.cedula }}</strong></span>
            <button type="button" class="btn btn-link btn-sm p-0" data-copy="{{ candidata.cedula }}" title="Copiar c√©dula">üìã</button>
          {% endif %}
          {% if candidata.codigo %}
            <span>C√≥digo: <strong>{{ candidata.codigo }}</strong></span>
            <button type="button" class="btn btn-link btn-sm p-0" data-copy="{{ candidata.codigo }}" title="Copiar c√≥digo">üìã</button>
          {% endif %}
          {% if candidata.direccion_completa %}
            <span>Ciudad/Sector: <strong>{{ candidata.direccion_completa }}</strong></span>
          {% endif %}
        </div>

        <div class="mt-2 d-flex flex-wrap gap-2">
          {% if candidata.estado %}
            <span class="badge bg-primary-subtle text-primary border">{{ candidata.estado|replace("_"," ") }}</span>
          {% endif %}
          <span class="badge {{ (candidata.foto_perfil or candidata.perfil) and 'bg-success' or 'bg-secondary' }}">
            Foto {{ (candidata.foto_perfil or candidata.perfil) and 'cargada' or 'pendiente' }}
          </span>
          <span class="badge {{ candidata.cedula1 and 'bg-success' or 'bg-secondary' }}">
            C√©dula frente {{ candidata.cedula1 and 'cargada' or 'pendiente' }}
          </span>
          <span class="badge {{ candidata.cedula2 and 'bg-success' or 'bg-secondary' }}">
            C√©dula reverso {{ candidata.cedula2 and 'cargada' or 'pendiente' }}
          </span>
        </div>
      </div>

      <!-- Experiencia -->
      {% if candidata.anos_experiencia or candidata.areas_experiencia %}
      <div class="text-end small">
        {% if candidata.anos_experiencia %}
          A√±os exp.: <strong>{{ candidata.anos_experiencia }}</strong>
        {% endif %}
        {% if candidata.areas_experiencia %}
          <span class="ms-3">√Åreas: <strong>{{ candidata.areas_experiencia }}</strong></span>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>

  <!-- FORMULARIO -->
  <form method="post" action="{{ url_for('finalizar_proceso', fila=candidata.fila) }}" enctype="multipart/form-data" id="finalizar-form" novalidate>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <!-- Documentos -->
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <i class="fa-solid fa-folder-open me-2"></i> Documentos obligatorios
      </div>
      <div class="card-body">
        <div class="row gy-4">
          {% for campo, label, preview in [
            ('foto_perfil', 'Foto de perfil', 'preview_foto'),
            ('cedula1', 'C√©dula (frontal)', 'preview_ced1'),
            ('cedula2', 'C√©dula (reverso)', 'preview_ced2')
          ] %}
          <div class="col-md-4">
            <label for="{{ campo }}" class="form-label">{{ label }} <span class="text-danger">*</span></label>
            <input class="form-control" type="file" id="{{ campo }}" name="{{ campo }}" accept="image/*" required>
            <div class="form-text">Formatos JPG/PNG ‚Ä¢ M√°x. 1.5 MB</div>
            <div class="ratio ratio-1x1 border rounded mt-2" id="{{ preview }}" style="background:#f8f9fa;"></div>
            <div class="invalid-feedback">Sube {{ label|lower }}.</div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Grupos -->
    <div class="card shadow-sm mt-4">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <span><i class="fa-solid fa-users me-2"></i> Grupos de empleo</span>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-check-all">Seleccionar todo</button>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-clear-all">Limpiar</button>
        </div>
      </div>
      <div class="card-body">
        {% if grupos %}
        <div class="row">
          {% for grupo in grupos %}
          <div class="col-sm-6 col-lg-4 mb-2">
            <div class="form-check">
              <input class="form-check-input grupo-item" type="checkbox" name="grupos_empleo"
                     id="grupo_{{ loop.index }}" value="{{ grupo }}"
                     {% if candidata.grupos_empleo and (grupo in candidata.grupos_empleo) %}checked{% endif %}>
              <label class="form-check-label" for="grupo_{{ loop.index }}">{{ grupo }}</label>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
          <div class="alert alert-info mb-0">No hay grupos configurados.</div>
        {% endif %}
      </div>
    </div>

    <!-- BOTONES -->
    <div class="d-flex align-items-center justify-content-between mt-4 flex-wrap gap-2">
      <small class="text-muted">
        Al guardar, se validan los tres archivos obligatorios. Si todo est√° correcto, la candidata pasa a
        <strong>lista_para_trabajar</strong>.
      </small>
      <div class="d-flex gap-2">
        <a href="{{ url_for('finalizar_proceso_buscar') }}" class="btn btn-outline-secondary">
          <i class="fa-solid fa-xmark me-1"></i> Cancelar
        </a>
        <button type="submit" class="btn btn-success" id="btn-submit">
          <span class="spinner-border spinner-border-sm me-1 d-none" id="btn-spinner"></span>
          <i class="fa-solid fa-check me-1"></i> Guardar y Finalizar
        </button>
      </div>
    </div>
  </form>
</div>

<!-- JS -->
<script>
(function() {
  function bindPreview(idInput, idPreview) {
    const input = document.getElementById(idInput);
    const preview = document.getElementById(idPreview);
    if (!input || !preview) return;
    input.addEventListener('change', e => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        preview.innerHTML = '';
        const img = document.createElement('img');
        img.src = ev.target.result;
        img.className = 'w-100 h-100';
        img.style.objectFit = 'cover';
        preview.appendChild(img);
      };
      reader.readAsDataURL(file);
    });
  }

  ['foto_perfil','cedula1','cedula2'].forEach((id,i)=>{
    bindPreview(id, ['preview_foto','preview_ced1','preview_ced2'][i]);
  });

  // Seleccionar / Limpiar grupos
  document.getElementById('btn-check-all')?.addEventListener('click', () => {
    document.querySelectorAll('.grupo-item').forEach(cb => cb.checked = true);
  });
  document.getElementById('btn-clear-all')?.addEventListener('click', () => {
    document.querySelectorAll('.grupo-item').forEach(cb => cb.checked = false);
  });

  // Copiar valores
  document.addEventListener('click', e => {
    const btn = e.target.closest('[data-copy]');
    if (!btn) return;
    const val = btn.getAttribute('data-copy');
    navigator.clipboard?.writeText(val);
    btn.textContent = '‚úî';
    setTimeout(() => btn.textContent = 'üìã', 900);
  });

  // Validaci√≥n + Spinner
  const form = document.getElementById('finalizar-form');
  const btn = document.getElementById('btn-submit');
  const spinner = document.getElementById('btn-spinner');
  const MAX_BYTES = 3 * 1024 * 1024;

  form?.addEventListener('submit', e => {
    if (!form.checkValidity()) {
      e.preventDefault(); e.stopPropagation();
      form.classList.add('was-validated');
      return;
    }
    for (const id of ['foto_perfil','cedula1','cedula2']) {
      const f = document.getElementById(id)?.files?.[0];
      if (f && f.size > MAX_BYTES) {
        alert(`El archivo "${f.name}" supera los 3 MB. Reduce el tama√±o.`);
        e.preventDefault(); e.stopPropagation();
        return;
      }
    }
    spinner.classList.remove('d-none');
    btn.disabled = true;
  });
})();
</script>
{% endblock %}
