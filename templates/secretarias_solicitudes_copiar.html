{% extends 'base.html' %}
{% block title %}Publicar solicitudes (Secretarias){% endblock %}
{% block content %}
<div class="container py-4" style="max-width: 1200px;">

  <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <h1 class="h5 mb-0">
      {% if q_enabled %}Buscar solicitudes{% else %}Solicitudes para publicar hoy{% endif %}
      (<span id="solic-count">{{ solicitudes|length }}</span>)
    </h1>

    {% if q_enabled %}
    <form class="d-flex" method="get" action="{{ url_for(endpoint) }}">
      <input class="form-control form-control-sm me-2" type="text" name="q"
             placeholder="Buscar por código o ciudad/sector" value="{{ q or '' }}">
      <button class="btn btn-sm btn-outline-primary" type="submit">Buscar</button>
      {% if q %}<a class="btn btn-sm btn-link" href="{{ url_for(endpoint) }}">Limpiar</a>{% endif %}
    </form>
    {% endif %}
  </div>

  {% if q_enabled %}
  <div class="alert alert-secondary py-2">
    <div class="small m-0">
      <span class="badge bg-success">Copiable</span> = no copiada en el ciclo vigente (desde 1:00 AM) ·
      <span class="badge bg-secondary">Copiada (ciclo)</span> = ya marcada en este ciclo (se mostrará nuevamente después de la 1:00 AM)
    </div>
  </div>
  {% endif %}

  {% if solicitudes and solicitudes|length > 0 %}
    <div class="table-responsive">
      <table class="table table-hover align-middle table-sm" id="tabla-solicitudes">
        <thead class="table-light">
          <tr>
            <th style="width: 110px;">Código</th>
            <th>Ciudad / Sector</th>
            <th>Modalidad</th>
            <th style="width: 160px;">Estado</th>
            <th style="width: 240px;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for s in solicitudes %}
          <tr id="row-{{ s.id }}">
            <td class="fw-semibold">{{ s.codigo_solicitud }}</td>
            <td>{{ s.ciudad_sector }}</td>
            <td>{{ s.modalidad }}</td>
            <td>
              {% if s.copiada_hoy %}
                <span class="badge bg-secondary">Copiada (ciclo)</span>
              {% else %}
                <span class="badge bg-success">Copiable</span>
              {% endif %}
            </td>
            <td class="d-flex gap-2">
              <button type="button"
                      class="btn btn-sm btn-outline-secondary"
                      onclick="toggleTexto({{ s.id }})">
                Ver texto
              </button>

              <button class="btn btn-sm btn-outline-primary"
                      type="button"
                      data-id="{{ s.id }}"
                      data-url="{{ url_for('secretarias_copiar_solicitud', id=s.id) }}"
                      onclick="copiarYMarcar(this)">
                Copiar texto
              </button>
            </td>
          </tr>
          <tr id="detail-{{ s.id }}">
            <td colspan="5">
              <pre id="t{{ s.id }}" hidden
                   class="p-3 rounded-3 border bg-light"
                   style="white-space: pre-wrap; user-select: text; font-size: .925rem;">{{ s.order_text }}</pre>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-info">
      {% if q_enabled %}No hay resultados.{% else %}No hay solicitudes pendientes de publicar en este ciclo.{% endif %}
    </div>
  {% endif %}
</div>

<script>
  function toggleTexto(id) {
    const el = document.getElementById('t' + id);
    if (el) el.hidden = !el.hidden;
  }

  async function copiarYMarcar(btn) {
    const id   = btn.getAttribute('data-id');
    const url  = btn.getAttribute('data-url');
    const pre  = document.getElementById('t' + id);
    if (!pre) return;

    const texto = pre.innerText.trim();
    if (!texto) return;

    // UI feedback rápido
    const original = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Copiando...';

    try {
      // 1) Copiar al portapapeles
      await navigator.clipboard.writeText(texto);
      btn.textContent = 'Marcando...';

      // 2) Marcar en el servidor (AJAX)
      const form = new URLSearchParams();
      // Si usas CSRF, Flask-WTF suele exponer csrf_token() en las plantillas:
      {% if csrf_token %}
      form.append('csrf_token', '{{ csrf_token() }}');
      {% endif %}

      const resp = await fetch(url, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: form
      });

      if (!resp.ok) throw new Error('Error al marcar');

      // 3) Quitar la fila del DOM y actualizar contador
      const row    = document.getElementById('row-' + id);
      const detail = document.getElementById('detail-' + id);
      if (row) row.remove();
      if (detail) detail.remove();

      const countEl = document.getElementById('solic-count');
      if (countEl) {
        const n = Math.max(0, parseInt(countEl.textContent || '0', 10) - 1);
        countEl.textContent = String(n);
      }

      // 4) Feedback final
      btn.textContent = 'Copiado ✓';
    } catch (e) {
      console.error(e);
      btn.textContent = 'Error';
      alert('No se pudo copiar o marcar. Reintenta.');
      setTimeout(() => { btn.textContent = original; btn.disabled = false; }, 1200);
      return;
    }

    // Rehabilitar botón por si deshaces/recargas
    setTimeout(() => { btn.disabled = false; }, 400);
  }
</script>
{% endblock %}
