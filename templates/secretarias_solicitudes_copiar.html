{% extends 'base.html' %}
{% block title %}Publicar solicitudes (Secretarias){% endblock %}
{% block content %}
<div class="container py-4" style="max-width: 1200px;">

  <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <h1 class="h5 mb-0">
      {% if q_enabled %}Buscar solicitudes{% else %}Solicitudes para publicar hoy{% endif %}
      ({{ solicitudes|length }})
    </h1>

    {% if q_enabled %}
    <form class="d-flex" method="get" action="{{ url_for(endpoint) }}">
      <input class="form-control form-control-sm me-2" type="text" name="q"
             placeholder="Buscar por código o ciudad/sector" value="{{ q or '' }}">
      <button class="btn btn-sm btn-outline-primary" type="submit">Buscar</button>
      {% if q %}<a class="btn btn-sm btn-link" href="{{ url_for(endpoint) }}">Limpiar</a>{% endif %}
    </form>
    {% endif %}
  </div>

  {% if q_enabled %}
  <div class="alert alert-secondary py-2">
    <div class="small m-0">
      <span class="badge bg-success">Copiable</span> = no copiada en el ciclo vigente (desde 1:00 AM) ·
      <span class="badge bg-secondary">Copiada (ciclo)</span> = ya marcada en este ciclo (se mostrará nuevamente después de la 1:00 AM)
    </div>
  </div>
  {% endif %}

  {% if solicitudes and solicitudes|length > 0 %}
    <div class="table-responsive">
      <table class="table table-hover align-middle table-sm">
        <thead class="table-light">
          <tr>
            <th style="width: 110px;">Código</th>
            <th>Ciudad / Sector</th>
            <th>Modalidad</th>
            <th style="width: 160px;">Estado</th>
            <th style="width: 220px;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for s in solicitudes %}
          <tr>
            <td class="fw-semibold">{{ s.codigo_solicitud }}</td>
            <td>{{ s.ciudad_sector }}</td>
            <td>{{ s.modalidad }}</td>
            <td>
              {% if s.copiada_hoy %}
                <span class="badge bg-secondary">Copiada (ciclo)</span>
              {% else %}
                <span class="badge bg-success">Copiable</span>
              {% endif %}
            </td>
            <td class="d-flex gap-2">
              <button type="button"
                      class="btn btn-sm btn-outline-secondary"
                      onclick="const el=document.getElementById('t{{ s.id }}'); el.hidden=!el.hidden;">
                Ver texto
              </button>

              <button class="btn btn-sm btn-outline-primary"
                      type="button"
                      onclick="navigator.clipboard?.writeText(document.getElementById('t{{ s.id }}').innerText)
                               .then(()=>this.textContent='Copiado')
                               .catch(()=>{});">
                Copiar texto
              </button>

              <form method="post" action="{{ url_for('secretarias_copiar_solicitud', id=s.id) }}">
                <button class="btn btn-sm btn-primary"
                        type="submit" {% if s.copiada_hoy and not q_enabled %}disabled title="Ya copiada en este ciclo"{% endif %}>
                  Marcar hoy
                </button>
              </form>
            </td>
          </tr>
          <tr>
            <td colspan="5">
              <pre id="t{{ s.id }}" hidden
                   class="p-3 rounded-3 border bg-light"
                   style="white-space: pre-wrap; user-select: text; font-size: .925rem;">{{ s.order_text }}</pre>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-info">
      {% if q_enabled %}No hay resultados.{% else %}No hay solicitudes pendientes de publicar en este ciclo.{% endif %}
    </div>
  {% endif %}
</div>
{% endblock %}
