{# templates/inscripcion.html #}
{% extends "base.html" %}
{% block title %}Inscripci√≥n de Candidatas{% endblock %}

{% block content %}
<div class="container py-4">

  {# ---------- ENCABEZADO ---------- #}
  <section class="hero-section">
    <h1 class="h3 mb-1">üìù Inscripci√≥n de Candidatas</h1>
    <p class="text-muted mb-0">
      Busca una candidata y registra su <strong>medio</strong>, <strong>estado</strong>, <strong>monto</strong> y <strong>fecha</strong> de inscripci√≥n.
    </p>
  </section>

  {# ---------- MENSAJES (adem√°s de toasts globales) ---------- #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mt-3">
        {% for category, msg in messages %}
          <div class="alert alert-{{ 'success' if category=='success' else 'danger' }} alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {# =================================================================== #}
  {# ============================  BUSCAR  ============================== #}
  {# =================================================================== #}
  <div class="card mt-3">
    <div class="card-body">
      <form method="get" action="{{ url_for('inscripcion') }}" class="row g-2 align-items-end" novalidate>
        <!-- CSRF (aunque es GET, lo dejamos por consistencia con el resto del sitio) -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="col-12 col-md-8">
          <label for="buscar" class="form-label mb-1">Buscar por nombre, c√©dula o tel√©fono</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
            <input
              type="text"
              id="buscar"
              name="buscar"
              class="form-control"
              placeholder="Ejemplo: √Ångel / 00100200345 / 809-000-0000"
              value="{{ request.args.get('buscar','') }}"
              required
              autocomplete="off">
            {% if request.args.get('buscar') %}
              <a class="btn btn-outline-secondary" href="{{ url_for('inscripcion') }}">
                <i class="fa-solid fa-rotate-left me-1"></i>Limpiar
              </a>
            {% endif %}
            <button class="btn btn-primary" type="submit">
              <i class="fa-solid fa-search me-1"></i>Buscar
            </button>
          </div>
          <div class="form-text">Tip: pega la c√©dula sin guiones; igual la encontramos.</div>
        </div>
      </form>
    </div>
  </div>

  {# ======================= LISTA DE RESULTADOS ======================= #}
  {% if resultados %}
    <div class="card mt-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-semibold"><i class="fa-solid fa-list-ul me-2"></i>Resultados</span>
        <span class="badge-soft">{{ resultados|length }} registro{{ resultados|length != 1 and 's' or '' }}</span>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle m-0" id="tabla-inscripcion-resultados">
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Nombre</th>
                <th>C√©dula</th>
                <th>Tel√©fono</th>
                <th style="width:140px" class="text-center">Acci√≥n</th>
              </tr>
            </thead>
            <tbody>
              {% for c in resultados %}
              <tr>
                <td>
                  {% if c.codigo %}
                    <span class="badge-soft">{{ c.codigo }}</span>
                  {% else %}
                    <span class="text-muted">‚Äî</span>
                  {% endif %}
                </td>
                <td class="fw-semibold">{{ c.nombre_completo }}</td>
                <td>{{ c.cedula }}</td>
                <td>{{ c.numero_telefono or '‚Äî' }}</td>
                <td class="text-center">
                  <a href="{{ url_for('inscripcion', candidata_seleccionada=c.fila) }}"
                     class="btn btn-sm btn-outline-primary"
                     title="Ver detalles">
                    <i class="fa-solid fa-eye me-1"></i>Ver
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}

  {# =================================================================== #}
  {# ===================== DETALLE + FORMULARIO ======================== #}
  {# =================================================================== #}
  {% if candidata %}
    <div class="card mt-4">
      <div class="card-header d-flex align-items-center gap-2">
        <i class="fa-solid fa-user-check"></i>
        <strong>Datos de la Candidata</strong>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="p-3 border rounded-3">
              <div class="d-flex align-items-center mb-2">
                <i class="fa-solid fa-hashtag me-2 text-muted"></i>
                <div>
                  <div class="small text-muted">C√≥digo</div>
                  <div class="fw-semibold">{{ candidata.codigo or 'Se generar√° al guardar' }}</div>
                </div>
              </div>
              <div class="d-flex align-items-center mb-2">
                <i class="fa-solid fa-user me-2 text-muted"></i>
                <div>
                  <div class="small text-muted">Nombre</div>
                  <div class="fw-semibold">{{ candidata.nombre_completo }}</div>
                </div>
              </div>
              <div class="d-flex align-items-center mb-2">
                <i class="fa-regular fa-id-card me-2 text-muted"></i>
                <div>
                  <div class="small text-muted">C√©dula</div>
                  <div class="fw-semibold">{{ candidata.cedula }}</div>
                </div>
              </div>
              <div class="d-flex align-items-center">
                <i class="fa-solid fa-phone me-2 text-muted"></i>
                <div>
                  <div class="small text-muted">Tel√©fono</div>
                  <div class="fw-semibold">{{ candidata.numero_telefono or '‚Äî' }}</div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6 d-grid gap-2">
            <button class="btn btn-outline-secondary" id="btnCopiarResumen" type="button">
              <i class="fa-regular fa-copy me-1"></i>Copiar datos para WhatsApp
            </button>
            <small class="text-muted">
              Copia un resumen con el c√≥digo, nombre, tel√©fono y campos de inscripci√≥n, listo para pegar en WhatsApp.
            </small>
          </div>
        </div>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header d-flex align-items-center gap-2">
        <i class="fa-solid fa-file-circle-check"></i>
        <strong>Formulario de Inscripci√≥n</strong>
      </div>
      <div class="card-body">
        <form method="post" action="{{ url_for('inscripcion') }}" id="formInscripcion" novalidate>
          <!-- CSRF Token -->
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="guardar_inscripcion" value="1" />
          <input type="hidden" name="candidata_id" value="{{ candidata.fila }}" />

          <div class="row g-3">
            <div class="col-md-4">
              <label for="medio" class="form-label">Medio de Inscripci√≥n</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fa-solid fa-building-columns"></i></span>
                <select id="medio" name="medio" class="form-select">
                  <option value="V√≠a Oficina" {{ 'selected' if candidata.medio_inscripcion=='V√≠a Oficina' else '' }}>V√≠a Oficina</option>
                  <option value="Transferencia Bancaria" {{ 'selected' if candidata.medio_inscripcion=='Transferencia Bancaria' else '' }}>Transferencia Bancaria</option>
                </select>
              </div>
              <div class="form-text">C√≥mo realiz√≥ el pago de inscripci√≥n.</div>
            </div>

            <div class="col-md-4">
              <label for="estado" class="form-label">Estado</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fa-solid fa-toggle-on"></i></span>
                <select id="estado" name="estado" class="form-select">
                  <option value="si" {{ 'selected' if candidata.inscripcion else '' }}>S√≠</option>
                  <option value="no" {{ 'selected' if not candidata.inscripcion else '' }}>No</option>
                </select>
              </div>
              <div class="form-text">Marca <strong>S√≠</strong> si ya est√° inscrita.</div>
            </div>

            <div class="col-md-4">
              <label for="monto" class="form-label">Monto (RD$)</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fa-solid fa-dollar-sign"></i></span>
                <input
                  type="text"
                  id="monto"
                  name="monto"
                  class="form-control"
                  inputmode="decimal"
                  placeholder="0.00"
                  value="{{ candidata.monto or '' }}">
              </div>
              <div class="form-text">Solo n√∫meros. Acepta coma o punto.</div>
            </div>

            <div class="col-md-4">
              <label for="fecha" class="form-label">Fecha</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fa-regular fa-calendar-days"></i></span>
                <input
                  type="date"
                  id="fecha"
                  name="fecha"
                  class="form-control"
                  value="{{ candidata.fecha.isoformat() if candidata.fecha else '' }}">
                <button class="btn btn-outline-secondary" type="button" id="btnHoy" title="Hoy">
                  <i class="fa-solid fa-calendar-check"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-success" id="btnGuardar">
              <i class="fa-solid fa-floppy-disk me-1"></i>Guardar Inscripci√≥n
            </button>
            <a href="{{ url_for('inscripcion') }}" class="btn btn-outline-secondary">
              <i class="fa-solid fa-rotate-left me-1"></i>Volver a buscar
            </a>
          </div>
        </form>
      </div>
    </div>
  {% endif %}

  <div class="text-center mt-4">
    <a href="{{ url_for('home') }}" class="btn btn-outline-primary">
      <i class="fa-solid fa-house me-1"></i>Inicio
    </a>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    // DataTables para la tabla de resultados
    document.addEventListener('DOMContentLoaded', function(){
      const t = document.getElementById('tabla-inscripcion-resultados');
      if (t && window.$ && $.fn.DataTable){
        $('#tabla-inscripcion-resultados').DataTable({
          pageLength: 10,
          order: [[1,'asc']],
          autoWidth: false,
          language: { url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json' }
        });
      }
    });

    // Bot√≥n "Hoy" para fecha
    (function(){
      const btnHoy = document.getElementById('btnHoy');
      const fecha  = document.getElementById('fecha');
      if(btnHoy && fecha){
        btnHoy.addEventListener('click', () => {
          const d = new Date();
          const m = String(d.getMonth()+1).padStart(2,'0');
          const day = String(d.getDate()).padStart(2,'0');
          fecha.value = `${d.getFullYear()}-${m}-${day}`;
          fecha.dispatchEvent(new Event('change'));
        });
      }
    })();

    // Normalizaci√≥n del monto (coma -> punto) y anti doble submit
    (function(){
      const form = document.getElementById('formInscripcion');
      if(!form) return;

      const monto = document.getElementById('monto');
      const btn   = document.getElementById('btnGuardar');

      // Limpia caracteres no num√©ricos, permite 1 coma/punto
      const sanitizeMoney = (v) => {
        v = (v || '').replace(/[^\d,.\s]/g,'').trim();
        // Si hay coma y no punto, reemplaza coma por punto
        if (v.includes(',') && !v.includes('.')) v = v.replace(',', '.');
        // Si hay m√∫ltiples puntos, conserva el primero
        const parts = v.split('.');
        if (parts.length > 2) v = parts[0] + '.' + parts.slice(1).join('');
        return v;
      };

      monto && monto.addEventListener('input', () => {
        const caret = monto.selectionStart;
        const before = monto.value;
        const after = sanitizeMoney(before);
        if (before !== after) {
          monto.value = after;
          try { monto.setSelectionRange(caret, caret); } catch(e){}
        }
      });

      form.addEventListener('submit', function(){
        if (monto) monto.value = sanitizeMoney(monto.value);
        if (btn){
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Guardando‚Ä¶';
        }
      });
    })();

    // Copiar resumen para WhatsApp
    (function(){
      const btn = document.getElementById('btnCopiarResumen');
      if(!btn) return;
      btn.addEventListener('click', async () => {
        const code   = "{{ candidata.codigo or '‚Äî' }}";
        const nombre = "{{ candidata.nombre_completo|replace('\n',' ') }}";
        const tel    = "{{ candidata.numero_telefono or '‚Äî' }}";
        const medio  = (document.getElementById('medio')?.value || '').trim();
        const estado = (document.getElementById('estado')?.value === 'si') ? 'Inscrita: S√≠' : 'Inscrita: No';
        const monto  = (document.getElementById('monto')?.value || '').trim();
        const fecha  = (document.getElementById('fecha')?.value || '').trim();

        const msg = [
          'üìù *Inscripci√≥n de Candidata*',
          `‚Ä¢ C√≥digo: ${code}`,
          `‚Ä¢ Nombre: ${nombre}`,
          `‚Ä¢ Tel√©fono: ${tel}`,
          `‚Ä¢ Medio: ${medio || '‚Äî'}`,
          `‚Ä¢ ${estado}`,
          `‚Ä¢ Monto: RD$ ${monto || '0.00'}`,
          `‚Ä¢ Fecha: ${fecha || '‚Äî'}`
        ].join('\n');

        try{
          await navigator.clipboard.writeText(msg);
          btn.classList.remove('btn-outline-secondary');
          btn.classList.add('btn-success');
          btn.innerHTML = '<i class="fa-solid fa-check me-1"></i>¬°Copiado!';
          setTimeout(()=>{
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
            btn.innerHTML = '<i class="fa-regular fa-copy me-1"></i>Copiar datos para WhatsApp';
          }, 1400);
        }catch(e){
          alert('No se pudo copiar. Selecciona y copia manualmente:\n\n' + msg);
        }
      });
    })();
  </script>
{% endblock %}
