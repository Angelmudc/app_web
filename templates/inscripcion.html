<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscripción de Candidatas</title>
</head>
<body>

    <h1>🔍 Inscripción de Candidatas</h1>

    <label for="busqueda">Buscar por cédula o nombre:</label>
    <input type="text" id="busqueda">
    <button id="buscar">🔍 Buscar</button>

    <h2>📄 Datos de la Candidata</h2>
    <p>Código: <span id="codigo">Se generará automáticamente</span></p>
    <p>Nombre: <span id="nombre">No disponible</span></p>
    <p>Cédula: <span id="cedula">No disponible</span></p>
    <p>Teléfono: <span id="telefono">No disponible</span></p>
    <p>Ciudad: <span id="ciudad">No disponible</span></p>

    <h2>📝 Completar Inscripción</h2>
    <input type="hidden" id="fila_index">

    <label for="estado">Estado:</label>
    <select id="estado">
        <option value="Sí">Sí</option>
        <option value="No">No</option>
    </select>

    <label for="monto">Monto:</label>
    <input type="text" id="monto" value="500">

    <label for="fecha">Fecha:</label>
    <input type="date" id="fecha">

    <button id="guardar">💾 Guardar Inscripción</button>

    <script>
        // Función para buscar candidata
        document.getElementById("buscar").addEventListener("click", function() {
            const busqueda = document.getElementById("busqueda").value.trim();

            if (!busqueda) {
                alert("⚠️ Ingresa un nombre o cédula para buscar.");
                return;
            }

            fetch('/buscar_inscripcion?query=' + encodeURIComponent(busqueda))
            .then(response => response.json())
            .then(data => {
                if (data.fila_index) {
                    document.getElementById("fila_index").value = data.fila_index;
                    document.getElementById("codigo").textContent = data.codigo || "Se generará automáticamente";
                    document.getElementById("nombre").textContent = data.nombre || "No disponible";
                    document.getElementById("cedula").textContent = data.cedula || "No disponible";
                    document.getElementById("telefono").textContent = data.telefono || "No disponible";
                    document.getElementById("ciudad").textContent = data.ciudad || "No disponible";
                } else {
                    alert("❌ No se encontró la candidata.");
                }
            })
            .catch(error => console.error("Error en la búsqueda:", error));
        });

        // Función para guardar inscripción
        document.getElementById("guardar").addEventListener("click", function() {
        const filaIndex = document.getElementById("fila_index").value;
        const estado = document.getElementById("estado").value;
        const monto = document.getElementById("monto").value;
        const fecha = document.getElementById("fecha").value;

        fetch("/procesar_inscripcion", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                fila_index: filaIndex,
                estado: estado,
                monto: monto,
                fecha: fecha
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // ✅ Mostrar el código único generado
                document.getElementById("codigo").textContent = data.codigo || "Código no disponible";

                alert("✅ Inscripción guardada correctamente");
                location.reload();
            } else {
                alert('❌ Error al actualizar: ${data.error || "Respuesta inesperada"}');
            }
        })
        .catch(error => {
            console.error("❌ Error en la solicitud:", error);
            alert("❌ Error al guardar la inscripción. Inténtalo de nuevo.");
        });
        });
    </script>

</body>
</html>